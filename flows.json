[{"id":"aca500a5.26ea7","type":"tab","label":"Albert Master","disabled":false,"info":""},{"id":"72706932.2ca048","type":"tab","label":"Albert Worker","disabled":false,"info":""},{"id":"7744a89.2e26458","type":"tab","label":"Facebook Ads/Dynamodb","disabled":true,"info":""},{"id":"1f5b5275.d1abce","type":"tab","label":"Flow 1","disabled":true,"info":""},{"id":"a0f9326d.620a8","type":"tab","label":"Flow 2","disabled":true,"info":""},{"id":"63981055.15fda","type":"tab","label":"Flow 3","disabled":true,"info":""},{"id":"d7b93f55.8b40c","type":"tab","label":"Flow 4","disabled":false,"info":""},{"id":"d94fb931.bab888","type":"subflow","name":"1Betpro.com Session","info":"","in":[{"x":80,"y":100,"wires":[{"id":"15c93f15.719d71"}]}],"out":[{"x":1300,"y":140,"wires":[{"id":"c49073ad.50203","port":0},{"id":"87e56684.c18a38","port":0}]},{"x":1120,"y":40,"wires":[{"id":"a7be1e21.862a5","port":0}]}]},{"id":"6ca7ba6a.fb6f14","type":"subflow","name":"Bot Starter","info":"","in":[{"x":40,"y":140,"wires":[{"id":"776d9b53.b4dba4"}]}],"out":[{"x":900,"y":140,"wires":[{"id":"d7e13ed0.a2355","port":0}]}]},{"id":"faf2e075.8588c","type":"subflow","name":"966sport Request","info":"","in":[{"x":320,"y":220,"wires":[{"id":"a2128ad1.29f588"}]}],"out":[{"x":1020,"y":220,"wires":[{"id":"b2469cd2.9f36e","port":0}]}]},{"id":"bda9989.3a98068","type":"subflow","name":"For Each Page","info":"","in":[{"x":240,"y":160,"wires":[{"id":"1528693d.0811d7"}]}],"out":[{"x":1180,"y":160,"wires":[{"id":"a65dba6.f920e48","port":0}]}]},{"id":"29cf43c4.26adec","type":"subflow","name":"Elasticsearch Merge","info":"","in":[{"x":20,"y":280,"wires":[{"id":"aae7b2d0.d6d16"}]}],"out":[{"x":1320,"y":240,"wires":[{"id":"d0f85fd9.2da0d","port":0}]},{"x":1320,"y":320,"wires":[{"id":"fa556f64.980fd","port":0}]},{"x":1320,"y":160,"wires":[{"id":"78dcc27.5dc073c","port":0}]}]},{"id":"52f2656a.61247c","type":"subflow","name":"1Betpro.com Line Transform","info":"","in":[{"x":20,"y":320,"wires":[{"id":"52fb9c9e.bb5134"}]}],"out":[{"x":720,"y":300,"wires":[{"id":"58691bd5.d808c4","port":0},{"id":"b74c1b39.db8448","port":0}]}]},{"id":"fd5c9c45.e7c55","type":"subflow","name":"List 1BetPro Events","info":"","in":[{"x":60,"y":200,"wires":[{"id":"5f9d13c3.c32d0c"}]}],"out":[{"x":1540,"y":200,"wires":[{"id":"84f6d07e.16321","port":0}]}]},{"id":"8d7750f6.a91db","type":"subflow","name":"List Lines","info":"","in":[{"x":380,"y":240,"wires":[{"id":"8271efd5.73b9"}]}],"out":[{"x":980,"y":240,"wires":[{"id":"de22efe5.6e2f4","port":0}]}]},{"id":"520d204a.6248b","type":"subflow","name":"For Each Game","info":"","in":[{"x":500,"y":220,"wires":[{"id":"e842ceac.82bd7"}]}],"out":[{"x":1180,"y":220,"wires":[{"id":"fb3d627c.b4bff","port":0}]}]},{"id":"b7eb2a5f.2481a8","type":"subflow","name":"966Sport.com Session","info":"","in":[{"x":100,"y":240,"wires":[{"id":"64b40aef.230484"}]}],"out":[{"x":1320,"y":280,"wires":[{"id":"a56d9438.4aa278","port":0},{"id":"f6c6cfcb.de8af","port":0}]},{"x":1120,"y":160,"wires":[{"id":"62fe0d24.d84414","port":"0"}]}]},{"id":"dd2ff415.75e098","type":"subflow","name":"966Sport Line Transform","info":"","in":[{"x":40,"y":240,"wires":[{"id":"c179fda6.be0c2"}]}],"out":[{"x":660,"y":240,"wires":[{"id":"8c3672cd.acb0b","port":0},{"id":"6c5a93dd.a078bc","port":0}]}]},{"id":"987d9c15.b3c5","type":"subflow","name":"Google Search","info":"","in":[{"x":20,"y":560,"wires":[{"id":"33383dcd.33b232"}]}],"out":[{"x":3680,"y":540,"wires":[{"id":"a7685b5e.6e2168","port":0}]}]},{"id":"4831be77.6607b","type":"subflow","name":"1BetPro Request","info":"","in":[{"x":380,"y":220,"wires":[{"id":"90a915b4.cfd408"}]}],"out":[{"x":940,"y":220,"wires":[{"id":"a6eb88c4.19c058","port":0}]}]},{"id":"e1fcddda.49088","type":"subflow","name":"For Each 1BetPro Event","info":"","in":[{"x":200,"y":440,"wires":[{"id":"bf3db1de.5b3f8"}]}],"out":[{"x":1100,"y":440,"wires":[{"id":"16740cbc.486703","port":0}]}]},{"id":"381da27a.bf1b8e","type":"subflow","name":"Session Expired","info":"","in":[{"x":200,"y":220,"wires":[{"id":"f73f710.d3a749"}]}],"out":[{"x":1160,"y":220,"wires":[{"id":"20fb1a9c.949976","port":0}]}]},{"id":"920d75bc.d0fe08","type":"subflow","name":"Pinibet","info":"","in":[{"x":20,"y":280,"wires":[{"id":"e3369fff.039ef"}]}],"out":[{"x":4960,"y":340,"wires":[{"id":"357574e0.a4e85c","port":0},{"id":"c461f01e.72102","port":0}]}]},{"id":"87f0e773.22b928","type":"subflow","name":"Persistence Helper","info":"","in":[{"x":45.5,"y":85,"wires":[{"id":"a2757617.757038"}]}],"out":[{"x":749.5,"y":53,"wires":[{"id":"ab2caa7c.d750f8","port":0}]},{"x":755,"y":169,"wires":[{"id":"9a388e3d.aeb97","port":0}]}]},{"id":"d2bdb924.a3fc88","type":"subflow","name":"old ebay api","info":"","in":[{"x":54,"y":111,"wires":[{"id":"9b6c3b8c.b15c88"}]}],"out":[{"x":646,"y":232,"wires":[{"id":"c31e115c.15a15","port":0}]}]},{"id":"49f6e78f.a91848","type":"subflow","name":"eBay API","info":"","in":[{"x":45.714284896850586,"y":122.85714340209961,"wires":[{"id":"456e4dfd.276fc4"}]}],"out":[{"x":628.5713214874268,"y":127.14285659790039,"wires":[{"id":"d52c5564.705d78","port":0}]}]},{"id":"e6cabfa4.fd5d9","type":"subflow","name":"1BetPro","info":"","in":[{"x":60,"y":360,"wires":[{"id":"a3ffdf4e.7085b"}]}],"out":[{"x":2180,"y":340,"wires":[{"id":"6d260328.cbc28c","port":0}]}]},{"id":"4bfab75c.41da68","type":"subflow","name":"966Sport","info":"","in":[{"x":40,"y":280,"wires":[{"id":"6d1a6a43.1f9b94"}]}],"out":[{"x":3460,"y":320,"wires":[{"id":"9c9a0fcc.b18c7","port":0},{"id":"77d9db32.ac2ae4","port":0}]}]},{"id":"e86e33b6.b81da","type":"subflow","name":"Elasticsearch","info":"","in":[{"x":340,"y":120,"wires":[{"id":"9e7487af.61a6c8"}]}],"out":[]},{"id":"8f12258d.a834d8","type":"subflow","name":"Facebook Ads","info":"","in":[{"x":154.24999237060547,"y":180.25000095367432,"wires":[{"id":"298b6c9c.fce634"}]}],"out":[{"x":3698.9999809265137,"y":178,"wires":[{"id":"826030c9.4d64f","port":0}]},{"x":3515.00004196167,"y":314.00000190734863,"wires":[{"id":"bd26c61.d037738","port":0}]},{"x":1799.0007133483887,"y":247.00002098083496,"wires":[{"id":"90bec8a7.3f5b48","port":0}]}]},{"id":"363f279c.1671a8","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"","verifyservercert":false},{"id":"43749542.37d54c","type":"remote-server","z":"","name":"elastic","host":"http://elasticsearch-elasticsearch.default.svc.cluster.local:9200"},{"id":"c0e67585.074708","type":"kafka-broker","z":"","broker":"kafka.default.svc.cluster.local:9092","clientid":"node-red-6"},{"id":"17bb932a.0660ad","type":"redis-config","z":"dd2ff415.75e098","host":"redis-redis-ha.default.svc.cluster.local","port":"6379","dbase":"0","pass":""},{"id":"3535b384.5d390c","type":"redis-config","z":"","host":"redis-master.default.svc.cluster.local","port":"6379","dbase":"0","pass":"hLZ8J8sKM1"},{"id":"13d30f7a.59c2a1","type":"postgresdb","z":"7744a89.2e26458","hostname":"sippycup.c8wilxdbvlmp.us-east-1.rds.amazonaws.com","port":"5432","db":"sippycup","ssl":false},{"id":"d93577ef.f77438","type":"postgresdb","z":0,"hostname":"sippycup-postgresql.default.svc.cluster.local","port":"5432","db":"sippycup","ssl":false},{"id":"3ffd8cd4.9264b4","type":"postgresdb","z":0,"hostname":"sippycup.c8wilxdbvlmp.us-east-1.rds.amazonaws.com","port":"5432","db":"sippycup","ssl":true},{"id":"3c5b23c9.6f8d1c","type":"function","z":"faf2e075.8588c","name":"Go To Page and Listen","func":"'use strict';\n\nvar DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n    \nfunction sleep(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n            \n    const browser = await puppeteer.launch({args: ['--no-sandbox', '--disable-setuid-sandbox', '--shm-size=1gb', '--disable-dev-shm-usage']});\n    let page = await browser.newPage();\n\n    try{\n  \n        log('Setting Session Cookies');\n        await page.setCookie(...msg.session.cookies);\n        \n        await page.on('response', response => {\n             if (response.url().includes(msg.page.listenTo[0]) && response.status()===200){\n                \n                //msg.headers = response.request().headers();\n                //msg.postData = response.request().postData();\n                \n                response.json().then(function (json) {\n                    \n                    msg.topic = 'RESPONSE_FROM_' + response.url();\n                    msg.payload = json;\n                    \n                    node.send(msg);\n        \n                    log(msg.page.website.name + ' -- Sending a ' + msg.topic + ' message');\n                    \n                    log(msg.page.website.name + ' -- Finish Closing browser...');\n        \n                    browser.close();\n        \n                    log(msg.page.website.name + ' -- Goodbye!!');\n                })\n                \n            }\n        });\n\n        log('Go to page ' + msg.page.url);\n        await page.goto(msg.page.url);\n\n        log(msg.page.website.name + ' -- Wait For Selector ' + msg.page.waitForSelector + ' ...')\n        await page.waitForSelector(msg.page.waitForSelector,{timeout : 10000});\n        //await page.waitForNavigation({waitUntil: 'load'});\n        \n        const url = await page.evaluate(() => location.href);\n        \n        await msg.session.history.push({\n            url: url,\n            timestamp: Date.now()\n        });\n        \n        log(msg.page.website.name + ' -- Waiting ' + (msg.page.waitFor/1000) + ' seconds for responses before closing browser');\n        await sleep(msg.page.waitFor);\n        \n        log(msg.page.website.name + ' -- Timeout Closing browser...');\n        \n        await page.close();\n        await browser.close();\n        \n        log(msg.page.website.name + ' -- Goodbye!!');\n    }\n    catch(e){\n        node.error(e);\n        \n        log(msg.page.website.name + ' -- Closing browser...');\n        \n        await browser.close();\n        \n        log(msg.page.website.name + ' -- Goodbye!!');\n        \n        await page.close();\n        await browser.close();\n        \n        //return msg;\n    }\n})();","outputs":1,"noerr":0,"x":860,"y":320,"wires":[["ca4ed912.eec118"]]},{"id":"f33e6a44.9207c8","type":"function","z":"d94fb931.bab888","name":"Login","func":"'use strict';\n\nvar DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n    \nfunction sleep(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n    \nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    \n    const browser = await puppeteer.launch({args: ['--no-sandbox', '--disable-setuid-sandbox', '--shm-size=1gb', '--disable-dev-shm-usage']}); //});//{headless: false\n    let page = await browser.newPage();\n  \n    try{\n        \n        log(msg.website.name + ' -- Go to 1BetPro Website');\n        await page.goto('https://1betpro.com/');\n\n        log(msg.website.name + ' -- Type the login information :' + JSON.stringify(msg.website));\n        await page.type('#form > div:nth-child(2) > input', msg.website.username);\n        await page.type('#form > div:nth-child(3) > input', msg.website.password);\n\n        await page.waitForSelector('#form > input',{timeout : 5000});\n\n        log(msg.website.name + ' -- Login')\n        await page.click('#form > input');\n        \n        log(msg.website.name + ' -- Wait till change format manu visible')\n        await page.waitForSelector('a.oddsChanges.borderBox.withoutTopBorder',{timeout : 10000});\n        \n        log(msg.website.name + ' -- Logged In, saving cookies')\n        //msg.website.cookies = await page.cookies()\n        \n        await page.evaluate(() => {\n            getjson({odds:\"e\"},function(data){document.location.reload();});\n        });\n\n        await page.waitForNavigation();\n        \n        const cookies = await page.cookies()\n        \n        const url = await page.evaluate(() => location.href);\n     \n        msg.website.session ={\n            cookies: cookies,\n            history: []\n        }\n        \n        await msg.website.session.history.push({\n            url: url,\n            timestamp: Date.now()\n        });\n        \n        msg.payload =[msg.website.name + \"_session\",JSON.stringify(msg.website.session)]\n\n        msg.topic = '1BETPRO_LOGIN_SUCCESS';\n        \n        node.send(msg);\n        \n        log(msg.website.name + ' -- Sending a ' + msg.topic + ' message');\n        await page.close();\n        await browser.close();\n    }\n    catch(e){\n        \n        node.error(e);\n        \n        msg.topic = '1BETPRO_LOGIN_FAILED';\n        \n        node.send(msg);\n        \n        log(msg.website.name + ' -- Sending a ' + msg.topic + ' message');\n        \n        await page.close();\n        await browser.close();\n    }\n})();","outputs":1,"noerr":0,"x":830,"y":80,"wires":[["a7be1e21.862a5"]]},{"id":"1528693d.0811d7","type":"change","z":"bda9989.3a98068","name":"Set Pages","rules":[{"t":"set","p":"payload","pt":"msg","to":"website.pages","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":160,"wires":[["3e8df435.17460c"]]},{"id":"3e8df435.17460c","type":"split","z":"bda9989.3a98068","name":"For Each Page","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":560,"y":160,"wires":[["e10998cc.96ab38"]]},{"id":"eba2bf23.6eece","type":"change","z":"8d7750f6.a91db","name":"Set Line","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.line","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":660,"y":240,"wires":[["de22efe5.6e2f4"]]},{"id":"8271efd5.73b9","type":"switch","z":"8d7750f6.a91db","name":"Got Line","property":"payload.line","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":520,"y":240,"wires":[["eba2bf23.6eece"]]},{"id":"de22efe5.6e2f4","type":"split","z":"8d7750f6.a91db","name":"For Each Line","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":820,"y":240,"wires":[[]]},{"id":"5c4c5c17.9aa634","type":"html","z":"fd5c9c45.e7c55","name":"Games","property":"payload.html","tag":".addbetslip","ret":"attr","as":"single","x":660,"y":200,"wires":[["d51a1b5b.e97b98"]]},{"id":"37567a71.92f186","type":"change","z":"fd5c9c45.e7c55","name":"Set Game ID","rules":[{"t":"set","p":"payload","pt":"msg","to":"$split(msg.payload.html[0].id, \"_\", 1)[0]","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":200,"wires":[["a2a014fd.7e5dc8"]]},{"id":"7fc302c0.bf813c","type":"join","z":"fd5c9c45.e7c55","name":"","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":1310,"y":200,"wires":[["84f6d07e.16321"]]},{"id":"d51a1b5b.e97b98","type":"switch","z":"fd5c9c45.e7c55","name":"","property":"payload.html[0]","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":790,"y":200,"wires":[["37567a71.92f186"]]},{"id":"e842ceac.82bd7","type":"split","z":"520d204a.6248b","name":"For Each Game","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":660,"y":220,"wires":[["a3477e2e.5793b"]]},{"id":"a3477e2e.5793b","type":"delay","z":"520d204a.6248b","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"30","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":840,"y":220,"wires":[["fb3d627c.b4bff"]]},{"id":"9edd3745.df21f8","type":"change","z":"52f2656a.61247c","name":"Set Game Data","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.origin","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":180,"y":440,"wires":[["2ee2b01d.82be"]]},{"id":"2ee2b01d.82be","type":"split","z":"52f2656a.61247c","name":"For Each Game","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":360,"y":440,"wires":[["d154070c.4ac2f8"]]},{"id":"d154070c.4ac2f8","type":"switch","z":"52f2656a.61247c","name":"","property":"payload.types","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":510,"y":440,"wires":[["94fbb25e.c4de7"]]},{"id":"94fbb25e.c4de7","type":"change","z":"52f2656a.61247c","name":"Set Types","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.types","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":640,"y":440,"wires":[["835b0a86.fee6a8"]]},{"id":"835b0a86.fee6a8","type":"split","z":"52f2656a.61247c","name":"For Each Type","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":800,"y":440,"wires":[["227433d4.fe887c"]]},{"id":"227433d4.fe887c","type":"change","z":"52f2656a.61247c","name":"Set Games","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.games","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":970,"y":440,"wires":[[]]},{"id":"748372d2.415cec","type":"function","z":"52f2656a.61247c","name":"","func":"var DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nDate.prototype.getRoundHours = function() {\n  var mm = this.getMonth() + 1; // getMonth() is zero-based\n  var dd = this.getDate();\n  \n  return [this.getFullYear()     + '-',\n          (mm>9 ? '' : '0') + mm + '-',\n          (dd>9 ? '' : '0') + dd ,\n         ].join('');\n};\n\nlet odds = [];\n\ntry{\n    \n    let event_date = new Date();\n    let event_rounded_date = event_date.getRoundHours();\n\n    let event_hour = msg.data.date.replace('<span class=\"tablo_time\">','').replace('</span>','');\n    \n    event_date = new Date(event_rounded_date.toString() + ' ' + event_hour + \":00\");\n    \nlet event = {\n    \"name\" : (msg.data.teams[0] + ' vs ' + msg.data.teams[1]).toLowerCase(),\n    \"official\": (msg.google.result.length>0) ? msg.google.result[0].toLowerCase() : (msg.data.teams[0] + ' vs ' + msg.data.teams[1]).toLowerCase(),\n    \"participants\" : msg.data.teams.map(team => {return team.toLowerCase()}),\n    \"date\" : event_date.getTime(),\n    \"score\" : (msg.data.hasOwnProperty(\"add_inf\")) ? ((msg.data.add_inf.hasOwnProperty(\"sc1\")) ? msg.data.add_inf.sc1 : 0) + ' - ' + ((msg.data.add_inf.hasOwnProperty(\"sc2\")) ? msg.data.add_inf.sc2 : 0) : '0 - 0',\n    \"league.name\" : msg.data.league.toLowerCase(),\n    \"sport.name\" : msg.data.sport.toLowerCase(),\n    \"minute\": (msg.data.hasOwnProperty(\"add_inf\")) ? parseInt(msg.data.add_inf.minute.replace(\"'\")) : 0\n}\n\nlet orig_odds = msg.data.sg[\"1\"];\n\nif(orig_odds.hasOwnProperty(\"ft\")){\n    \n    if(orig_odds.ft.hasOwnProperty(\"1x2\")){\n            \n        odds.push({\n            \"event\" : event,\n            \"odd\": {\n                \"1betpro.id\" : orig_odds.ft[\"1x2\"][0][0].replace(\"__\",\"\"),\n                \"type\" : \"1x2\",\n                \"expires_on\" : \"Full Time\",\n                \"1betpro.money_line\"  : parseFloat(orig_odds.ft[\"1x2\"][0][1]),\n                \"run_line\" : 1,\n                \"opponent\": 1\n            }\n        });\n    \n        odds.push({\n            \"event\" : event,\n            \"odd\": {\n                \n                \"1betpro.id\" : orig_odds.ft[\"1x2\"][1][0].replace(\"__\",\"\"),\n                \"type\" : \"1x2\",\n                \"expires_on\" : \"Full Time\",\n                \"1betpro.money_line\"  : parseFloat(orig_odds.ft[\"1x2\"][1][1]),\n                \"run_line\" : 1,\n                \"opponent\": 2\n            }\n        });\n        \n        odds.push({\n            \"event\" : event,\n            \"odd\": {\n                \n                \"1betpro.id\" : orig_odds.ft[\"1x2\"][2][0].replace(\"__\",\"\"),\n                \"type\" : \"1x2\",\n                \"expires_on\" : \"Full Time\",\n                \"1betpro.money_line\"  : parseFloat(orig_odds.ft[\"1x2\"][2][1]),\n                \"run_line\" : 1,\n                \"opponent\": 0\n            }\n        });\n    }\n    \n    if(orig_odds.ft.hasOwnProperty(\"ou\")){\n        orig_odds.ft.ou.forEach(odd => {\n            odds.push({\n                \"event\" : event,\n                \"odd\": {\n                    \n                    \"1betpro.id\" : odd[0][0].replace(\"__\",\"\"),\n                    \"type\" : \"Over\",\n                    \"expires_on\" : \"Full Time\",\n                    \"1betpro.money_line\"  : parseFloat(odd[0][1]),\n                    \"run_line\"  : parseFloat((odd[0][2]==\"pk\") ? 0 : odd[0][2]),\n                    \"opponent\": 1\n                }\n            });\n        \n            odds.push({\n                \"event\" : event,\n                \"odd\": {\n                    \n                    \"1betpro.id\" : odd[1][0].replace(\"__\",\"\"),\n                    \"type\" : \"Under\",\n                    \"expires_on\" : \"Full Time\",\n                    \"1betpro.money_line\"  : parseFloat(odd[1][1]),\n                    \"run_line\"  : parseFloat((odd[1][2]==\"pk\") ? 0 : odd[1][2]),\n                    \"opponent\": 2\n                }\n            });\n        })\n        \n    }\n    \n    if(orig_odds.ft.hasOwnProperty(\"ah\")){\n        orig_odds.ft.ah.forEach(odd => {\n            odds.push({\n                \"event\" : event,\n                \"odd\": {\n                    \n                    \"1betpro.id\" : odd[0][0].replace(\"__\",\"\"),\n                    \"type\" : \"Handicap\",\n                    \"expires_on\" : \"Full Time\",\n                    \"1betpro.money_line\"  : parseFloat(odd[0][1]),\n                    \"run_line\"  : parseFloat((odd[0][2]==\"pk\") ? 0 : odd[0][2]),\n                    \"opponent\": 1\n                }\n            });\n        \n            odds.push({\n                \"event\" : event,\n                \"odd\": {\n                    \n                    \"1betpro.id\" : odd[1][0].replace(\"__\",\"\"),\n                    \"type\" : \"Handicap\",\n                    \"expires_on\" : \"Full Time\",\n                    \"1betpro.money_line\"  : parseFloat(odd[1][1]),\n                    \"run_line\"  : parseFloat((odd[1][2]==\"pk\") ? 0 : odd[1][2]),\n                    \"opponent\": 2\n                }\n            });\n        })\n        \n    }\n}\n\nif(orig_odds.hasOwnProperty(\"ht\")){\n    \n    if(orig_odds.ht.hasOwnProperty(\"1x2\")){\n        odds.push({\n            \"event\" : event,\n            \"odd\": {\n                \n                \"1betpro.id\" : orig_odds.ht[\"1x2\"][0][0].replace(\"__\",\"\"),\n                \"type\" : \"1x2\",\n                \"expires_on\" : \"1st Half\",\n                \"1betpro.money_line\"  : parseFloat(orig_odds.ht[\"1x2\"][0][1]),\n                \"run_line\" : 1,\n                \"opponent\": 1\n            }\n        });\n    \n        odds.push({\n            \"event\" : event,\n            \"odd\": {\n                \n                \"1betpro.id\" : orig_odds.ht[\"1x2\"][1][0].replace(\"__\",\"\"),\n                \"type\" : \"1x2\",\n                \"expires_on\" : \"1st Half\",\n                \"1betpro.money_line\"  : parseFloat(orig_odds.ht[\"1x2\"][1][1]),\n                \"run_line\" : 1,\n                \"opponent\": 2\n            }\n        });\n        \n        odds.push({\n            \"event\" : event,\n            \"odd\": {\n                \n                \"1betpro.id\" : orig_odds.ht[\"1x2\"][2][0].replace(\"__\",\"\"),\n                \"type\" : \"1x2\",\n                \"expires_on\" : \"1st Half\",\n                \"1betpro.money_line\"  : parseFloat(orig_odds.ht[\"1x2\"][2][1]),\n                \"run_line\" : 1,\n                \"opponent\": 0\n            }\n        });\n    }\n    \n    if(orig_odds.ht.hasOwnProperty(\"ou\")){\n        orig_odds.ht.ou.forEach(odd => {\n            odds.push({\n                \"event\" : event,\n                \"odd\": {\n                    \n                    \"1betpro.id\" : odd[0][0].replace(\"__\",\"\"),\n                    \"type\" : \"Over\",\n                    \"expires_on\" : \"1st Half\",\n                    \"1betpro.money_line\"  : parseFloat(odd[0][1]),\n                    \"run_line\"  : parseFloat((odd[0][2]==\"pk\") ? 0 : odd[0][2]),\n                    \"opponent\": 1\n                }\n            });\n        \n            odds.push({\n                \"event\" : event,\n                \"odd\": {\n                    \n                    \"1betpro.id\" : odd[1][0].replace(\"__\",\"\"),\n                    \"type\" : \"Under\",\n                    \"expires_on\" : \"1st Half\",\n                    \"1betpro.money_line\"  : parseFloat(odd[1][1]),\n                    \"run_line\"  : parseFloat((odd[1][2]==\"pk\") ? 0 : odd[1][2]),\n                    \"opponent\": 2\n                }\n            });\n        })\n        \n    }\n    \n    if(orig_odds.ht.hasOwnProperty(\"ah\")){\n        orig_odds.ht.ah.forEach(odd => {\n            odds.push({\n                \"event\" : event,\n                \"odd\": {\n                    \n                    \"1betpro.id\" : odd[0][0].replace(\"__\",\"\"),\n                    \"type\" : \"Handicap\",\n                    \"expires_on\" : \"1st Half\",\n                    \"1betpro.money_line\"  : parseFloat(odd[0][1]),\n                    \"run_line\"  : parseFloat((odd[0][2]==\"pk\") ? 0 : odd[0][2]),\n                    \"opponent\": 1\n                }\n            });\n        \n            odds.push({\n                \"event\" : event,\n                \"odd\": {\n                    \n                    \"1betpro.id\" : odd[1][0].replace(\"__\",\"\"),\n                    \"type\" : \"Handicap\",\n                    \"expires_on\" : \"1st Half\",\n                    \"1betpro.money_line\"  : parseFloat(odd[1][1]),\n                    \"run_line\"  : parseFloat((odd[1][2]==\"pk\") ? 0 : odd[1][2]),\n                    \"opponent\": 2\n                }\n            });\n        })\n        \n    }\n}\n\n//log(msg.page.website.name + ' -- Finish Transformation, got ' + odds.length + ' rows');\n\n/*odds = odds.map(odd => {\n    Object.keys(odd).map(function(key, index) {\n       odd[key] = (odd[key]===null || odd[key]===undefined) ? \"-1\" : odd[key];\n    });\n})*/\n}\ncatch(e){\n    //node.error(e);\n    msg.error = e;\n}\n\nmsg.payload = odds;\n\nreturn msg;","outputs":1,"noerr":0,"x":50,"y":500,"wires":[[]]},{"id":"9f5860af.d57d4","type":"split","z":"52f2656a.61247c","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":270,"y":320,"wires":[["b74c1b39.db8448","58691bd5.d808c4"]]},{"id":"7cbb4217.a0db0c","type":"switch","z":"29cf43c4.26adec","name":"Yes/No","property":"exists","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":680,"y":340,"wires":[["7403b2ec.c6c45c"],["ac24189d.f354c8"]]},{"id":"776d9b53.b4dba4","type":"change","z":"6ca7ba6a.fb6f14","name":"Set Websites","rules":[{"t":"set","p":"payload","pt":"msg","to":"data.websites","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":190,"y":140,"wires":[["8ddae01b.66ca2"]]},{"id":"8ddae01b.66ca2","type":"split","z":"6ca7ba6a.fb6f14","name":"For Each Website","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":370,"y":140,"wires":[["f312958f.97f068"]]},{"id":"f312958f.97f068","type":"change","z":"6ca7ba6a.fb6f14","name":"Set Website","rules":[{"t":"set","p":"website","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":140,"wires":[["d7e13ed0.a2355"]]},{"id":"d7e13ed0.a2355","type":"switch","z":"6ca7ba6a.fb6f14","name":"Route by website","property":"website.name","propertyType":"msg","rules":[{"t":"eq","v":"1betpro.com","vt":"str"},{"t":"eq","v":"966sport.com--disabled","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":140,"wires":[[],[]]},{"id":"fb3d627c.b4bff","type":"change","z":"520d204a.6248b","name":"Set Game Page","rules":[{"t":"set","p":"page","pt":"msg","to":"{\t    \"url\": msg.website.url & msg.payload & '/game/',\t    \"waitFor\": msg.website.waitFor,\t    \"waitForSelector\": msg.payload.waitForSelector,\t    \"listenTo\": msg.website.listenTo,\t    \"website\":{\"name\": msg.website.name}\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1020,"y":220,"wires":[[]]},{"id":"a65dba6.f920e48","type":"change","z":"bda9989.3a98068","name":"Set Page URL","rules":[{"t":"set","p":"page","pt":"msg","to":"{\t    \"url\": msg.website.url & msg.payload.url,\t    \"waitFor\": msg.payload.waitFor,\t    \"waitForSelector\": msg.payload.waitForSelector,\t    \"listenTo\": msg.payload.listenTo,\t    \"website\":{\"name\": msg.website.name}\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":160,"wires":[[]]},{"id":"476c9431.c9e18c","type":"template","z":"29cf43c4.26adec","name":"Query","field":"query","fieldType":"msg","format":"json","syntax":"mustache","template":"{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        { \"match\": { \"event.date\":  {\"query\": \"{{payload.event.date}}\"} }},\n        { \"match\": { \"odd.type\": {\"query\": \"{{payload.odd.type}}\"}}},\n        { \"match\": { \"odd.expires_on\": {\"query\": \"{{payload.odd.expires_on}}\"}}},\n        { \"match\": { \"odd.opponent\": {\"query\": \"{{payload.odd.opponent}}\"}}}\n      ]\n    }\n  }\n}","output":"str","x":910,"y":160,"wires":[["78dcc27.5dc073c"]]},{"id":"78dcc27.5dc073c","type":"es-search","z":"29cf43c4.26adec","name":"","documentIndex":"","documentType":"","query":"","sort":"","includeFields":"","maxResults":10,"server":"43749542.37d54c","x":1130,"y":160,"wires":[[]]},{"id":"3bab49a3.43e396","type":"es-exists","z":"29cf43c4.26adec","name":"","documentId":"","documentIndex":"","documentType":"","server":"43749542.37d54c","x":490,"y":340,"wires":[["7cbb4217.a0db0c"]]},{"id":"7403b2ec.c6c45c","type":"es-create","z":"29cf43c4.26adec","name":"","documentIndex":"","documentType":"","server":"43749542.37d54c","x":930,"y":240,"wires":[["d0f85fd9.2da0d"]]},{"id":"ac24189d.f354c8","type":"es-update","z":"29cf43c4.26adec","name":"","documentId":"","documentIndex":"","documentType":"","server":"43749542.37d54c","x":930,"y":320,"wires":[["fa556f64.980fd"]]},{"id":"aae7b2d0.d6d16","type":"function","z":"29cf43c4.26adec","name":"Debug","func":"var DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nlog('Checking if document ' + msg.documentId + ' already exists');\nlog('document : ' + JSON.stringify(msg.payload));\n\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":280,"wires":[["7403b2ec.c6c45c"]]},{"id":"fa556f64.980fd","type":"function","z":"29cf43c4.26adec","name":"Debug","func":"var DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nlog('Updating document ' + msg.documentId);\n//log('msg = ' + JSON.stringify(msg));\n\nreturn msg;","outputs":1,"noerr":0,"x":1130,"y":320,"wires":[[]]},{"id":"d0f85fd9.2da0d","type":"function","z":"29cf43c4.26adec","name":"Debug","func":"var DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nlog('Creating document ' + msg.documentId);\n//log('msg = ' + JSON.stringify(msg));\nreturn msg;","outputs":1,"noerr":0,"x":1130,"y":240,"wires":[[]]},{"id":"463f84ea.2a9dbc","type":"delay","z":"29cf43c4.26adec","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"5","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":470,"y":400,"wires":[[]]},{"id":"a2a014fd.7e5dc8","type":"function","z":"fd5c9c45.e7c55","name":"Set Message Complete","func":"if(msg.parts.index === msg.parts.count-1) msg.complete = true;\n\nreturn msg;","outputs":1,"noerr":0,"x":1130,"y":200,"wires":[["7fc302c0.bf813c"]]},{"id":"e10998cc.96ab38","type":"switch","z":"bda9989.3a98068","name":"Is Enabled?","property":"payload.enabled","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":740,"y":160,"wires":[["a65dba6.f920e48"]]},{"id":"84f6d07e.16321","type":"function","z":"fd5c9c45.e7c55","name":"Debug","func":"if(msg.debug){\n    arr = [];\n    arr.push(msg.payload[0]);\n    msg.payload = arr;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":200,"wires":[[]]},{"id":"ded7f12b.b1d18","type":"rdkafka out","z":"aca500a5.26ea7","name":"Kafka","topic":"","key":"","partition":"0","broker":"c0e67585.074708","x":1630,"y":380,"wires":[]},{"id":"f7c26d47.9abfe","type":"inject","z":"aca500a5.26ea7","name":"","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":true,"onceDelay":"3","x":190,"y":380,"wires":[["7da70950.cdd028"]]},{"id":"7da70950.cdd028","type":"change","z":"aca500a5.26ea7","name":"Set Tasks","rules":[{"t":"set","p":"payload","pt":"msg","to":"data.tasks","tot":"flow"},{"t":"set","p":"flow","pt":"msg","to":"data.name","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":380,"wires":[["78e2896d.f22e38","bc2637ed.e51ce8","65f76839.510bd8"]]},{"id":"65f76839.510bd8","type":"split","z":"aca500a5.26ea7","name":"For Each Task","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":580,"y":380,"wires":[["4949ef11.8c9d5"]]},{"id":"cb3489b8.e8d988","type":"change","z":"aca500a5.26ea7","name":"Set topic","rules":[{"t":"set","p":"topic","pt":"msg","to":"$uppercase(msg.flow & '_' & msg.payload.name)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1240,"y":520,"wires":[[]]},{"id":"263e737e.a26f4c","type":"config","z":"aca500a5.26ea7","name":"data","properties":[{"p":"data","pt":"flow","to":"{\"debug\":false,\"name\":\"albert\",\"tasks\":[{\"name\":\"1betpro\",\"enabled\":false,\"url\":\"https://1betpro.com/\",\"username\":\"אבי99\",\"password\":\"1111\"},{\"name\":\"966sport\",\"enabled\":false,\"url\":\"http://966sport.com/\",\"username\":\"X222\",\"password\":\"12345\"},{\"name\":\"pinibet\",\"enabled\":false,\"url\":\"https://ropinwev.pinbet88.com/sports-service/sv/odds/events?l=100&ot=1\",\"username\":\"avigershon\",\"password\":\"lioran020\"},{\"name\":\"facebook\",\"enabled\":true,\"accounts\":[{\"access_token\":\"EAAMU4ZAfHJMYBADRHzQrfsv3mZA3hKGxrZAtR2TT8zmZBZCU8mAmp2Y2tpum1leunpBsvusgcOItb05G4xUKSumBT2A3yNvEvNkKtoroMM8oh4V6CllFP20aNq3VXZBDNfn1TzWZAijitOjI4yvDzZAZBEq6hSPu9Yiyvv4kmxl7z6gZDZD\",\"campaigns\":[{\"effective_status\":\"ACTIVE\",\"id\":\"6090027468460\"},{\"effective_status\":\"ACTIVE\",\"id\":\"6089766492460\"}],\"id\":\"1381220405489176\"}]}]}","tot":"json"}],"active":true,"x":170,"y":200,"wires":[]},{"id":"f721cae3.107988","type":"json","z":"aca500a5.26ea7","name":"","property":"payload","action":"str","pretty":false,"x":1430,"y":380,"wires":[["ded7f12b.b1d18","4e3fd979.567268","a08741b9.d0c0a"]]},{"id":"3183b6e9.8de4ea","type":"change","z":"aca500a5.26ea7","name":"Set Common Params","rules":[{"t":"set","p":"payload.debug","pt":"msg","to":"debug","tot":"flow"},{"t":"set","p":"payload.flow","pt":"msg","to":"flow","tot":"msg"},{"t":"set","p":"payload.delay","pt":"msg","to":"delay","tot":"flow"},{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":980,"y":380,"wires":[["7f46ebe0.6fed64","89599c12.06321","f523bf20.4abe3"]]},{"id":"ad112b19.1a9178","type":"debug","z":"aca500a5.26ea7","name":"","active":false,"tosidebar":true,"console":true,"tostatus":false,"complete":"true","x":1430,"y":440,"wires":[]},{"id":"5a2c3743.742b08","type":"config","z":"aca500a5.26ea7","name":"debug","properties":[{"p":"debug","pt":"flow","to":"true","tot":"bool"}],"active":true,"x":390,"y":200,"wires":[]},{"id":"78e2896d.f22e38","type":"debug","z":"aca500a5.26ea7","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"topic","x":560,"y":320,"wires":[]},{"id":"ed71a195.4fc58","type":"debug","z":"aca500a5.26ea7","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"topic","x":940,"y":320,"wires":[]},{"id":"7f46ebe0.6fed64","type":"debug","z":"aca500a5.26ea7","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"topic","x":1240,"y":320,"wires":[]},{"id":"87cc6828.3edc08","type":"debug","z":"aca500a5.26ea7","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"topic","x":1440,"y":320,"wires":[]},{"id":"4e3fd979.567268","type":"debug","z":"aca500a5.26ea7","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"topic","x":1640,"y":320,"wires":[]},{"id":"bc2637ed.e51ce8","type":"debug","z":"aca500a5.26ea7","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":550,"y":440,"wires":[]},{"id":"4db3314d.976e4","type":"debug","z":"aca500a5.26ea7","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":930,"y":440,"wires":[]},{"id":"89599c12.06321","type":"debug","z":"aca500a5.26ea7","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1230,"y":440,"wires":[]},{"id":"a08741b9.d0c0a","type":"debug","z":"aca500a5.26ea7","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1630,"y":440,"wires":[]},{"id":"8a088a21.50a928","type":"function","z":"b7eb2a5f.2481a8","name":"Login","func":"'use strict';\n\nvar DEBUG=msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n    \nfunction sleep(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n    \nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    \n    const browser = await puppeteer.launch({args: ['--proxy-server=35.184.135.47:8118','--no-sandbox', '--disable-setuid-sandbox', '--shm-size=1gb', '--disable-dev-shm-usage']}); //});//{headless: false\n    const page = await browser.newPage();\n    \n    try{\n        \n        log(msg.website.name + ' -- Go to Website');\n        await page.goto('http://www.966sport.com/login/');\n\n        log(msg.website.name + ' -- Type the login information for website :' + JSON.stringify(msg.website));\n        await page.type('#form > div:nth-child(2) > div > input', msg.website.username);\n        await page.type('#form > div:nth-child(3) > div > input', msg.website.password);\n\n        await page.waitForSelector('#form > div:nth-child(4) > div > button',{timeout : 5000});\n\n        log(msg.website.name + ' -- Login')\n        await page.click('#form > div:nth-child(4) > div > button');\n        \n        log(msg.website.name + ' -- Wait till logged in')\n        await page.waitForSelector('.b-user.open-button.left',{timeout : 10000});\n        \n        log(msg.website.name + ' -- Logged In, saving cookies')\n        const cookies = await page.cookies()\n        const url = await page.evaluate(() => location.href);\n        \n        msg.website.session ={\n            cookies: cookies,\n            history: []\n        }\n        \n        await msg.website.session.history.push({\n            url: url,\n            timestamp: Date.now()\n        });\n        \n        await page.goto('http://www.966sport.com/options.php?lang=1');\n        \n        log(msg.website.name + ' -- Wait till English is set')\n        await page.waitForSelector('span.b-language-flag img[alt=English]',{timeout : 10000});\n        \n        await page.goto('http://www.966sport.com/options.php?odds=1');\n        \n        log(msg.website.name + ' -- Wait till Decimal is set')\n        await page.waitForSelector(\"option[value='options.php?odds=1']:checked\",{timeout : 10000});\n        \n        \n        msg.payload =[msg.website.name + \"_session\",JSON.stringify(msg.website.session)]\n        \n        msg.topic = '966SPORT_LOGIN_SUCCESS';\n        \n        node.send(msg);\n        \n        log(msg.website.name + ' -- Sending a ' + msg.topic + ' message');\n        await page.close()\n        await browser.close();\n    }\n    catch(e){\n        \n        node.error(e);\n        \n        msg.topic = '966SPORT_LOGIN_FAILED';\n        \n        node.send(msg);\n        \n        log(msg.website.name + ' -- Sending a ' + msg.topic + ' message');\n        \n        await page.close()\n        await browser.close();\n    }\n})();","outputs":1,"noerr":0,"x":810,"y":220,"wires":[["62fe0d24.d84414"]]},{"id":"62fe0d24.d84414","type":"switch","z":"b7eb2a5f.2481a8","name":"Login Status","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"966SPORT_LOGIN_FAILED","vt":"str"},{"t":"eq","v":"966SPORT_LOGIN_SUCCESS","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":970,"y":220,"wires":[[],["f6c6cfcb.de8af"]]},{"id":"4c200cfb.9e86b4","type":"split","z":"dd2ff415.75e098","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":350,"y":200,"wires":[["8c3672cd.acb0b"]]},{"id":"e53e4072.3e599","type":"function","z":"987d9c15.b3c5","name":"Google Session","func":"'use strict';\n\nvar DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    \n    const browser = await puppeteer.launch({args: ['--no-sandbox', '--disable-setuid-sandbox', '--shm-size=1gb', '--disable-dev-shm-usage']});\n    let page = await browser.newPage();\n  \n    let ip = \"0.0.0.0\";\n    \n    try{\n       \n        log('Google -- Search for my ip');\n\n        await page.goto('https://www.google.com/search?q=whats+my+ip');\n        \n        log('Google -- Wait For Selector');\n        \n        const resultsSelector = \"w-answer-desktop\";\n        \n        await page.waitForSelector(resultsSelector);\n\n        log('Google -- Get your ip');\n    \n        // Extract the results from the page.\n        const result = await page.evaluate(resultsSelector => {\n            const anchors = Array.from(document.querySelectorAll(resultsSelector));\n            return anchors.map(anchor => {\n                const ip = anchor.textContent.replace(\"Your public IP address\",\"\");\n                return `${ip}`;\n            });\n        }, resultsSelector);\n        \n        if(Array.isArray(result) && result.length>0){\n            ip = result[0];\n            log('Google -- Your ip is ' + ip);\n        }\n        \n        log('Google -- saving cookies')\n        const cookies = await page.cookies()\n        \n        log('Google -- getting current url')\n        const url = await page.evaluate(() => location.href);\n              \n        msg.google.session = {\n            ip: ip,\n            cookies: cookies,\n            timestamp: Date.now()\n        }\n        \n        msg.payload =[msg.google.key,JSON.stringify(msg.google.session)]\n        \n        msg.topic = 'GOOGLE_SESSION_CREATED';\n        \n        node.send(msg);\n        \n        log('Google -- Sending a ' + msg.topic + ' message');\n        \n        await page.close();\n        await browser.close();\n      \n    }\n    catch(e){\n        \n        await page.close();\n        await browser.close();\n        \n        node.error(e);\n    }\n})();","outputs":1,"noerr":0,"x":1340,"y":400,"wires":[["e2da90eb.65ac9"]]},{"id":"f4a50262.cb338","type":"redis-command","z":"987d9c15.b3c5","server":"3535b384.5d390c","command":"get","name":"","topic":"","x":360,"y":560,"wires":[["c0a9ab2.c592258"]]},{"id":"22342900.6fd068","type":"redis-command","z":"987d9c15.b3c5","server":"3535b384.5d390c","command":"set","name":"","topic":"","x":1800,"y":400,"wires":[["62e9bb1.bfe4c44"]]},{"id":"5dca098e.2c9958","type":"json","z":"987d9c15.b3c5","name":"","property":"payload","action":"","pretty":false,"x":930,"y":560,"wires":[["8d871f40.f1413"]]},{"id":"8d871f40.f1413","type":"switch","z":"987d9c15.b3c5","name":"Result Exists in cache?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"null","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2910,"y":580,"wires":[["f03b0cb4.d79d8"],["d8890ab8.a55588"]]},{"id":"e2da90eb.65ac9","type":"switch","z":"987d9c15.b3c5","name":"GOOGLE_SESSION_CREATED","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"GOOGLE_SESSION_CREATED","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1580,"y":400,"wires":[["22342900.6fd068"]]},{"id":"62e9bb1.bfe4c44","type":"switch","z":"987d9c15.b3c5","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"OK","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1930,"y":400,"wires":[["48dee163.2e4ab"]]},{"id":"48dee163.2e4ab","type":"function","z":"987d9c15.b3c5","name":"Prepare Google Search Request","func":"msg.headers = {};\n\nmsg.headers['pragma'] = 'no-cache';\nmsg.headers['accept-language'] = 'en-US,en;q=0.9,es;q=0.8,sq;q=0.7,he;q=0.6';\nmsg.headers['upgrade-insecure-requests'] = '1'; \nmsg.headers['user-agent'] = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36';\nmsg.headers['x-chrome-uma-enabled'] = '1';\nmsg.headers['accept'] = 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8';\nmsg.headers['cache-control'] = 'no-cache';\nmsg.headers['authority'] = 'www.google.com' ;\nmsg.headers['referer'] = 'https://www.google.com/' ;\nmsg.headers['x-client-data'] = 'CIy2yQEIorbJAQj6nMoBCKmdygEIqKPKAQ==' ;\n\nmsg.headers['cookie'] = \"\";\n\nmsg.google.session.cookies.forEach( cookie => {\n    msg.headers['cookie'] = msg.headers['cookie'] + cookie.name + \"=\" + cookie.value +\";\"\n})\n\n//msg.headers['cookie'] = 'SID=1wUR2bBk007ka1qZ-LlCFTWV9ZPktj_8uOlaCTGsH_rryPGPsHOYMeutRMqP_WfTM8vFOQ.; HSID=A8Y4w06TlsDswwAeJ; SSID=AMrMKCFrEi1gxGnqe; APISID=IUzWNM9U7bPx3J4v/A_rOjznojC8ZHa0rk; SAPISID=tcwxRaHvpIGdGEQr/AheQN6D7POnGDLZTk; NID=126=oLfgQyzVYw2_gppcrUt1BlzHuZCRuIYPvZ-sOkODSnfde3SprDxuWN0VTU2HNPUfY4ZQ5jmJ7C2D75UiRLWHqyWs_ITsTrmWbC7OT2OlhB--8_innIlhdx-e4xofTnEnmIa2PwhR2PLlO_VlIvid7gD-ojM0vxtapcl-fXy53KMogNmdKaZmUhWfhU1f4e-l3Wily_DoZ2PsJkyvnYutDRk0roWKlnWyC9xHej6NlmEGyzPhwPXBoDUHKtfNsyii3YQmIlmlM1S1kHIMChhUURlqHtf_mtmnbc4ZRpKWnXAXESkwzaZIOk_7ynJsO1joetFLjjrGM9I9phuIPcPRkIvzlJHpUuR36JtxeC6Olu4kxJS9Gb3Or2uCX9FALTmJ4w4HkHJbZu6UK4eBgNXvN4RXOqYJXRfDsoAvUe_Yyg4H3Fbqtg; 1P_JAR=2018-03-30-00; DV=Q4AOKmzuVAREIPs_ZJY6ITCwfh1EJxae6kcv-tqp4AAAACAcuD9TMkTrsAAAAKCB8PQiUMTiNgAAAA';\n\nmsg.url = \"https://www.google.com/search?q=\" + msg.google.q.replace(\" \",\"+\");\n\nreturn msg;","outputs":1,"noerr":0,"x":2100,"y":480,"wires":[["149f14a9.e81d9b"]]},{"id":"149f14a9.e81d9b","type":"http request","z":"987d9c15.b3c5","name":"","method":"GET","ret":"txt","url":"","tls":"363f279c.1671a8","x":2330,"y":480,"wires":[["c11046c9.e9f1d8"]]},{"id":"e324edae.a0205","type":"html","z":"987d9c15.b3c5","name":"","property":"payload","tag":"div[data-hveid] > div > h3 > a","ret":"attr","as":"multi","x":2520,"y":380,"wires":[["96ccb471.a7ea18"]]},{"id":"58691bd5.d808c4","type":"change","z":"52f2656a.61247c","name":"","rules":[{"t":"set","p":"documentIndex","pt":"msg","to":"\"bets\" & \"-\" & $replace($split($now(), \"T\", 1) [0],\"-\",\".\")","tot":"jsonata"},{"t":"set","p":"documentType","pt":"msg","to":"doc","tot":"str"},{"t":"set","p":"documentId","pt":"msg","to":"$base64encode($lowercase(msg.payload.event.official & ';' & msg.payload.odd.type & ';' & msg.payload.odd.expires_on & ';' & msg.payload.odd.run_line))","tot":"jsonata"},{"t":"set","p":"payload.timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":440,"y":240,"wires":[[]]},{"id":"4949ef11.8c9d5","type":"switch","z":"aca500a5.26ea7","name":"","property":"payload.enabled","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":750,"y":380,"wires":[["3183b6e9.8de4ea","ed71a195.4fc58","4db3314d.976e4"]]},{"id":"a2128ad1.29f588","type":"function","z":"faf2e075.8588c","name":"Prepare http Request","func":"msg.headers = {};\n\nmsg.headers['Accept-Language'] = 'en-US,en;q=0.9,es;q=0.8,sq;q=0.7,he;q=0.6' \nmsg.headers['User-Agent'] = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36' \nmsg.headers['Accept'] = 'application/json, text/javascript, */*; q=0.01' \nmsg.headers['Referer'] = 'http://www.966sport.com/live' \nmsg.headers['X-Requested-With'] = 'XMLHttpRequest' \nmsg.headers['Connection'] = 'keep-alive'\n\nmsg.headers['cookie'] = \"\";\n\nmsg.session.cookies.forEach( cookie => {\n    msg.headers['cookie'] = msg.headers['cookie'] + cookie.name + \"=\" + cookie.value +\";\"\n})\n\nmsg.url = \"http://www.966sport.com/ajax/live?selsport=all&_=\" + msg.timestamp;\n\nmsg.topic = \"966SPORT_HTTP_REQUEST_COMPLETED\";\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":220,"wires":[["b2469cd2.9f36e"]]},{"id":"b2469cd2.9f36e","type":"http request","z":"faf2e075.8588c","name":"","method":"GET","ret":"txt","url":"","tls":"363f279c.1671a8","x":730,"y":220,"wires":[[]]},{"id":"ca4ed912.eec118","type":"switch","z":"faf2e075.8588c","name":"Response","property":"topic","propertyType":"msg","rules":[{"t":"cont","v":"RESPONSE_FROM_","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1050,"y":320,"wires":[[]]},{"id":"90a915b4.cfd408","type":"function","z":"4831be77.6607b","name":"Prepare http Request","func":"msg.headers = {};\n\nmsg.headers['origin'] = 'https://1betpro.com' \nmsg.headers['accept-language'] = 'en-US,en;q=0.9,es;q=0.8,sq;q=0.7,he;q=0.6' \nmsg.headers['user-agent'] = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36' \nmsg.headers['content-type'] = 'application/x-www-form-urlencoded' \nmsg.headers['accept'] = 'application/json, text/javascript, */*; q=0.01' \nmsg.headers['referer'] = 'https://1betpro.com/live/' \nmsg.headers['authority'] = '1betpro.com' \nmsg.headers['x-requested-with'] = 'XMLHttpRequest' \n\nmsg.headers['cookie'] = \"\";\n\nmsg.session.cookies.forEach( cookie => {\n    msg.headers['cookie'] = msg.headers['cookie'] + cookie.name + \"=\" + cookie.value +\";\"\n})\n\nmsg.url = \"https://1betpro.com/ajax/\"\n\nmsg.payload = {\n    \"mode\" : \"sports_leagues\",\n    \"period\" : \"live\",\n    \"rnd\" : msg.timestamp,\n    \"human\" : 0,\n    \"delta_time\" : 2113\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":220,"wires":[["a6eb88c4.19c058"]]},{"id":"a6eb88c4.19c058","type":"http request","z":"4831be77.6607b","name":"","method":"GET","ret":"txt","url":"","tls":"363f279c.1671a8","x":790,"y":220,"wires":[[]]},{"id":"a3ffdf4e.7085b","type":"subflow:d94fb931.bab888","z":"e6cabfa4.fd5d9","name":"1Betpro Session","x":220,"y":360,"wires":[["5d07c287.c3569c"],[]]},{"id":"22452de0.538f82","type":"subflow:fd5c9c45.e7c55","z":"e6cabfa4.fd5d9","name":"","x":1260,"y":300,"wires":[["d67ed55f.025e88"]]},{"id":"3b2f8d91.8307b2","type":"json","z":"72706932.2ca048","name":"","property":"payload","action":"obj","pretty":false,"x":230,"y":320,"wires":[["2e292b0d.4abd14","90443b65.a1a688"]]},{"id":"35a6dd67.524e82","type":"switch","z":"72706932.2ca048","name":"Task Router","property":"website.name","propertyType":"msg","rules":[{"t":"eq","v":"1betpro","vt":"str"},{"t":"eq","v":"966sport","vt":"str"},{"t":"eq","v":"pinibet","vt":"str"},{"t":"eq","v":"facebook","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":710,"y":240,"wires":[["adc75962.fcaa08"],["fd8d5a67.a51c28"],["982e21d2.e9ce7"],["b805e6b0.1b8008"]]},{"id":"8ae4bf07.b9737","type":"rdkafka in","z":"72706932.2ca048","name":"","topic":"^ALBERT_*","cgroup":"albert","autocommit":true,"broker":"c0e67585.074708","x":70,"y":320,"wires":[["3b2f8d91.8307b2"]]},{"id":"4a71e3b5.f78e4c","type":"debug","z":"72706932.2ca048","name":"","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"payload","x":1219,"y":179.99999904632568,"wires":[]},{"id":"6d1a6a43.1f9b94","type":"subflow:b7eb2a5f.2481a8","z":"4bfab75c.41da68","name":"","x":220,"y":280,"wires":[["e0434152.2f6db"],[]]},{"id":"890e7c96.dae9a","type":"subflow:987d9c15.b3c5","z":"4bfab75c.41da68","name":"","x":2380,"y":260,"wires":[["a77eec79.be5f4"]]},{"id":"fa6f23a9.c2e73","type":"function","z":"e1fcddda.49088","name":"Prepare http Request","func":"msg.headers = {};\n\nmsg.headers['origin'] = 'https://1betpro.com' \nmsg.headers['accept-language'] = 'en-US,en;q=0.9,es;q=0.8,sq;q=0.7,he;q=0.6' \nmsg.headers['user-agent'] = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36' \nmsg.headers['content-type'] = 'application/x-www-form-urlencoded' \nmsg.headers['accept'] = 'application/json, text/javascript, */*; q=0.01' \nmsg.headers['referer'] = 'https://1betpro.com/live/' \nmsg.headers['authority'] = '1betpro.com' \nmsg.headers['x-requested-with'] = 'XMLHttpRequest' \n\nmsg.headers['cookie'] = \"\";\n\nmsg.website.session.cookies.forEach( cookie => {\n    msg.headers['cookie'] = msg.headers['cookie'] + cookie.name + \"=\" + cookie.value +\";\"\n})\n\nmsg.url = \"https://1betpro.com/ajax/\"\n\nmsg.payload = {\n    \"mode\" : \"game_more\",\n    \"game_id\" : msg.payload,\n    \"rnd\" : new Date(),\n    \"human\" : 1,\n    \"delta_time\" : 0\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":440,"wires":[["dfb00517.1363e8"]]},{"id":"dfb00517.1363e8","type":"http request","z":"e1fcddda.49088","name":"","method":"POST","ret":"txt","url":"","tls":"363f279c.1671a8","x":830,"y":440,"wires":[["16740cbc.486703"]]},{"id":"ddf94991.e5db28","type":"function","z":"e6cabfa4.fd5d9","name":"Today's Events Requests","func":"msg.headers = {};\n\nmsg.headers['origin'] = 'https://1betpro.com' \nmsg.headers['accept-language'] = 'en-US,en;q=0.9,es;q=0.8,sq;q=0.7,he;q=0.6' \nmsg.headers['user-agent'] = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36' \nmsg.headers['content-type'] = 'application/x-www-form-urlencoded' \nmsg.headers['accept'] = 'application/json, text/javascript, */*; q=0.01' \nmsg.headers['referer'] = 'https://1betpro.com/live/' \nmsg.headers['authority'] = '1betpro.com' \nmsg.headers['x-requested-with'] = 'XMLHttpRequest' \n\nmsg.headers['cookie'] = \"\";\n\nmsg.website.session.cookies.forEach( cookie => {\n    msg.headers['cookie'] = msg.headers['cookie'] + cookie.name + \"=\" + cookie.value +\";\"\n})\n\nmsg.request = {\n    headers : msg.headers\n}\n\nmsg.url = \"https://1betpro.com/ajax/\"\n\nmsg.payload = {\n    \"mode\" : \"lines\",\n    //debug\n    \"period\" : \"today\",\n    \"sport_id\": 1,\n    \"league_id\" : \"all\",\n    //prod\n    //\"period\" : \"live\",\n    \"action\": \"cng\",\n    \"rnd\" : msg.timestamp,\n    \"human\" : 1,\n    \"delta_time\" : 0\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":360,"wires":[["ee2ebaf.4b8ef48"]]},{"id":"ee2ebaf.4b8ef48","type":"http request","z":"e6cabfa4.fd5d9","name":"","method":"POST","ret":"txt","url":"","tls":"363f279c.1671a8","x":690,"y":360,"wires":[["2156a8be.190a18"]]},{"id":"bf3db1de.5b3f8","type":"split","z":"e1fcddda.49088","name":"For Each 1BetPro Event","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":390,"y":440,"wires":[["fa6f23a9.c2e73"]]},{"id":"e0434152.2f6db","type":"function","z":"4bfab75c.41da68","name":"Live Events Request","func":"msg.headers = {};\n\nmsg.headers['Accept-Language'] = 'en-US,en;q=0.9,es;q=0.8,sq;q=0.6' \nmsg.headers['User-Agent'] = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36' \nmsg.headers['Accept'] = 'application/json, text/javascript, */*; q=0.01' \nmsg.headers['Referer'] = 'http://www.966sport.com/live' \nmsg.headers['X-Requested-With'] = 'XMLHttpRequest' \nmsg.headers['Connection'] = 'keep-alive'\n\nmsg.headers['cookie'] = \"\";\n\nmsg.website.session.cookies.forEach( cookie => {\n    msg.headers['cookie'] = msg.headers['cookie'] + cookie.name + \"=\" + cookie.value +\";\"\n})\n\nmsg.url = \"http://www.966sport.com/ajax/live?selsport=all&_=\" + msg.timestamp;\n\n//When there's no live event and we want to test flow\n//msg.url = \"http://www.966sport.com/ajax/ajax_t_games?sport=soccer&time=t&startop=2&options=&_=\" + msg.timestamp;\n\nmsg.topic = \"966SPORT_HTTP_REQUEST_COMPLETED\";\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":260,"wires":[["ac6350b0.e7876"]]},{"id":"ac6350b0.e7876","type":"http request","z":"4bfab75c.41da68","name":"","method":"GET","ret":"txt","url":"","tls":"363f279c.1671a8","x":670,"y":260,"wires":[["e50855e1.791b38"]]},{"id":"16740cbc.486703","type":"json","z":"e1fcddda.49088","name":"","property":"payload","action":"","pretty":false,"x":970,"y":440,"wires":[[]]},{"id":"b50b2b0e.0d4a48","type":"config","z":"aca500a5.26ea7","name":"delay","properties":[{"p":"delay","pt":"flow","to":"0","tot":"num"}],"active":true,"x":590,"y":200,"wires":[]},{"id":"3300be85.f4a2c2","type":"split","z":"4bfab75c.41da68","name":"For Each 966sport League","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1300,"y":240,"wires":[["78868ff9.5db25"]]},{"id":"c6ff8a6c.5a65a8","type":"change","z":"fd5c9c45.e7c55","name":"Set Line","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.line","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":200,"wires":[["72322ad1.a13b34"]]},{"id":"5f9d13c3.c32d0c","type":"switch","z":"fd5c9c45.e7c55","name":"Got Line","property":"payload.line","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":180,"y":200,"wires":[["c6ff8a6c.5a65a8"]]},{"id":"72322ad1.a13b34","type":"split","z":"fd5c9c45.e7c55","name":"For Each Line","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":480,"y":200,"wires":[["5c4c5c17.9aa634"]]},{"id":"d67ed55f.025e88","type":"subflow:e1fcddda.49088","z":"e6cabfa4.fd5d9","name":"","x":1490,"y":300,"wires":[["621c66a5.371f88"]]},{"id":"64b40aef.230484","type":"function","z":"b7eb2a5f.2481a8","name":"Set Website","func":"//msg.website = msg;\n\nmsg.payload = [msg.website.name + \"_session\"];\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":240,"wires":[["be17b9da.733e28"]]},{"id":"be17b9da.733e28","type":"redis-command","z":"b7eb2a5f.2481a8","server":"3535b384.5d390c","command":"get","name":"","topic":"","x":420,"y":240,"wires":[["f31db5d1.1b9118"]]},{"id":"f31db5d1.1b9118","type":"json","z":"b7eb2a5f.2481a8","name":"","property":"payload","action":"","pretty":false,"x":550,"y":240,"wires":[["e7ad728d.fb27a"]]},{"id":"e7ad728d.fb27a","type":"switch","z":"b7eb2a5f.2481a8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"null","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":240,"wires":[["8a088a21.50a928"],["a56d9438.4aa278"]]},{"id":"a56d9438.4aa278","type":"change","z":"b7eb2a5f.2481a8","name":"Get Session","rules":[{"t":"set","p":"website.session","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"topic","pt":"msg","to":"966SPORT_LOGIN_SUCCESS","tot":"str"},{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":280,"wires":[[]]},{"id":"f6c6cfcb.de8af","type":"redis-command","z":"b7eb2a5f.2481a8","server":"3535b384.5d390c","command":"set","name":"","topic":"","x":1140,"y":240,"wires":[[]]},{"id":"a7be1e21.862a5","type":"switch","z":"d94fb931.bab888","name":"Login Status","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"1BETPRO_LOGIN_FAILED","vt":"str"},{"t":"eq","v":"1BETPRO_LOGIN_SUCCESS","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":970,"y":80,"wires":[[],["87e56684.c18a38"]]},{"id":"15c93f15.719d71","type":"function","z":"d94fb931.bab888","name":"Set Website","func":"//msg.website = msg;\n\nmsg.payload = [msg.website.name + \"_session\"];\n\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":100,"wires":[["9a4223d5.9c4f6"]]},{"id":"9a4223d5.9c4f6","type":"redis-command","z":"d94fb931.bab888","server":"3535b384.5d390c","command":"get","name":"","topic":"","x":400,"y":100,"wires":[["e115ab39.9b8bd8"]]},{"id":"e115ab39.9b8bd8","type":"json","z":"d94fb931.bab888","name":"","property":"payload","action":"","pretty":false,"x":550,"y":100,"wires":[["7df2c60b.8a1f48"]]},{"id":"7df2c60b.8a1f48","type":"switch","z":"d94fb931.bab888","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"null","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":100,"wires":[["f33e6a44.9207c8"],["c49073ad.50203"]]},{"id":"c49073ad.50203","type":"change","z":"d94fb931.bab888","name":"Get Session","rules":[{"t":"set","p":"website.session","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"topic","pt":"msg","to":"1BETPRO_LOGIN_SUCCESS","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":140,"wires":[[]]},{"id":"87e56684.c18a38","type":"redis-command","z":"d94fb931.bab888","server":"3535b384.5d390c","command":"set","name":"","topic":"","x":1140,"y":100,"wires":[[]]},{"id":"6a20042c.cd458c","type":"inject","z":"aca500a5.26ea7","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":560,"wires":[["211b0ffa.fd4b2"]]},{"id":"73617439.01c0bc","type":"redis-command","z":"aca500a5.26ea7","server":"3535b384.5d390c","command":"get","name":"","topic":"","x":600,"y":560,"wires":[["a8f2582.6f770a8"]]},{"id":"a8f2582.6f770a8","type":"debug","z":"aca500a5.26ea7","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":810,"y":560,"wires":[]},{"id":"211b0ffa.fd4b2","type":"function","z":"aca500a5.26ea7","name":"Delete Redis keys","func":"\nmsg.payload = ['1betpro_session']\n    \nreturn msg;","outputs":1,"noerr":0,"x":390,"y":560,"wires":[["73617439.01c0bc"]]},{"id":"717410a5.33831","type":"change","z":"4bfab75c.41da68","name":"List 966sport League Events","rules":[{"t":"set","p":"league","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"payload.events","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1760,"y":260,"wires":[["6e313773.ee4198"]]},{"id":"70755d81.236bc4","type":"change","z":"987d9c15.b3c5","name":"","rules":[{"t":"set","p":"documentIndex","pt":"msg","to":"\"bets\" & \"-\" & $replace($split($now(), \"T\", 1) [0],\"-\",\".\")","tot":"jsonata"},{"t":"set","p":"documentType","pt":"msg","to":"doc","tot":"str"},{"t":"set","p":"documentId","pt":"msg","to":"$base64encode(msg.payload.event.official.name & ';' & msg.payload.event.date & ';' & msg.payload.odd.type & ';' & msg.payload.odd.expires_on & ';' &  msg.payload.odd.run_line & ';' & msg.payload.odd.opponent)","tot":"jsonata"},{"t":"set","p":"payload.timestamp","pt":"msg","to":"","tot":"date"},{"t":"set","p":"google","pt":"msg","to":"{\t    \"q\" : msg.payload.event.name,\t    \"key\": \"google_session_test3\"\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1740,"y":880,"wires":[[]]},{"id":"33383dcd.33b232","type":"function","z":"987d9c15.b3c5","name":"Keep previous payload","func":"msg.payload = [\"v6_google_game_search_\" + msg.google.q];\n\nreturn msg;","outputs":1,"noerr":0,"x":180,"y":560,"wires":[["f4a50262.cb338"]]},{"id":"e9779b31.d35da8","type":"comment","z":"987d9c15.b3c5","name":"Get query result from cache","info":"","x":290,"y":500,"wires":[]},{"id":"f03b0cb4.d79d8","type":"function","z":"987d9c15.b3c5","name":"get google session from cache","func":"msg.payload = [msg.google.key];\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":420,"wires":[["bc585e9e.4cdde"]]},{"id":"bc585e9e.4cdde","type":"redis-command","z":"987d9c15.b3c5","server":"3535b384.5d390c","command":"get","name":"","topic":"","x":860,"y":420,"wires":[["689284cd.e8492c"]]},{"id":"689284cd.e8492c","type":"json","z":"987d9c15.b3c5","name":"","property":"payload","action":"","pretty":false,"x":990,"y":420,"wires":[["36987314.bc7d0c"]]},{"id":"36987314.bc7d0c","type":"switch","z":"987d9c15.b3c5","name":"Session in cache?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"null","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1150,"y":420,"wires":[["e53e4072.3e599"],["ed15abf.0b07558"]]},{"id":"87f89f95.df0ce","type":"redis-command","z":"987d9c15.b3c5","server":"3535b384.5d390c","command":"set","name":"","topic":"","x":2940,"y":480,"wires":[["30cd385b.2d81a8"]]},{"id":"30cd385b.2d81a8","type":"switch","z":"987d9c15.b3c5","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"OK","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":3070,"y":480,"wires":[["f310d276.13075"]]},{"id":"96ccb471.a7ea18","type":"change","z":"987d9c15.b3c5","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.href","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2740,"y":380,"wires":[["e001305f.3e3a3"]]},{"id":"ed6ee300.391be","type":"function","z":"987d9c15.b3c5","name":"","func":"msg.google.result = msg.payload;\n\nmsg.payload =[\"v6_google_game_search_\" + msg.google.q,JSON.stringify(msg.payload)]\n        \nreturn msg;","outputs":1,"noerr":0,"x":2810,"y":480,"wires":[["87f89f95.df0ce"]]},{"id":"d8890ab8.a55588","type":"change","z":"987d9c15.b3c5","name":"","rules":[{"t":"set","p":"google.result","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":3180,"y":580,"wires":[["f310d276.13075"]]},{"id":"8c3672cd.acb0b","type":"change","z":"dd2ff415.75e098","name":"","rules":[{"t":"set","p":"documentIndex","pt":"msg","to":"\"bets\" & \"-\" & $replace($split($now(), \"T\", 1) [0],\"-\",\".\")","tot":"jsonata"},{"t":"set","p":"documentType","pt":"msg","to":"doc","tot":"str"},{"t":"set","p":"documentId","pt":"msg","to":"$base64encode($lowercase(msg.payload.event.official & ';' & msg.payload.odd.type & ';' & msg.payload.odd.expires_on & ';' & msg.payload.odd.run_line))","tot":"jsonata"},{"t":"set","p":"payload.timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":200,"wires":[[]]},{"id":"ed15abf.0b07558","type":"change","z":"987d9c15.b3c5","name":"","rules":[{"t":"set","p":"google.session","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1370,"y":480,"wires":[["48dee163.2e4ab"]]},{"id":"6e313773.ee4198","type":"split","z":"4bfab75c.41da68","name":"For Each Event","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1980,"y":260,"wires":[["ecdcad0c.e21c3"]]},{"id":"ecdcad0c.e21c3","type":"change","z":"4bfab75c.41da68","name":"Set Google Keywords","rules":[{"t":"set","p":"data","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"google","pt":"msg","to":"{\t    \"q\" : $replace($lowercase(msg.payload.home_team & ' vs ' & msg.payload.away_team),\" \",\"+\"),\t    \"key\": \"google_session_test3\"\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2180,"y":260,"wires":[["890e7c96.dae9a"]]},{"id":"e001305f.3e3a3","type":"join","z":"987d9c15.b3c5","name":"","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":2890,"y":380,"wires":[[]]},{"id":"f522eff1.97f54","type":"function","z":"72706932.2ca048","name":"Set Task","func":"\nlet task_json = JSON.stringify(msg.payload);\n\nmsg.payload.topic = msg.topic;\nmsg = msg.payload;\nmsg.website = JSON.parse(task_json);\nmsg.task = JSON.parse(task_json);\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":240,"wires":[["35a6dd67.524e82"]]},{"id":"c11046c9.e9f1d8","type":"html","z":"987d9c15.b3c5","name":"","property":"payload","tag":"div.ellipsisize","ret":"text","as":"single","x":2490,"y":480,"wires":[["5146d0ba.a9cef"]]},{"id":"ef0a6a7b.46d028","type":"change","z":"987d9c15.b3c5","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload[0]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":3140,"y":360,"wires":[[]]},{"id":"5146d0ba.a9cef","type":"switch","z":"987d9c15.b3c5","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":2690,"y":480,"wires":[["ed6ee300.391be"]]},{"id":"c0a9ab2.c592258","type":"switch","z":"987d9c15.b3c5","name":"","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":" \"\"","vt":"str"},{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":510,"y":560,"wires":[["5dca098e.2c9958"],["5dca098e.2c9958"],["f03b0cb4.d79d8"]]},{"id":"78868ff9.5db25","type":"switch","z":"4bfab75c.41da68","name":"Is it real league?","property":"payload.liga","propertyType":"msg","rules":[{"t":"cont","v":"- corners","vt":"str"},{"t":"cont","v":"- specific 15 mins","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1520,"y":240,"wires":[[],[],["717410a5.33831"]]},{"id":"5f9e7951.b92058","type":"function","z":"52f2656a.61247c","name":"","func":"var DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nvar odd_mapper = function(odd, type, expires_on){\n    \n    let sign = parseInt((type===\"Over/Under\") ? \"-1\" : \"1\");\n    \n    return {\n        \"type\" : type,\n        \"expires_on\" : expires_on,\n        \"run_line\" : ((odd.length>2) ? 1 : parseFloat((odd[0][2]==\"pk\") ? 0 : odd[0][2])).toString() + \"/\" + (((odd.length>2) ? 1 : parseFloat((odd[1][2]==\"pk\") ? 0 : odd[1][2]))).toString(),\n        \"1betpro\": {\n            \"id_1\" : odd[0][0].replace(\"__\",\"\"),\n            \"money_line_1\"  : parseFloat(odd[0][1]),\n            \"run_line_1\"  : parseFloat((odd.length>2) ? 1 : parseFloat((odd[0][2]==\"pk\") ? 0 : odd[0][2])),\n        \n            \"id_2\" : odd[1][0].replace(\"__\",\"\"),\n            \"money_line_2\"  : parseFloat(odd[1][1]),\n            \"run_line_2\"  : parseFloat(sign * ((odd.length>2) ? 1 : parseFloat((odd[1][2]==\"pk\") ? 0 : odd[1][2]))),\n            \n            \"id_0\" : (odd.length>2) ? odd[2][0].replace(\"__\",\"\") : null,\n            \"money_line_0\"  : (odd.length>2) ? parseFloat(odd[2][1]) : null,\n            \"run_line_0\" : (odd.length>2) ? parseFloat(1) : null\n        }\n    };\n}\n\nDate.prototype.getRoundHours = function() {\n  var mm = this.getMonth() + 1; // getMonth() is zero-based\n  var dd = this.getDate();\n  \n  return [this.getFullYear()     + '-',\n          (mm>9 ? '' : '0') + mm + '-',\n          (dd>9 ? '' : '0') + dd ,\n         ].join('');\n};\n\nlet odds = [];\n\ntry{\n    \n    let event_date = new Date();\n    let event_rounded_date = event_date.getRoundHours();\n\n    let event_hour = msg.data.date.replace('<span class=\"tablo_time\">','').replace('</span>','');\n    \n    event_date = new Date(event_rounded_date.toString() + ' ' + event_hour + \":00\");\n    \nlet event = {\n    \"name\" : (msg.data.teams[0] + ' vs ' + msg.data.teams[1]).toLowerCase(),\n    \"official\": (msg.google.result.length>0) ? msg.google.result[0].toLowerCase() : (msg.data.teams[0] + ' vs ' + msg.data.teams[1]).toLowerCase(),\n    \"participants\" : msg.data.teams.map(team => {return team.toLowerCase()}),\n    \"date\" : event_date.getTime(),\n    \"score\" : (msg.data.hasOwnProperty(\"add_inf\") && msg.data.add_inf!==null) ? ((msg.data.add_inf.hasOwnProperty(\"sc1\")) ? msg.data.add_inf.sc1 : 0) + ' - ' + ((msg.data.add_inf.hasOwnProperty(\"sc2\")) ? msg.data.add_inf.sc2 : 0) : '0 - 0',\n    \"league.name\" : msg.data.league.toLowerCase(),\n    \"sport.name\" : msg.data.sport.toLowerCase(),\n    \"minute\": (msg.data.hasOwnProperty(\"add_inf\")  && msg.data.add_inf!==null) ? parseInt(msg.data.add_inf.minute.replace(\"'\")) : 0\n}\n\nlet orig_odds = msg.data.sg[\"1\"];\n\n\nif(orig_odds.hasOwnProperty(\"ft\")){\n    \n    if(orig_odds.ft.hasOwnProperty(\"1x2\")){\n        odds.push({\n                \"event\" : event,\n                \"odd\": odd_mapper(orig_odds.ft[\"1x2\"],\"1x2\",\"Full Time\")\n            });\n    }\n    \n    if(orig_odds.ft.hasOwnProperty(\"ou\")){\n        orig_odds.ft.ou.forEach(odd => {\n            odds.push({\n                \"event\" : event,\n                \"odd\": odd_mapper(odd,\"Over/Under\",\"Full Time\")\n            });\n        })\n    }\n    \n    if(orig_odds.ft.hasOwnProperty(\"ah\")){\n        orig_odds.ft.ah.forEach(odd => {\n            odds.push({\n                \"event\" : event,\n                \"odd\": odd_mapper(odd,\"Handicap\",\"Full Time\")\n            });\n        })\n    }\n}\n  \nif(orig_odds.hasOwnProperty(\"ht\")){\n    \n    if(orig_odds.ht.hasOwnProperty(\"1x2\")){\n        odds.push({\n                \"event\" : event,\n                \"odd\": odd_mapper(orig_odds.ht[\"1x2\"],\"1x2\",\"1st Half\")\n            });\n    }\n    \n    if(orig_odds.ht.hasOwnProperty(\"ou\")){\n        orig_odds.ht.ou.forEach(odd => {\n            odds.push({\n                \"event\" : event,\n                \"odd\": odd_mapper(odd,\"Over/Under\",\"1st Half\")\n            });\n        })\n    }\n    \n    if(orig_odds.ht.hasOwnProperty(\"ah\")){\n        orig_odds.ht.ah.forEach(odd => {\n            odds.push({\n                \"event\" : event,\n                \"odd\": odd_mapper(odd,\"Handicap\",\"1st Half\")\n            });\n        })\n    }\n}\n\n//log(msg.page.website.name + ' -- Finish Transformation, got ' + odds.length + ' rows');\n\n/*odds = odds.map(odd => {\n    Object.keys(odd).map(function(key, index) {\n       odd[key] = (odd[key]===null || odd[key]===undefined) ? \"-1\" : odd[key];\n    });\n})*/\n}\ncatch(e){\n    //node.error(e);\n    msg.error = e;\n}\n\nmsg.payload = odds;\n\nreturn msg;","outputs":1,"noerr":0,"x":130,"y":200,"wires":[["9f5860af.d57d4"]]},{"id":"d510851f.9e89a8","type":"function","z":"dd2ff415.75e098","name":"Transform","func":"var DEBUG=msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nvar odd_mapper = function(odd, type, expires_on){\n    \n    try{\n            \n        let codes = {\n            \"Full Time\" :\"FT\",\n            \"1st Half\" : \"FH\",\n            \"1x2\" : \"1X2\",\n            \"Handicap\" : \"HDP\",\n            \"Over/Under\" : \"OU\"\n        }\n        \n        let opponent_1 = (type === \"Over/Under\") ? \"o\" : \"h\";\n        let opponent_2 = (type === \"Over/Under\") ? \"u\" : \"a\";\n        let opponent_0 = (type === \"1x2\") ? \"d\" : null;\n\n        let sign = parseInt((type === \"Over/Under\") ? \"-1\" : \"1\");\n\n        return {\n            \"type\"          :  type,\n            \"expires_on\"    :  expires_on,\n            \"run_line\"      :  (parseFloat(msg.data[codes[expires_on] + '_' + codes[type] + '_' + opponent_1 + \"_op\"].toString().trim().replace(\" \",\"\"))).toString() + \"/\" + (parseFloat(msg.data[codes[expires_on] + '_' + codes[type] + '_' + opponent_2 + \"_op\"].toString().trim().replace(\" \",\"\"))).toString(),\n            \"966sport\": {\n                \"id_1\"           :  (msg.data.id_e + codes[expires_on] + '_' + codes[type] + '_' + opponent_1 + '_' + msg.data[codes[expires_on] + '_' + codes[type] + '_' + opponent_1 + \"_op\"].toString()).trim().replace(\" \",\"\"),\n                \"money_line_1\"   :  parseFloat(msg.data[codes[expires_on] + '_' + codes[type] + '_' + opponent_1].toString().trim().replace(\" \",\"\")),\n                \"run_line_1\"     :  parseFloat(msg.data[codes[expires_on] + '_' + codes[type] + '_' + opponent_1 + \"_op\"].toString().trim().replace(\" \",\"\")),\n                \n                \"id_2\"           :  (msg.data.id_e + codes[expires_on] + '_' + codes[type] + '_' + opponent_2 + '_' + msg.data[codes[expires_on] + '_' + codes[type] + '_' + opponent_2 + \"_op\"].toString()).trim().replace(\" \",\"\"),\n                \"money_line_2\"   :  parseFloat(msg.data[codes[expires_on] + '_' + codes[type] + '_' + opponent_2].toString().trim().replace(\" \",\"\")),\n                \"run_line_2\"     :  sign * parseFloat(msg.data[codes[expires_on] + '_' + codes[type] + '_' + opponent_2 + \"_op\"].toString().trim().replace(\" \",\"\")),\n                \n                \"id_0\"           :  opponent_0!==null ? (msg.data.id_e + codes[expires_on] + '_' + codes[type] + '_' + opponent_0).trim().replace(\" \",\"\") : null,\n                \"money_line_0\"   :  opponent_0!==null ? parseFloat(msg.data[codes[expires_on] + '_' + codes[type] + '_' + opponent_0].toString().trim().replace(\" \",\"\")) : null,\n                \"run_line_0\"     :  opponent_0!==null ? parseFloat(1) : null\n            }\n        }\n    }\n    catch(e){\n        log(e.message)\n    }\n}\n\nDate.prototype.getRoundHours = function() {\n  var mm = this.getMonth() + 1; // getMonth() is zero-based\n  var dd = this.getDate();\n  var hh = this.getHours();\n  \n  return [this.getFullYear()     + '-',\n          (mm>9 ? '' : '0') + mm + '-',\n          (dd>9 ? '' : '0') + dd + 'T',\n          (hh>9 ? '' : '0') + hh + ':00:00.000Z',\n         ].join('');\n};\n\nlet odds = [];\n\ntry{\n    \n    let event_date = new Date();\n    let event_rounded_date = event_date.getRoundHours();\n\n    let event_minute = parseInt(msg.data.date);\n    \n    if(msg.data.date.includes(\"LIVE\") || msg.data.date.includes(\"Half Time\")){\n        event_date = event_rounded_date;\n        //event_minute = 0;\n    }\n    else if(event_minute>=0){\n        \n        event_date.setMinutes(event_date.getMinutes() - event_minute);\n        event_date.setMinutes(event_date.getMinutes() - (event_date.getMinutes() % 5));\n        \n        event_date.setSeconds(\"00\");\n        event_date.setMilliseconds(\"000\");\n        \n        event_minute = event_minute;\n    }\n    else{\n        event_date = \"1900-01-01T00:00:00.000Z\";\n        event_minute = -1;\n    }\n    \n    //event_date = event_date.toString().replace(\"T\",\" \").replace(\".000Z\",\"\");\n    \n    msg.data.score_h = isNaN(parseInt(msg.data.score_h)) ? 0 : parseInt(msg.data.score_h)\n    msg.data.score_a = isNaN(parseInt(msg.data.score_a)) ? 0 : parseInt(msg.data.score_a)\n    \n    msg.data.score_h = msg.data.score_h===null ? 0 : msg.data.score_h;\n    msg.data.score_a = msg.data.score_a===null ? 0 : msg.data.score_a;\n\n    const event= {\n            name: (msg.data.home_team + ' vs ' + msg.data.away_team).toLowerCase(),\n            official: msg.google.result.length>0 ? msg.google.result[0].toLowerCase() : (msg.data.home_team + ' vs ' + msg.data.away_team).toLowerCase(),\n            date: event_date.getTime(),\n            participants: [msg.data.home_team.toLowerCase(),msg.data.away_team.toLowerCase()],\n            score: msg.data.score_h + ' - ' + msg.data.score_a,\n            minute: event_minute,\n            league: {\n                name: msg.league.liga.toLowerCase()\n            },\n            sport: {\n                name: msg.league.sport.toLowerCase()\n            }\n        };\n     \n    // 1x2\n    // Full Time \n    if(msg.data.hasOwnProperty(\"FT_1X2_h\") && msg.data.hasOwnProperty(\"FT_1X2_a\")){\n        \n        try{\n            \n            odds.push({\n                \"event\" : event,\n                \"odd\": odd_mapper(msg.data,\"1x2\",\"Full Time\")\n            });\n            \n        }\n        catch(e){\n            log(e.message)\n        }\n    }\n    \n    // 1st Half\n    if(msg.data.hasOwnProperty(\"FH_1X2_h\") && msg.data.hasOwnProperty(\"FH_1X2_a\")){\n        \n        try{\n            \n            odds.push({\n                \"event\" : event,\n                \"odd\": odd_mapper(msg.data,\"1x2\",\"1st Half\")\n            });\n        }\n        catch(e){\n            log(e.message)\n        }\n    }\n    \n    // Handicap\n    // Full Time\n    if(msg.data.hasOwnProperty(\"FT_HDP_h\") && msg.data.hasOwnProperty(\"FT_HDP_a\")){\n        try{\n            \n            odds.push({\n                \"event\" : event,\n                \"odd\": odd_mapper(msg.data,\"Handicap\",\"Full Time\")\n            });\n        }\n        catch(e){\n            log(e.message)\n        }\n    } \n    \n    // 1st Half\n    if(msg.data.hasOwnProperty(\"FH_HDP_h\") && msg.data.hasOwnProperty(\"FH_HDP_a\")){\n        try{\n            \n            odds.push({\n                \"event\" : event,\n                \"odd\": odd_mapper(msg.data,\"Handicap\",\"1st Half\")\n            });\n        }\n        catch(e){\n            log(e.message)\n        }\n    } \n    \n    // Over/Under\n    // Full Time\n    if(msg.data.hasOwnProperty(\"FT_OU_o\") && msg.data.hasOwnProperty(\"FT_OU_u\")){\n        try{\n            \n            odds.push({\n                \"event\" : event,\n                \"odd\": odd_mapper(msg.data,\"Over/Under\",\"Full Time\")\n            })\n            \n        }\n        catch(e){\n            log(e.message)\n        }\n    }\n    \n    // Over/Under\n    // 1st Half\n    if(msg.data.hasOwnProperty(\"FH_OU_o\") && msg.data.hasOwnProperty(\"FH_OU_u\")){\n        try{\n            \n            odds.push({\n                \"event\" : event,\n                \"odd\": odd_mapper(msg.data,\"Over/Under\",\"1st Half\")\n            })\n            \n        }\n        catch(e){\n            log(e.message)\n        }\n    }\n    \n    msg.payload = odds;\n    \n    return msg;\n}\ncatch(e){\n    //node.error(e)\n    \n    msg.payload = odds;\n    msg.error = e;\n    \n    return msg;\n}","outputs":1,"noerr":0,"x":190,"y":200,"wires":[["4c200cfb.9e86b4"]]},{"id":"e50855e1.791b38","type":"function","z":"4bfab75c.41da68","name":"Check Response","func":"\ntry{\n   msg.payload = JSON.parse(msg.payload);\n    msg.topic   = (msg.flow + \"_966sport_session_alive\").toUpperCase();\n   return msg;\n}\ncatch(e){\n    msg.topic   = (msg.flow + \"_966sport_session_expired\").toUpperCase();\n    return msg;\n}\n\n","outputs":1,"noerr":0,"x":850,"y":260,"wires":[["2e5072d5.d9f94e"]]},{"id":"2e5072d5.d9f94e","type":"switch","z":"4bfab75c.41da68","name":"Session Alive?","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"albert-966sport-session-alive","vt":"str"},{"t":"eq","v":"albert-966sport-session-expired","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1040,"y":260,"wires":[["3300be85.f4a2c2"],["9c9a0fcc.b18c7"]]},{"id":"340471df.fe8afe","type":"switch","z":"e6cabfa4.fd5d9","name":"Session Alive?","property":"payload.error","propertyType":"msg","rules":[{"t":"else"},{"t":"eq","v":"login","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1060,"y":340,"wires":[["22452de0.538f82"],["a5276c18.7e342"]]},{"id":"2156a8be.190a18","type":"function","z":"e6cabfa4.fd5d9","name":"Check Response","func":"\ntry{\n    msg.payload = JSON.parse(msg.payload);\n    msg.topic   = (msg.flow + \"_1betpro_session_alive\").toUpperCase();\n    return msg;\n}\ncatch(e){\n    msg.topic   = (msg.flow + \"_1betpro_session_expired\").toUpperCase();\n    return msg;\n}\n\n","outputs":1,"noerr":0,"x":870,"y":340,"wires":[["340471df.fe8afe"]]},{"id":"f73f710.d3a749","type":"function","z":"381da27a.bf1b8e","name":"Stringify Message and reset cache","func":"\n/*msg = {\n    documentIndex: msg.documentIndex,\n    documentType: msg.documentType,\n    documentId: msg.documentId,\n    payload: msg.payload,\n    debug: msg.debug,\n    flow: msg.flow\n}*/\n\nmsg.prev_payload = JSON.stringify(msg);\nmsg.payload = [msg.website.name + \"_session\"];\n\nif(msg.hasOwnProperty(\"retry\")){\n    if(msg.retry<3){\n        msg.retry = msg.retry + 1;\n    }\n}\nelse{\n    msg.retry = 1;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":220,"wires":[["2b5cd9d9.ad7146"]]},{"id":"a5276c18.7e342","type":"subflow:381da27a.bf1b8e","z":"e6cabfa4.fd5d9","name":"","x":1240,"y":380,"wires":[["f000c3f9.59cfb"]]},{"id":"2b5cd9d9.ad7146","type":"redis-command","z":"381da27a.bf1b8e","server":"3535b384.5d390c","command":"del","name":"","topic":"","x":660,"y":220,"wires":[["25590db2.b2a722"]]},{"id":"9c9a0fcc.b18c7","type":"subflow:381da27a.bf1b8e","z":"4bfab75c.41da68","name":"","x":1260,"y":320,"wires":[[]]},{"id":"20fb1a9c.949976","type":"function","z":"381da27a.bf1b8e","name":"","func":"msg.payload = msg.prev_payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":220,"wires":[[]]},{"id":"e3369fff.039ef","type":"function","z":"920d75bc.d0fe08","name":"Get Data","func":"'use strict';\n\nvar DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n    \nfunction sleep(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n    \nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    \n    const browser = await puppeteer.launch({args: ['--proxy-server=35.184.135.47:8118','--no-sandbox', '--disable-setuid-sandbox', '--shm-size=1gb', '--disable-dev-shm-usage']}); //});//{headless: false\n    let page = await browser.newPage();\n    page.setUserAgent('Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36');\n    \n    try{\n        \n        msg.website.url = \"https://ropinwev.pinbet88.com/sports-service/sv/odds/events?l=100&ot=1\";\n        \n        log(msg.website.name + ' -- Go to ' + msg.website.url);\n        await page.goto(msg.website.url);\n        \n        let bodyText = await page.evaluate(() => document.body.innerText);\n        \n        msg.payload = bodyText;\n        \n        msg.topic = 'PINIBET_LOGIN_SUCCESS';\n        \n        node.send(msg);\n        \n        log(msg.website.name + ' -- Sending a ' + msg.topic + ' message');\n        await page.close();\n        await browser.close();\n    }\n    catch(e){\n        \n        node.error(e);\n        \n        msg.topic = 'PINIBET_LOGIN_FAILED';\n        \n        node.send(msg);\n        \n        log(msg.website.name + ' -- Sending a ' + msg.topic + ' message');\n        \n        await page.close();\n        await browser.close();\n    }\n})();","outputs":1,"noerr":0,"x":120,"y":280,"wires":[["cdbe34b2.cba798"]]},{"id":"cdbe34b2.cba798","type":"switch","z":"920d75bc.d0fe08","name":"Login Status","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"PINIBET_LOGIN_FAILED","vt":"str"},{"t":"eq","v":"PINIBET_LOGIN_SUCCESS","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":270,"y":280,"wires":[[],["c13b73f6.149d6"]]},{"id":"c13b73f6.149d6","type":"json","z":"920d75bc.d0fe08","name":"","property":"payload","action":"","pretty":false,"x":410,"y":280,"wires":[["b9586c09.6f68d"]]},{"id":"b9586c09.6f68d","type":"change","z":"920d75bc.d0fe08","name":"Set Sport Type","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.l","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":280,"wires":[["d91f4016.3edd8"]]},{"id":"d91f4016.3edd8","type":"split","z":"920d75bc.d0fe08","name":"For Each Sport","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":760,"y":320,"wires":[["c24617a8.c53918"]]},{"id":"c24617a8.c53918","type":"change","z":"920d75bc.d0fe08","name":"Set Event Sport","rules":[{"t":"set","p":"event.sport.name","pt":"msg","to":"$lowercase($trim(msg.payload[1]))","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"payload[2]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":940,"y":320,"wires":[["714fb8a8.698158"]]},{"id":"714fb8a8.698158","type":"split","z":"920d75bc.d0fe08","name":"For Each League","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1130,"y":320,"wires":[["160d99ab.eb8936"]]},{"id":"160d99ab.eb8936","type":"change","z":"920d75bc.d0fe08","name":"Set Event League","rules":[{"t":"set","p":"event.league.name","pt":"msg","to":"$lowercase($trim(payload[1]))","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"payload[2]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1330,"y":320,"wires":[["9ebf9371.4bb64"]]},{"id":"b4f7733a.fbab2","type":"split","z":"920d75bc.d0fe08","name":"For Each Event","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1700,"y":340,"wires":[["34ba41b9.00a3ae"]]},{"id":"34ba41b9.00a3ae","type":"change","z":"920d75bc.d0fe08","name":"Set Event name","rules":[{"t":"set","p":"event.name","pt":"msg","to":"$lowercase(msg.payload[1] & ' vs ' & msg.payload[2])","tot":"jsonata"},{"t":"set","p":"event.score","pt":"msg","to":"msg.payload[9][0] & ' - ' & msg.payload[9][1]","tot":"jsonata"},{"t":"set","p":"event.score_1","pt":"msg","to":"payload[9][0]","tot":"msg"},{"t":"set","p":"event.score_2","pt":"msg","to":"payload[9][1]","tot":"msg"},{"t":"set","p":"event.minute","pt":"msg","to":"$exists(msg.payload[15]) ? $not($contains($string(msg.payload[15]),\"null\")) ? $count(msg.payload)>16 ? $contains($trim(msg.payload[16]), \"2H\") ? $number($replace($trim($string(msg.payload[15])), \"'\", \"\")) + 45 : $number($replace($trim($string(msg.payload[15])), \"'\", \"\")) : null : null : null","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"payload[8]","tot":"msg"},{"t":"set","p":"odd","pt":"msg","to":"{}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1880,"y":340,"wires":[["46905c6c.ba1f94"]]},{"id":"fab3c7ae.148358","type":"split","z":"920d75bc.d0fe08","name":"For Each Event Period","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":2840,"y":340,"wires":[["1ed4c1a1.df339e"]]},{"id":"1ed4c1a1.df339e","type":"switch","z":"920d75bc.d0fe08","name":"Set Bet Window Time","property":"parts.index","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":3060,"y":340,"wires":[["12d1c6ff.208e89"],["4ca89c4.9c63264"]]},{"id":"57f3d996.310988","type":"split","z":"920d75bc.d0fe08","name":"For Each Odd Type","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":3410,"y":340,"wires":[["f9460e48.c51d2"]]},{"id":"12d1c6ff.208e89","type":"change","z":"920d75bc.d0fe08","name":"Full Time","rules":[{"t":"set","p":"odd.expires_on","pt":"msg","to":"Full Time","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3240,"y":300,"wires":[["57f3d996.310988"]]},{"id":"4ca89c4.9c63264","type":"change","z":"920d75bc.d0fe08","name":"1st Half","rules":[{"t":"set","p":"odd.expires_on","pt":"msg","to":"1st Half","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3240,"y":380,"wires":[["57f3d996.310988"]]},{"id":"f9460e48.c51d2","type":"switch","z":"920d75bc.d0fe08","name":"Odd Type Switch","property":"parts.index","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"2","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":3610,"y":340,"wires":[["b18809e1.0cd378"],["f3cdcfb3.c7a11"],["fce1a888.80ea48"]]},{"id":"b18809e1.0cd378","type":"change","z":"920d75bc.d0fe08","name":"Handicap","rules":[{"t":"set","p":"odd.type","pt":"msg","to":"Handicap","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3780,"y":300,"wires":[["85e1575a.1a6948"]]},{"id":"f3cdcfb3.c7a11","type":"change","z":"920d75bc.d0fe08","name":"Over/Under","rules":[{"t":"set","p":"odd.type","pt":"msg","to":"Over/Under","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3790,"y":340,"wires":[["85e1575a.1a6948"]]},{"id":"fce1a888.80ea48","type":"change","z":"920d75bc.d0fe08","name":"1x2","rules":[{"t":"set","p":"odd.type","pt":"msg","to":"1x2","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3770,"y":380,"wires":[["85e1575a.1a6948"]]},{"id":"fd9b9d37.061f","type":"split","z":"920d75bc.d0fe08","name":"For Each Odd","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":4100,"y":340,"wires":[["6e8d2d9e.49fa04"]]},{"id":"8c716ceb.9affe","type":"change","z":"920d75bc.d0fe08","name":"Package Odd","rules":[{"t":"set","p":"odd.run_line","pt":"msg","to":"$string($number(msg.payload[1])) & '/' & $string($number(msg.payload[0]))","tot":"jsonata"},{"t":"set","p":"odd.pinibet","pt":"msg","to":"{\t    \"id_1\" : msg.payload[7],\t    \"money_line_1\"  : $number(msg.payload[3]),\t    \"run_line_1\"  : $number(msg.payload[1]),\t\t    \"id_2\" : msg.payload[7],\t    \"money_line_2\"  : $number(msg.payload[4]),\t    \"run_line_2\"  : $number(msg.payload[0])\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":4460,"y":340,"wires":[["7491e2fb.0f7f9c"]]},{"id":"6e8d2d9e.49fa04","type":"switch","z":"920d75bc.d0fe08","name":"Only Valid Odd","property":"payload.length","propertyType":"msg","rules":[{"t":"eq","v":"9","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":4280,"y":340,"wires":[["8c716ceb.9affe"]]},{"id":"7491e2fb.0f7f9c","type":"change","z":"920d75bc.d0fe08","name":"Package Row","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t    \"event\": msg.event,\t    \"odd\": msg.odd\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":4640,"y":340,"wires":[["97bb2584.819318"]]},{"id":"357574e0.a4e85c","type":"change","z":"920d75bc.d0fe08","name":"Package Document","rules":[{"t":"set","p":"documentIndex","pt":"msg","to":"\"bets\" & \"-\" & $replace($split($now(), \"T\", 1) [0],\"-\",\".\")","tot":"jsonata"},{"t":"set","p":"documentType","pt":"msg","to":"doc","tot":"str"},{"t":"set","p":"documentId","pt":"msg","to":"$base64encode($lowercase(msg.payload.event.official & ';' & msg.payload.odd.type & ';' & msg.payload.odd.expires_on & ';' & msg.payload.odd.run_line))","tot":"jsonata"},{"t":"set","p":"payload.timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":4830,"y":300,"wires":[[]]},{"id":"1f36ae93.ac3f01","type":"change","z":"920d75bc.d0fe08","name":"Set Google keywords","rules":[{"t":"set","p":"data","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"google","pt":"msg","to":"{\t    \"q\" : $replace($lowercase(msg.event.name),\" \",\"+\"),\t    \"key\": \"google_session_test3\"\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2200,"y":340,"wires":[["8553c308.68b69"]]},{"id":"8553c308.68b69","type":"subflow:987d9c15.b3c5","z":"920d75bc.d0fe08","name":"","x":2400,"y":340,"wires":[["d45f16eb.25f3b8"]]},{"id":"d45f16eb.25f3b8","type":"change","z":"920d75bc.d0fe08","name":"Set Event Official name","rules":[{"t":"set","p":"payload","pt":"msg","to":"data","tot":"msg"},{"t":"set","p":"event.official","pt":"msg","to":"$count(msg.google.result)>0 ? $lowercase($trim(msg.google.result[0])) : $lowercase($trim(msg.event.name))","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2610,"y":340,"wires":[["fab3c7ae.148358"]]},{"id":"85e1575a.1a6948","type":"switch","z":"920d75bc.d0fe08","name":"Is Valid","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":3940,"y":340,"wires":[["fd9b9d37.061f"]]},{"id":"982e21d2.e9ce7","type":"subflow:920d75bc.d0fe08","z":"72706932.2ca048","name":"Site 3","x":890,"y":300,"wires":[["edaa37f9.b99ea8","db638d85.09fcd"]]},{"id":"25590db2.b2a722","type":"delay","z":"381da27a.bf1b8e","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":820,"y":220,"wires":[["20fb1a9c.949976"]]},{"id":"9ebf9371.4bb64","type":"switch","z":"920d75bc.d0fe08","name":"Valid League?","property":"event.league.name","propertyType":"msg","rules":[{"t":"cont","v":"CORNERS","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1520,"y":320,"wires":[[],["b4f7733a.fbab2"]]},{"id":"4c2d25c3.a769cc","type":"split","z":"8f12258d.a834d8","name":"For each account","splt":"\\n","x":676,"y":179.0000057220459,"wires":[["bfbc2fe8.7fbde"]]},{"id":"76864493.930f1c","type":"http request","z":"8f12258d.a834d8","name":"Get Facebook active campaigns","method":"GET","ret":"obj","url":"https://graph.facebook.com/v2.11/act_{{{payload.id}}}/campaigns/?fields=effective_status&filtering=[{'field':'effective_status','operator':'IN','value':['ACTIVE']}]&access_token={{{payload.access_token}}}","tls":"","x":1110,"y":180,"wires":[["cbd17d9d.b7716"]]},{"id":"5a9f403f.b12a4","type":"function","z":"7744a89.2e26458","name":"build params","func":"msg.params = {}\n\nmsg.params.Item = {\n    \"id\": msg.fb_account.id,\n    \"campaigns\" : msg.payload.data,\n    \"access_token\": msg.fb_account.access_token\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1530,"y":260,"wires":[["e42594b9.2bee28"]]},{"id":"bfbc2fe8.7fbde","type":"function","z":"8f12258d.a834d8","name":"build fb_account","func":"msg.fb_account = {\n    \"id\": msg.payload.id,\n    \"access_token\": msg.payload.access_token\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":180,"wires":[["76864493.930f1c"]]},{"id":"80a9f617.a69888","type":"http request","z":"8f12258d.a834d8","name":"Get Facebook insights","method":"GET","ret":"obj","url":"https://graph.facebook.com/v2.11/insights/?fields=impressions,campaign_id,campaign_name,adset_id,adset_name,ad_id,ad_name,spend,actions,action_values&date_preset=lifetime&level=ad&limit=10000&ids={{{campaign.id}}}&p=2&access_token={{{fb_account.access_token}}}","tls":"","x":2080,"y":180,"wires":[["19818e11.bed8e2"]]},{"id":"e42594b9.2bee28","type":"function","z":"7744a89.2e26458","name":"build campaigns","func":"msg.payload = msg.params.Item.campaigns;\n\ndelete msg.parts;\n\nreturn msg;","outputs":1,"noerr":0,"x":1700,"y":260,"wires":[[]]},{"id":"c0694fa4.fb584","type":"split","z":"8f12258d.a834d8","name":"","splt":"\\n","x":1399.0000267028809,"y":244.99999809265137,"wires":[["1c69567e.75732a"]]},{"id":"1c69567e.75732a","type":"function","z":"8f12258d.a834d8","name":"build campaign","func":"msg.campaign = {\n    \"id\": msg.payload.id,\n    \"account\" : {\n        \"id\" : msg.fb_account.id\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1481.0000686645508,"y":182.0000057220459,"wires":[["90bec8a7.3f5b48"]]},{"id":"298b6c9c.fce634","type":"function","z":"8f12258d.a834d8","name":"set timestamp","func":"/*var message = msg;\n\nmsg = {};\n\nmsg.refferal_message = message;\n//msg.params = {};\n*/\n\nmsg.timestamp = new Date().getTime();//msg.payload;\n\nglobal.set(\"threshold\",5);\nglobal.set(\"sc_weight\",0.9);\n\nreturn msg;","outputs":1,"noerr":0,"x":314.24999237060547,"y":180.25000095367432,"wires":[["da4376a7.6f9bc8"]]},{"id":"19818e11.bed8e2","type":"function","z":"8f12258d.a834d8","name":"Get campaign data","func":"msg.payload = msg.payload[msg.campaign.id].data;\n\nmsg.payload.forEach( function (ad){\n    for (var i = 0; i < msg.campaign.adsets.length; i++) {\n        if(ad.adset_id === msg.campaign.adsets[i].id){\n            \n            ad.adset_lifetime_budget = msg.campaign.adsets[i].lifetime_budget;\n            ad.adset_daily_budget = msg.campaign.adsets[i].daily_budget;\n            ad.adset_budget_remaining = msg.campaign.adsets[i].budget_remaining;\n\n        }\n    }\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":2290,"y":180,"wires":[["ac391b5.1ac6ce8"]]},{"id":"ac391b5.1ac6ce8","type":"join","z":"8f12258d.a834d8","name":"","mode":"auto","build":"merged","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","timeout":"","count":"","x":2450,"y":180,"wires":[["d8547a4f.4ac898"]]},{"id":"d8547a4f.4ac898","type":"function","z":"8f12258d.a834d8","name":"aggregate insights","func":"msg.ads = [];\nmsg.adsets = [];\nmsg.campaigns = [];\nmsg.account = {\n                \"account_id\" : msg.campaign.account.id,\n                \"pre_conversions\" : 0,\n                \"conversions\" : 0,\n                \"revenue\" : 0\n            };\n\nvar pre_conversion_actions = [\"offsite_conversion.fb_pixel_complete_registration\"];\nvar conversion_actions = [\"offsite_conversion.fb_pixel_purchase\"];\nvar revenue_actions = [\"offsite_conversion.fb_pixel_search\"];\n\nfor (var i = 0; i < msg.payload.length; i++) {\n    for (var j = 0; j < msg.payload[i].length; j++) {\n        \n        var actions = [];\n        var action_values = [];\n        \n        if(msg.payload[i][j].actions!==undefined) actions = msg.payload[i][j].actions;\n        if(msg.payload[i][j].action_values!==undefined) action_values = msg.payload[i][j].action_values;\n        \n        var ad = msg.payload[i][j];\n            \n        ad.pre_conversions = 0;\n        ad.conversions = 0;\n        ad.revenue = 0;\n        \n        actions.forEach( function (arrayItem)\n        {\n            if(pre_conversion_actions.indexOf(arrayItem.action_type)>=0 ){\n                ad.pre_conversions = ad.pre_conversions + parseInt(arrayItem.value);\n            }\n            \n            if(conversion_actions.indexOf(arrayItem.action_type)>=0 ){\n                ad.conversions = ad.conversions + parseInt(arrayItem.value);\n            }\n            \n        });\n        \n        action_values.forEach( function (arrayItem)\n        {\n            if(revenue_actions.indexOf(arrayItem.action_type)>=0 ){\n                ad.revenue = ad.revenue + parseInt(arrayItem.value);\n            }\n        });\n        \n        var adset = null;\n        \n        msg.adsets.forEach( function (obj){\n            try{\n                if (obj.adset_id == ad.adset_id){\n                    adset = obj;\n                }\n            }\n            catch(e){}\n        });\n        \n        if(adset===null){\n            msg.adsets.push({\n                \"adset_id\" : ad.adset_id,\n                \"pre_conversions\" : ad.pre_conversions,\n                \"conversions\" : ad.conversions,\n                \"revenue\" : ad.revenue,\n                \"lifetime_budget\" : msg.payload[i].lifetime_budget,\n                \"daily_budget\" : msg.payload[i].daily_budget,\n                \"budget_remaining\" : msg.payload[i].budget_remaining\n            });\n        }\n        else{\n            adset.pre_conversions = ad.pre_conversions + adset.pre_conversions;\n            adset.conversions = ad.conversions + adset.conversions;\n            adset.revenue = ad.revenue + adset.revenue;\n        }\n        \n        var campaign = null;\n        \n        msg.campaigns.forEach( function (obj){\n            try{\n                if (obj.campaign_id == ad.campaign_id){\n                    campaign = obj;\n                }\n            }\n            catch(e){}\n        });\n        \n        if(campaign===null){\n            msg.campaigns.push({\n                \"campaign_id\" : ad.campaign_id,\n                \"pre_conversions\" : ad.pre_conversions,\n                \"conversions\" : ad.conversions,\n                \"revenue\" : ad.revenue\n            });\n        }\n        else{\n            campaign.pre_conversions = ad.pre_conversions + campaign.pre_conversions;\n            campaign.conversions = ad.conversions + campaign.conversions;\n            campaign.revenue = ad.revenue + campaign.revenue;\n        }\n        \n        \n        msg.account.pre_conversions = ad.pre_conversions + msg.account.pre_conversions;\n        msg.account.conversions = ad.conversions + msg.account.conversions;\n        msg.account.revenue = ad.revenue + msg.account.revenue;\n        \n        \n        msg.ads.push(ad);\n        \n    }\n}\n\nmsg.payload = msg.ads;\n\nreturn msg;","outputs":1,"noerr":0,"x":2610,"y":180,"wires":[["51943b06.809eb4"]]},{"id":"51943b06.809eb4","type":"split","z":"8f12258d.a834d8","name":"","splt":"\\n","x":2770,"y":180,"wires":[["f27b9ece.423a6"]]},{"id":"f27b9ece.423a6","type":"function","z":"8f12258d.a834d8","name":"ad all hierarchy insights","func":"var ad = msg.payload;\n\nmsg.adsets.forEach( function (adset){\n    if (adset.adset_id == ad.adset_id){\n        ad.adset = adset;\n    }\n});\n\nmsg.campaigns.forEach( function (campaign){\n    if (campaign.campaign_id == ad.campaign_id){\n        ad.campaign = campaign;\n    }\n});\n\nad.account = msg.account;\n\nreturn msg;","outputs":1,"noerr":0,"x":2950,"y":180,"wires":[["3e88fcb9.d89ac4"]]},{"id":"3e88fcb9.d89ac4","type":"function","z":"8f12258d.a834d8","name":"calc SCVal","func":"var ad = msg.payload;\n\nvar threshold = global.get(\"threshold\");\nvar sc_weight = global.get(\"sc_weight\");\n\nPad = Math.min(ad.conversions/threshold,1);\nRad = (ad.revenue/ad.pre_conversions);\nPadset = Math.min(ad.adset.conversions/threshold,1);\nRadset = (ad.adset.revenue/ad.adset.pre_conversions);\nCalcPadset = (Math.max(1-Pad,0)*Padset);\nPcampaign = Math.min(ad.campaign.conversions/threshold,1);\nRcampaign = (ad.campaign.revenue/ad.campaign.pre_conversions);\nPaccount = Math.min(ad.account.conversions/threshold,1);\nRaccount = (ad.account.revenue/ad.account.pre_conversions);\n\n/*SCVal = (Pad*Rad) + \n(CalcPadset*Radset) + \n((Math.max(1-Padset-CalcPadset,0)*Pcampaign)*Rcampaign) + \n((Math.max(1 - Padset -(Padset-CalcPadset)-(Math.max(1-Padset-CalcPadset,0)),0)*Paccount)*Raccount);\n*/\n\n/*=(B2*B3) + \n((Max(1-B2,0)*B4)*B5) + \n((Max(1-B2-((Max(1-B2,0)*B4)),0)*B6)*B7) + \n((Max(1-B2 -(B4-((Max(1-B2,0)*B4)))-(Max((Max(1-B2,0)*B4),0)),0)*B8)*B9)\n*/\n\n/*msg.debug = {\n    part1 : (Pad*Rad),\n    part2 : ((Math.max(1-Pad,0)*Padset)*Radset),\n    part3 : ((Math.max(1-Padset-((Max(1-Pad,0)*Padset)),0)*Pcampaign)*Rcampaign),\n    part4 : ((Math.max(1-Padset -(Padset-CalcPadset)-(Math.max(1-Padset-CalcPadset,0)),0)*Paccount)*Raccount)\n}*/\n\nad.Pad = isNaN(Pad) ? 0 : Pad;\nad.Rad = isNaN(Rad) ? 0 : Rad;\nad.Padset = isNaN(Padset) ? 0 : Padset;\nad.Radset = isNaN(Radset) ? 0 : Radset;\nad.Pcampaign = isNaN(Pcampaign) ? 0 : Pcampaign;\nad.Rcampaign = isNaN(Rcampaign) ? 0 : Rcampaign;\nad.Paccount = isNaN(Paccount) ? 0 : Paccount;\nad.Raccount = isNaN(Raccount) ? 0 : Raccount;\n\n\nad.debug = {\n    part1 : (ad.Pad*ad.Rad),\n    part2 : ((Math.max(1-ad.Pad,0)*ad.Padset)*ad.Radset),\n    part3 : ((Math.max(1-ad.Pad-((Math.max(1-ad.Pad,0)*ad.Padset)),0)*ad.Pcampaign)*ad.Rcampaign),\n    part4 : ((Math.max(1-ad.Pad -(ad.Padset-((Math.max(1-ad.Pad,0)*ad.Padset)))-(Math.max((Math.max(1-ad.Pad,0)*ad.Padset),0)),0)*ad.Paccount)*ad.Raccount)\n}\n\nSCVal = (ad.Pad*ad.Rad) +\n((Math.max(1-ad.Pad,0)*ad.Padset)*ad.Radset) +\n((Math.max(1-ad.Pad-((Math.max(1-ad.Pad,0)*ad.Padset)),0)*ad.Pcampaign)*ad.Rcampaign) + \n((Math.max(1-ad.Pad -(ad.Padset-((Math.max(1-ad.Pad,0)*ad.Padset)))-(Math.max((Math.max(1-ad.Pad,0)*ad.Padset),0)),0)*ad.Paccount)*ad.Raccount)\n\nad.SCVal = isNaN(SCVal) ? 0 : SCVal;\n\nVRevN = (SCVal * ad.pre_conversions * sc_weight) + ((1-sc_weight) * ad.revenue);\nad.VRevN = isNaN(VRevN) ? 0 : VRevN;\n\nad.timestamp = msg.timestamp;\n\nmsg.params = {\n    \"Item\" : ad\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":3150,"y":180,"wires":[["bd26c61.d037738"]]},{"id":"60be90e2.97fe7","type":"http in","z":"7744a89.2e26458","name":"","url":"/sippycup/ads/fetch","method":"get","swaggerDoc":"","x":150.49999618530273,"y":649.2500114440918,"wires":[["9d5bce75.efdb"]]},{"id":"111bc642.18056a","type":"http response","z":"7744a89.2e26458","name":"","x":3100.7500343322754,"y":293.5,"wires":[]},{"id":"3ac1271c.242c08","type":"function","z":"7744a89.2e26458","name":"set payload with params.Item","func":"msg.payload = msg.params.Item;\n\nreturn msg;","outputs":1,"noerr":0,"x":955.5000076293945,"y":514.0000057220459,"wires":[["c28da6a3.3340f8"]]},{"id":"ae0d6d7c.3056c","type":"debug","z":"7744a89.2e26458","name":"","active":true,"console":"false","complete":"payload","x":587,"y":1096.7500133514404,"wires":[]},{"id":"ab2caa7c.d750f8","type":"change","z":"87f0e773.22b928","name":"","rules":[{"t":"set","p":"action","pt":"msg","to":"restore","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":589.5,"y":53,"wires":[[]]},{"id":"a2757617.757038","type":"json","z":"87f0e773.22b928","name":"","x":175.5,"y":85,"wires":[["ab2caa7c.d750f8"]]},{"id":"70930308.436aac","type":"catch","z":"87f0e773.22b928","name":"","scope":["a2757617.757038"],"x":183.5,"y":117,"wires":[["edbcee33.12519"]]},{"id":"edbcee33.12519","type":"change","z":"87f0e773.22b928","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"[]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":354.5,"y":116,"wires":[["ab2caa7c.d750f8"]]},{"id":"9a388e3d.aeb97","type":"inject","z":"87f0e773.22b928","name":"Trigger restore","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":618.5,"y":169,"wires":[[]]},{"id":"cc93258a.06d618","type":"function","z":"d2bdb924.a3fc88","name":"call ebay api","func":"msg.timestamp = new Date().getTime()\n\nvar ebay = global.get('ebayapi')\n\nmsg.payload.parser = ebay.parseResponseJson\n\nebay.xmlRequest(msg.payload,\n  // gets all the items together in a merged array\n    function itemsCallback(error, itemsResponse) {\n        //global.set(\"ebay_response_\" + msg.timestamp,itemsResponse)\n    if (error) {\n        console.log(error);\n        global.set(\"ebay_response_\" + msg.timestamp,error)\n    }\n    else{\n        console.log(itemsResponse)\n        global.set(\"ebay_response_\" + msg.timestamp,itemsResponse)\n    }\n  }\n);\n\nreturn msg;","outputs":1,"noerr":0,"x":305,"y":169,"wires":[["bd64769a.9e94d8"]]},{"id":"bd64769a.9e94d8","type":"delay","z":"d2bdb924.a3fc88","name":"","pauseType":"delay","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":486.5,"y":169,"wires":[["c31e115c.15a15"]]},{"id":"c31e115c.15a15","type":"function","z":"d2bdb924.a3fc88","name":"set payload","func":"msg.payload = global.get(\"ebay_response_\" + msg.timestamp)\n\nreturn msg;","outputs":1,"noerr":0,"x":586.5,"y":93,"wires":[[]]},{"id":"edd9e9f8.8519b8","type":"debug","z":"d2bdb924.a3fc88","name":"","active":true,"console":"false","complete":"false","x":704.5,"y":34,"wires":[]},{"id":"9b6c3b8c.b15c88","type":"json","z":"d2bdb924.a3fc88","name":"","x":111.5,"y":168,"wires":[["f5e91c47.9244b"]]},{"id":"f5e91c47.9244b","type":"json","z":"d2bdb924.a3fc88","name":"","x":171.5,"y":220,"wires":[["cc93258a.06d618"]]},{"id":"d52c5564.705d78","type":"function","z":"49f6e78f.a91848","name":"call ebay api","func":"var ebay = global.get('ebayapi')\nmsg.topic = \"\"\n\nmsg.payload.parser = ebay.parseResponseJson\n\nebay.xmlRequest(msg.payload,\n  // gets all the items together in a merged array\n    function itemsCallback(error, itemsResponse) {\n        msg.topic = msg.payload.opType\n        msg.payload = itemsResponse\n        msg.payload.error = error\n        node.send(msg)\n    }\n);\n","outputs":1,"noerr":0,"x":491.4285774230957,"y":127.14287185668945,"wires":[[]]},{"id":"456e4dfd.276fc4","type":"json","z":"49f6e78f.a91848","name":"","x":175.07143783569336,"y":124.71428871154785,"wires":[["2fd1a17b.bb010e"]]},{"id":"2fd1a17b.bb010e","type":"json","z":"49f6e78f.a91848","name":"","x":326.5,"y":126.71426582336426,"wires":[["d52c5564.705d78"]]},{"id":"c28da6a3.3340f8","type":"function","z":"7744a89.2e26458","name":"set default values","func":"msg.payload = msg.params.Item;\nmsg.db_payload = msg.payload\n\nmsg.db_payload.impressions===undefined ? 0 : msg.db_payload.impressions\nmsg.db_payload.campaign_id===undefined ? \"\" : msg.db_payload.campaign_id\nmsg.db_payload.campaign_name===undefined ? \"\" : msg.db_payload.campaign_name\nmsg.db_payload.adset_id===undefined ? \"\" : msg.db_payload.adset_id\nmsg.db_payload.adset_name===undefined ? \"\" : msg.db_payload.adset_name\nmsg.db_payload.ad_id===undefined ? \"\" : msg.db_payload.ad_id\nmsg.db_payload.ad_name===undefined ? \"\" : msg.db_payload.ad_name\nmsg.db_payload.spend===undefined ? 0 : msg.db_payload.spend\nmsg.db_payload.date_start===undefined ? \"\" : msg.db_payload.date_start\nmsg.db_payload.date_stop===undefined ? \"\" : msg.db_payload.date_stop\nmsg.db_payload.pre_conversions===undefined ? 0 : msg.db_payload.pre_conversions\nmsg.db_payload.conversions===undefined ? 0 : msg.db_payload.conversions\nmsg.db_payload.revenue===undefined ? 0 : msg.db_payload.revenue\nmsg.db_payload.adset.adset_id===undefined ? \"\" : msg.db_payload.adset.adset_id\nmsg.db_payload.adset.pre_conversions===undefined ? 0 : msg.db_payload.adset.pre_conversions\nmsg.db_payload.adset.conversions===undefined ? 0 : msg.db_payload.adset.conversions\nmsg.db_payload.adset.revenue===undefined ? 0 : msg.db_payload.adset.revenue\nmsg.db_payload.campaign.pre_conversions===undefined ? 0 : msg.db_payload.campaign.pre_conversions\nmsg.db_payload.campaign.conversions===undefined ? 0 : msg.db_payload.campaign.conversions\nmsg.db_payload.campaign.revenue===undefined ? 0 : msg.db_payload.campaign.revenue\nmsg.db_payload.account.account_id===undefined ? 0 : msg.db_payload.account.account_id\nmsg.db_payload.account.pre_conversions===undefined ? 0 : msg.db_payload.account.pre_conversions\nmsg.db_payload.account.conversions===undefined ? 0 : msg.db_payload.account.conversions\nmsg.db_payload.account.revenue===undefined ? 0 : msg.db_payload.account.revenue\nmsg.db_payload.Pad===undefined ? 0 : msg.db_payload.Pad\nmsg.db_payload.Rad===undefined ? 0 : msg.db_payload.Rad\nmsg.db_payload.Padset===undefined ? 0 : msg.db_payload.Padset\nmsg.db_payload.Radset===undefined ? 0 : msg.db_payload.Radset\nmsg.db_payload.Pcampaign===undefined ? 0 : msg.db_payload.Pcampaign\nmsg.db_payload.Rcampaign===undefined ? 0 : msg.db_payload.Rcampaign\nmsg.db_payload.Paccount===undefined ? 0 : msg.db_payload.Paccount\nmsg.db_payload.Raccount===undefined ? 0 : msg.db_payload.Raccount\nmsg.db_payload.debug.part1===undefined ? 0 : msg.db_payload.debug.part1\nmsg.db_payload.debug.part2===undefined ? 0 : msg.db_payload.debug.part2\nmsg.db_payload.debug.part3===undefined ? 0 : msg.db_payload.debug.part3\nmsg.db_payload.debug.part4===undefined ? 0 : msg.db_payload.debug.part4\nmsg.db_payload.SCVal===undefined ? 0 : msg.db_payload.SCVal\nmsg.db_payload.VRevN===undefined ? 0 : msg.db_payload.VRevN\nmsg.db_payload.timestamp===undefined ? 0 : msg.db_payload.timestamp\nmsg.db_payload.adset_lifetime_budget===undefined ? 0 : msg.db_payload.adset_lifetime_budget\nmsg.db_payload.adset_daily_budget===undefined ? 0 : msg.db_payload.adset_daily_budget\n\nreturn msg;","outputs":1,"noerr":0,"x":1229.625015258789,"y":435.5000057220459,"wires":[["3542c3a2.eaa57c"]]},{"id":"3542c3a2.eaa57c","type":"template","z":"7744a89.2e26458","name":"insert incremental_ad_data","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"(\n  {{db_payload.impressions}},\n  '{{db_payload.campaign_id}}',\n  '{{db_payload.campaign_name}}',\n  '{{db_payload.adset_id}}',\n  '{{db_payload.adset_name}}',\n  '{{db_payload.ad_id}}',\n  '{{db_payload.ad_name}}',\n  {{db_payload.spend}},\n  '{{db_payload.date_start}}',\n  '{{db_payload.date_stop}}',\n  {{db_payload.pre_conversions}},\n  {{db_payload.conversions}},\n  {{db_payload.revenue}},\n  '{{db_payload.adset.adset_id}}',\n  {{db_payload.adset.pre_conversions}},\n  {{db_payload.adset.conversions}},\n  {{db_payload.adset.revenue}},\n  {{db_payload.campaign.pre_conversions}},\n  {{db_payload.campaign.conversions}},\n  {{db_payload.campaign.revenue}},\n  '1381220405489176',\n  {{db_payload.account.pre_conversions}},\n  {{db_payload.account.conversions}},\n  {{db_payload.account.revenue}},\n  {{db_payload.Pad}},\n  {{db_payload.Rad}},\n  {{db_payload.Padset}},\n  {{db_payload.Radset}},\n  {{db_payload.Pcampaign}},\n  {{db_payload.Rcampaign}},\n  {{db_payload.Paccount}},\n  {{db_payload.Raccount}},\n  {{db_payload.debug.part1}},\n  {{db_payload.debug.part2}},\n  {{db_payload.debug.part3}},\n  {{db_payload.debug.part4}},\n  {{db_payload.SCVal}},\n  {{db_payload.VRevN}},\n  {{db_payload.timestamp}},\n  {{db_payload.adset_lifetime_budget}},\n  {{db_payload.adset_daily_budget}}\n)","x":1525.250015258789,"y":419.25000381469727,"wires":[["cad442b2.ac6be"]]},{"id":"cad442b2.ac6be","type":"join","z":"7744a89.2e26458","name":"","mode":"custom","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":",","timeout":"","count":"","x":1659.625015258789,"y":471.75000762939453,"wires":[["f12a1235.b6733"]]},{"id":"f12a1235.b6733","type":"template","z":"7744a89.2e26458","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO sippycup.incremental_ad_data\n(\n  impressions,\n  campaign_id,\n  campaign_name,\n  adset_id,\n  adset_name,\n  ad_id,\n  ad_name,\n  spend,\n  date_start,\n  date_stop,\n  pre_conversions,\n  conversions,\n  revenue,\n  adset_adset_id,\n  adset_pre_conversions,\n  adset_conversions,\n  adset_revenue,\n  campaign_pre_conversions,\n  campaign_conversions,\n  campaign_revenue,\n  account_id,\n  account_pre_conversions,\n  account_conversions,\n  account_revenue,\n  pad,\n  rad,\n  padset,\n  radset,\n  pcampaign,\n  rcampaign,\n  paccount,\n  raccount,\n  debug_part1,\n  debug_part2,\n  debug_part3,\n  debug_part4,\n  scval,\n  vrev,\n  TIMESTAMP,\n  adset_lifetime_budget,\n  adset_daily_budget\n)\nVALUES {{payload}};","x":1738.375015258789,"y":414.25000953674316,"wires":[["5c5935c7.9affdc"]]},{"id":"5c5935c7.9affdc","type":"function","z":"7744a89.2e26458","name":"","func":"msg.payload = msg.payload.replace(/&#39;/g,\"'\")\n\nreturn msg;","outputs":1,"noerr":0,"x":1860.8750267028809,"y":415.50000381469727,"wires":[["8e4eaf2c.aabab"]]},{"id":"e5973112.42921","type":"template","z":"7744a89.2e26458","name":"insert adset_inc_cf","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"insert into sippycup.adset_inc_cf\nselect  account_id,\n        campaign_id,\n        adset_id,\n        max(last_7_days_acc_spend)last_7_days_acc_spend,\n        sum(lifetime_spend) lifetime_spend,\n        sum(previous_spend) previous_spend,\n        sum(delta_spend) delta_spend,\n        sum(lifetime_pre_conversions) lifetime_pre_conversions,\n        sum(previous_pre_conversions) previous_pre_conversions,\n        sum(delta_pre_conversions) delta_pre_conversions,\n        max(last_7_days_acc_pre_conversions) last_7_days_acc_pre_conversions,\n        sum(lifetime_revenue) lifetime_revenue,\n        sum(delta_revenue) delta_revenue,\n        sum(lifetime_conversions) lifetime_conversions,\n        sum(delta_conversions) delta_conversions,\n        sum(SCVal) lifetime_SCVal,\n        sum(VRev_ad_inc) VRev_adset_inc,\n        sum(pre_conversion_cpa) pre_conversion_cpa,\n        0.6 target_roi,\n        ((case when sum(delta_spend)>0 then sum(VRev_ad_inc) else 0 end)/(case when sum(delta_spend)>0 then sum(delta_spend) else 1 end)/0.6) CF_inc,\n        timestamp,\n        previous_timestamp,\n        is_valid\nfrom (\nselect *,(VRev_ratio*delta_pre_conversions*SCVal) + (delta_revenue*(1-VRev_ratio)) VRev_ad_inc\nfrom (\nselect *,(case when ((-0.003*delta_spend) + 0.9)<0.3 then 0.3 else ((-0.003*delta_spend) + 0.9) end) VRev_ratio\nfrom (\n\nselect \n      account_id,\n      campaign_id,\n      adset_id,\n      ad_id,\n      last_7_days_acc_spend,\n      current_spend lifetime_spend,\n      previous_spend,\n      current_spend - previous_spend delta_spend ,\n      current_pre_conversions lifetime_pre_conversions,\n      previous_pre_conversions,\n      current_pre_conversions-previous_pre_conversions delta_pre_conversions,\n      last_7_days_acc_pre_conversions,\n      current_revenue lifetime_revenue,\n      current_revenue - previous_revenue delta_revenue, \n      current_conversions lifetime_conversions,\n      current_conversions - previous_conversions delta_conversions,\n      current_SCVal SCVal,\n      timestamp,\n      previous_timestamp,\n      is_valid,\n      pre_conversion_cpa\nfrom (\nselect current_data.account_id,\n        current_data.campaign_id,\n        current_data.adset_id,\n        current_data.ad_id,\n        last_7_days_acc_spend,\n        last_7_days_acc_pre_conversions,\n        current_data.spend - previous_data.spend delta_spend,\n        current_data.spend current_spend,\n        current_data.pre_conversions current_pre_conversions,\n        current_data.revenue current_revenue,\n        current_data.conversions current_conversions,\n        current_data.SCVal current_SCVal,\n        previous_data.spend previous_spend,\n        previous_data.pre_conversions previous_pre_conversions,\n        previous_data.revenue previous_revenue,\n        previous_data.conversions previous_conversions,\n        previous_data.SCVal previous_SCVal,\n        previous_data.rnk previous_version,\n        row_number() over(partition by current_data.account_id,current_data.campaign_id,current_data.adset_id,current_data.ad_id order by previous_data.rnk asc ) rnk,\n        current_data.timestamp,\n        previous_data.timestamp previous_timestamp,\n        (case when last_7_days_acc_pre_conversions>0 then last_7_days_acc_data.last_7_days_acc_spend else 0 end)/(case when last_7_days_acc_pre_conversions>0 then last_7_days_acc_pre_conversions else 1 end) pre_conversion_cpa,\n      case when (current_data.spend - previous_data.spend) > (((case when last_7_days_acc_pre_conversions>0 then last_7_days_acc_data.last_7_days_acc_spend else 0 end)/(case when last_7_days_acc_pre_conversions>0 then last_7_days_acc_pre_conversions else 1 end))*5) then true else false end is_valid\nfrom (\n            select account_id,campaign_id,adset_id,ad_id,spend,pre_conversions,revenue,conversions,SCVal,timestamp\n            from sippycup.incremental_ad_data\n            where timestamp={{timestamp}}) current_data\nleft join (\n            select account_id,campaign_id,adset_id,ad_id,spend,pre_conversions,revenue,conversions,SCVal,rnk,timestamp\n            from (\n            select incremental_ad_data.*,row_number() over(partition by incremental_ad_data.campaign_id,incremental_ad_data.adset_id,incremental_ad_data.ad_id \n                                                            order by \n                                                            (case when COALESCE(adset_inc_cf.is_valid,false) = true then 1 else -1 end) * incremental_ad_data.timestamp desc) rnk\n            from sippycup.incremental_ad_data\n            left join sippycup.adset_inc_cf\n              on incremental_ad_data.adset_id = adset_inc_cf.adset_id and\n                 incremental_ad_data.campaign_id = adset_inc_cf.campaign_id and\n                 incremental_ad_data.account_id = adset_inc_cf.account_id\n            where incremental_ad_data.timestamp<{{timestamp}}) a\n            where rnk =1) previous_data\non current_data.ad_id = previous_data.ad_id and\n   current_data.adset_id = previous_data.adset_id and\n   current_data.campaign_id = previous_data.campaign_id and\n   current_data.account_id = previous_data.account_id\nleft join (\n            select account_id,sum(max_last_7_days_acc_spend-min_last_7_days_acc_spend) last_7_days_acc_spend,sum(max_last_7_days_acc_pre_conversions-min_last_7_days_acc_pre_conversions) last_7_days_acc_pre_conversions\n            from (\n              select account_id,ad_id,min(spend) min_last_7_days_acc_spend,max(spend) max_last_7_days_acc_spend,\n                                      min(pre_conversions) min_last_7_days_acc_pre_conversions,max(pre_conversions) max_last_7_days_acc_pre_conversions\n              from sippycup.incremental_ad_data\n              where DATE_PART('hour', (current_TIMESTAMP) - (TIMESTAMP 'epoch' + (incremental_ad_data.timestamp/1000) * INTERVAL '1 second'))<=(7*24)\n              group by account_id,ad_id\n              ) last_7_days_acc_data\n            group by account_id\n          ) last_7_days_acc_data\non last_7_days_acc_data.account_id = current_data.account_id) a\n--where rnk=1\n\n\n\n) current_data\n/*where spend>0*/) a\n/*inner join (select distinct account_id,adset_id, ad_id\nfrom sippycup.incremental_ad_data) adsets\non a.ad_id = adsets.ad_id and a.account_id = adsets.account_id*/) b\ngroup by account_id,campaign_id,adset_id,timestamp,previous_timestamp,is_valid\norder by account_id,campaign_id,adset_id,timestamp,previous_timestamp,is_valid\n","x":2085.2500228881836,"y":420.5000057220459,"wires":[["98dd08db.5bd1b8","a95806d1.943928"]]},{"id":"99eb4a6c.0ff468","type":"inject","z":"7744a89.2e26458","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":143.37499237060547,"y":978.0000057220459,"wires":[["38e5a364.60e98c"]]},{"id":"98dd08db.5bd1b8","type":"function","z":"7744a89.2e26458","name":"","func":"var pg = global.get('pg');\n \n// create a config to configure both pooling behavior \n// and client options \n// note: all config is optional and the environment variables \n// will be read if the config is not present \nvar config = {\n  user: 'root', //env var: PGUSER \n  database: 'sippycup', //env var: PGDATABASE \n  password: 'lioran020', //env var: PGPASSWORD \n  host: 'sippycup.c8wilxdbvlmp.us-east-1.rds.amazonaws.com', // Server hosting the postgres database \n  port: 5432, //env var: PGPORT \n  max: 10, // max number of clients in the pool \n  idleTimeoutMillis: 30000, // how long a client is allowed to remain idle before being closed \n};\n \n//this initializes a connection pool \n//it will keep idle connections open for 30 seconds \n//and set a limit of maximum 10 idle clients \nvar pool = new pg.Pool(config);\n \n// to run a query we can acquire a client from the pool, \n// run a query on the client, and then return the client to the pool \npool.connect(function(err, client, done) {\n    node.warn('connecting to pg')\n  if(err) {\n    return node.warn('error fetching client from pool', err);\n  }\n  client.query(msg.payload, function(err, result) {\n    //call `done(err)` to release the client back to the pool (or destroy it if there is an error) \n    done(err);\n    node.warn('done')\n    if(err) {\n      return node.error('error running query : ' + err);\n    }\n    \n    node.warn(result)\n    msg.payload = result\n    msg.topic = \"save-inc-cf\"\n    node.warn('sending message')\n    node.send(msg)\n    //node.warn(result.rows[0].number);\n    //output: 1 \n  });\n});\n \npool.on('error', function (err, client) {\n  // if an error is encountered by a client while it sits idle in the pool \n  // the pool itself will emit an error event with both the error and \n  // the client which emitted the original error \n  // this is a rare occurrence but can happen if there is a network partition \n  // between your application and the database, the database restarts, etc. \n  // and so you might want to handle it and at least log it out \n  node.error('idle client error', err.message, err.stack)\n})","outputs":1,"noerr":0,"x":2264.000030517578,"y":420.50000381469727,"wires":[["d05994d7.668508","6843834b.6ee7bc"]]},{"id":"8e4eaf2c.aabab","type":"function","z":"7744a89.2e26458","name":"","func":"var pg = global.get('pg');\n \n// create a config to configure both pooling behavior \n// and client options \n// note: all config is optional and the environment variables \n// will be read if the config is not present \nvar config = {\n  user: 'root', //env var: PGUSER \n  database: 'sippycup', //env var: PGDATABASE \n  password: 'lioran020', //env var: PGPASSWORD \n  host: 'sippycup.c8wilxdbvlmp.us-east-1.rds.amazonaws.com', // Server hosting the postgres database \n  port: 5432, //env var: PGPORT \n  max: 10, // max number of clients in the pool \n  idleTimeoutMillis: 30000, // how long a client is allowed to remain idle before being closed \n};\n \n//this initializes a connection pool \n//it will keep idle connections open for 30 seconds \n//and set a limit of maximum 10 idle clients \nvar pool = new pg.Pool(config);\n \n// to run a query we can acquire a client from the pool, \n// run a query on the client, and then return the client to the pool \npool.connect(function(err, client, done) {\n    node.warn('connecting to pg')\n  if(err) {\n    return node.warn('error fetching client from pool', err);\n  }\n  client.query(msg.payload, function(err, result) {\n    //call `done(err)` to release the client back to the pool (or destroy it if there is an error) \n    done(err);\n    node.warn('done')\n    if(err) {\n      return node.error('error running query', err);\n    }\n    \n    node.warn(result)\n    msg.payload = result\n    msg.payload.timestamp = msg.timestamp\n    msg.topic = \"save-inc-data\"\n    node.warn('sending message')\n    node.send(msg)\n    //node.warn(result.rows[0].number);\n    //output: 1 \n  });\n});\n \npool.on('error', function (err, client) {\n  // if an error is encountered by a client while it sits idle in the pool \n  // the pool itself will emit an error event with both the error and \n  // the client which emitted the original error \n  // this is a rare occurrence but can happen if there is a network partition \n  // between your application and the database, the database restarts, etc. \n  // and so you might want to handle it and at least log it out \n  node.error('idle client error', err.message, err.stack)\n})","outputs":1,"noerr":0,"x":1909.0000190734863,"y":543.0000066757202,"wires":[["baca4e86.d8d71"]]},{"id":"baca4e86.d8d71","type":"switch","z":"7744a89.2e26458","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"save-inc-data","vt":"str"}],"checkall":"true","outputs":1,"x":2009.6250228881836,"y":686.7500057220459,"wires":[["d2d5c084.2f3f4"]]},{"id":"d05994d7.668508","type":"debug","z":"7744a89.2e26458","name":"","active":true,"console":"false","complete":"true","x":2384.625,"y":530.5,"wires":[]},{"id":"a95806d1.943928","type":"debug","z":"7744a89.2e26458","name":"","active":false,"console":"false","complete":"true","x":2249.625026702881,"y":640.5000076293945,"wires":[]},{"id":"9d5bce75.efdb","type":"change","z":"7744a89.2e26458","name":"is http","rules":[{"t":"set","p":"is_http","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":207.12499618530273,"y":595.5000057220459,"wires":[["e035feb8.0f1c8"]]},{"id":"d063ccbb.eab3b","type":"switch","z":"7744a89.2e26458","name":"","property":"is_http","propertyType":"msg","rules":[{"t":"neq","v":"undefined","vt":"jsonata"},{"t":"else"}],"checkall":"true","outputs":2,"x":3004.6250343322754,"y":413.00000190734863,"wires":[["111bc642.18056a"],[]]},{"id":"9e6512e1.544e2","type":"function","z":"7744a89.2e26458","name":"","func":"var pg = global.get('pg');\n \n// create a config to configure both pooling behavior \n// and client options \n// note: all config is optional and the environment variables \n// will be read if the config is not present \nvar config = {\n  user: 'root', //env var: PGUSER \n  database: 'sippycup', //env var: PGDATABASE \n  password: 'lioran020', //env var: PGPASSWORD \n  host: 'sippycup.c8wilxdbvlmp.us-east-1.rds.amazonaws.com', // Server hosting the postgres database \n  port: 5432, //env var: PGPORT \n  max: 10, // max number of clients in the pool \n  idleTimeoutMillis: 30000, // how long a client is allowed to remain idle before being closed \n};\n \n//this initializes a connection pool \n//it will keep idle connections open for 30 seconds \n//and set a limit of maximum 10 idle clients \nvar pool = new pg.Pool(config);\n \n// to run a query we can acquire a client from the pool, \n// run a query on the client, and then return the client to the pool \npool.connect(function(err, client, done) {\n    //node.warn('connecting to pg')\n  if(err) {\n    return node.warn('error fetching client from pool', err);\n  }\n  client.query(msg.payload, function(err, result) {\n    //call `done(err)` to release the client back to the pool (or destroy it if there is an error) \n    done(err);\n    //node.warn('done')\n    if(err) {\n      return node.error('error running query : ' + err);\n    }\n    \n    //node.warn(result)\n    msg.payload = result.rows\n    msg.topic = \"get-inc-cf\"\n    //node.warn('sending message')\n    node.send(msg)\n    //node.warn(result.rows[0].number);\n    //output: 1 \n  });\n});\n \npool.on('error', function (err, client) {\n  // if an error is encountered by a client while it sits idle in the pool \n  // the pool itself will emit an error event with both the error and \n  // the client which emitted the original error \n  // this is a rare occurrence but can happen if there is a network partition \n  // between your application and the database, the database restarts, etc. \n  // and so you might want to handle it and at least log it out \n  node.error('idle client error', err.message, err.stack)\n})\n\nreturn msg;","outputs":1,"noerr":0,"x":2453.375030517578,"y":415.50000381469727,"wires":[["19591aa4.f91ec5"]]},{"id":"6843834b.6ee7bc","type":"template","z":"7744a89.2e26458","name":"insert adset_final_cf","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"insert into sippycup.adset_final_cf\nselect final_adset_inc_cf.*\nfrom (\nselect *,\n  ((cf0 * slot_weight * slot0_weight) + ((spend0/last_6_total_spend) * spend_weight)) +\n  ((cf1 * slot_weight * slot1_weight) + ((spend1/last_6_total_spend) * spend_weight)) +\n  ((cf2 * slot_weight * slot2_weight) + ((spend2/last_6_total_spend) * spend_weight)) +\n  ((cf3 * slot_weight * slot3_weight) + ((spend3/last_6_total_spend) * spend_weight)) +\n  ((cf4 * slot_weight * slot4_weight) + ((spend4/last_6_total_spend) * spend_weight)) +\n  ((cf5 * slot_weight * slot5_weight) + ((spend5/last_6_total_spend) * spend_weight)) final_cf\nfrom (\nselect \n      account_id,\n      campaign_id,\n      adset_id,\n      timestamp,\n      COALESCE(spend0,0.0) spend0,\n      COALESCE(cf0,0.0) cf0,\n      COALESCE(spend1,0.0) spend1,\n      COALESCE(cf1,0.0) cf1,\n      COALESCE(spend2,0.0) spend2,\n      COALESCE(cf2,0.0) cf2,\n      COALESCE(spend3,0.0) spend3,\n      COALESCE(cf3,0.0) cf3,\n      COALESCE(spend4,0.0) spend4,\n      COALESCE(cf4,0.0) cf4,\n      COALESCE(spend5,0.0) spend5,\n      COALESCE(cf5,0.0) cf5,\n      COALESCE(spend0,0) + COALESCE(spend1,0) + COALESCE(spend2,0) + COALESCE(spend3,0) + COALESCE(spend4,0) + COALESCE(spend5,0) last_6_total_spend, \n      0.7 slot_weight,\n      0.3 spend_weight,\n      0.5 slot0_weight,\n      0.3 spend0_weight,\n      0.7 slot1_weight,\n      0.3 spend1_weight,\n      0.7 slot2_weight,\n      0.3 spend2_weight,\n      0.7 slot3_weight,\n      0.3 spend3_weight,\n      0.7 slot4_weight,\n      0.3 spend4_weight,\n      0.7 slot5_weight,\n      0.3 spend5_weight \nfrom(\nSELECT \n      account_id,\n      campaign_id,\n      adset_id,\n      max(timestamp) \"timestamp\",\n      sum(case when version=1 then delta_spend else null end) spend0,\n      sum(case when version=1 then cf_inc else null end) cf0,\n      sum(case when version=2 then delta_spend else null end) spend1,\n      sum(case when version=2 then cf_inc else null end) cf1,\n      sum(case when version=3 then delta_spend else null end) spend2,\n      sum(case when version=3 then cf_inc else null end) cf2,\n      sum(case when version=4 then delta_spend else null end) spend3,\n      sum(case when version=4 then cf_inc else null end) cf3,\n      sum(case when version=5 then delta_spend else null end) spend4,\n      sum(case when version=5 then cf_inc else null end) cf4,\n      sum(case when version=6 then delta_spend else null end) spend5,\n      sum(case when version=6 then cf_inc else null end) cf5\nfrom (\n  select *\n       ,row_number() over(partition by account_id,campaign_id,adset_id order by timestamp desc) \"version\"\n  FROM sippycup.adset_inc_cf \n  where is_valid = true) adset_inc_cf\nwhere version<=6\ngroup by account_id,\n      campaign_id,\n      adset_id--,timestamp\n      ) agg_adset_inc_cf) final_adset_inc_cf) final_adset_inc_cf\nleft join sippycup.adset_final_cf\n  on adset_final_cf.account_id = final_adset_inc_cf.account_id and \n      adset_final_cf.campaign_id = final_adset_inc_cf.campaign_id and \n      adset_final_cf.adset_id = final_adset_inc_cf.adset_id and\n      adset_final_cf.timestamp = final_adset_inc_cf.timestamp\nwhere  final_adset_inc_cf.account_id is null;","x":2334.625030517578,"y":344.25000381469727,"wires":[["9e6512e1.544e2"]]},{"id":"dce22059.b4e4c","type":"switch","z":"7744a89.2e26458","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"get-final-cf","vt":"str"}],"checkall":"true","outputs":1,"x":2881.500030517578,"y":414.25000190734863,"wires":[["d063ccbb.eab3b"]]},{"id":"8729f424.234b68","type":"debug","z":"7744a89.2e26458","name":"","active":true,"console":"false","complete":"payload","x":1383.3750076293945,"y":555.5000057220459,"wires":[]},{"id":"db8e219f.a2d12","type":"template","z":"7744a89.2e26458","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select *\nfrom sippycup.incremental_ad_data\nleft join sippycup.adset_inc_cf\n  on incremental_ad_data.account_id = adset_inc_cf.account_id and \n      incremental_ad_data.campaign_id = adset_inc_cf.campaign_id and \n      incremental_ad_data.adset_id = adset_inc_cf.adset_id and\n      incremental_ad_data.timestamp = adset_inc_cf.timestamp \nleft join sippycup.adset_final_cf\n  on adset_final_cf.account_id = adset_inc_cf.account_id and \n      adset_final_cf.campaign_id = adset_inc_cf.campaign_id and \n      adset_final_cf.adset_id = adset_inc_cf.adset_id and\n      adset_final_cf.timestamp = adset_inc_cf.timestamp \nwhere DATE_PART('hour', (current_TIMESTAMP) - (TIMESTAMP 'epoch' + (incremental_ad_data.timestamp/1000) * INTERVAL '1 second'))<=(1*1)\norder by incremental_ad_data.account_id,\n      incremental_ad_data.campaign_id,\n      incremental_ad_data.adset_id,\n      incremental_ad_data.timestamp desc\n\n/*select adset_inc_cf.*,\n    spend0,\n    cf0,\n    spend1,\n    cf1,\n    spend2,\n    cf2,\n    spend3,\n    cf3,\n    spend4,\n    cf4,\n    spend5,\n    cf5,\n    last_6_total_spend,\n    final_cf\nfrom sippycup.adset_inc_cf \n    left join adset_final_cf\non adset_final_cf.account_id = adset_inc_cf.account_id and \n      adset_final_cf.campaign_id = adset_inc_cf.campaign_id and \n      adset_final_cf.adset_id = adset_inc_cf.adset_id and\n      adset_final_cf.timestamp = adset_inc_cf.timestamp    \nwhere adset_inc_cf.timestamp={{timestamp}}*/","x":2680.250030517578,"y":345.50000286102295,"wires":[["9bb7e376.35bd7"]]},{"id":"9bb7e376.35bd7","type":"function","z":"7744a89.2e26458","name":"","func":"var pg = global.get('pg');\n \n// create a config to configure both pooling behavior \n// and client options \n// note: all config is optional and the environment variables \n// will be read if the config is not present \nvar config = {\n  user: 'root', //env var: PGUSER \n  database: 'sippycup', //env var: PGDATABASE \n  password: 'lioran020', //env var: PGPASSWORD \n  host: 'sippycup.c8wilxdbvlmp.us-east-1.rds.amazonaws.com', // Server hosting the postgres database \n  port: 5432, //env var: PGPORT \n  max: 10, // max number of clients in the pool \n  idleTimeoutMillis: 30000, // how long a client is allowed to remain idle before being closed \n};\n \n//this initializes a connection pool \n//it will keep idle connections open for 30 seconds \n//and set a limit of maximum 10 idle clients \nvar pool = new pg.Pool(config);\n \n// to run a query we can acquire a client from the pool, \n// run a query on the client, and then return the client to the pool \npool.connect(function(err, client, done) {\n    //node.warn('connecting to pg')\n  if(err) {\n    return node.warn('error fetching client from pool', err);\n  }\n  client.query(msg.payload, function(err, result) {\n    //call `done(err)` to release the client back to the pool (or destroy it if there is an error) \n    done(err);\n    //node.warn('done')\n    if(err) {\n      return node.error('error running query : ' + err);\n    }\n    \n    //node.warn(result)\n    msg.payload = result.rows\n    msg.topic = \"get-final-cf\"\n    //node.warn('sending message')\n    node.send(msg)\n    //node.warn(result.rows[0].number);\n    //output: 1 \n  });\n});\n \npool.on('error', function (err, client) {\n  // if an error is encountered by a client while it sits idle in the pool \n  // the pool itself will emit an error event with both the error and \n  // the client which emitted the original error \n  // this is a rare occurrence but can happen if there is a network partition \n  // between your application and the database, the database restarts, etc. \n  // and so you might want to handle it and at least log it out \n  node.error('idle client error', err.message, err.stack)\n})\n\nreturn msg;","outputs":1,"noerr":0,"x":2756.500030517578,"y":415.50000381469727,"wires":[["dce22059.b4e4c"]]},{"id":"19591aa4.f91ec5","type":"switch","z":"7744a89.2e26458","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"get-inc-cf","vt":"str"}],"checkall":"true","outputs":1,"x":2579.000030517578,"y":415.50000381469727,"wires":[["db8e219f.a2d12"]]},{"id":"38e5a364.60e98c","type":"template","z":"7744a89.2e26458","name":"get rows","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select distinct timestamp\nfrom sippycup.incremental_ad_data\nwhere (TIMESTAMP 'epoch' + (incremental_ad_data.timestamp/1000) * INTERVAL '1 second')>='2017-05-01'\norder by timestamp","x":269.00000762939453,"y":865.5000095367432,"wires":[["cd429787.905ba8"]]},{"id":"cd429787.905ba8","type":"function","z":"7744a89.2e26458","name":"","func":"var pg = global.get('pg');\n \n// create a config to configure both pooling behavior \n// and client options \n// note: all config is optional and the environment variables \n// will be read if the config is not present \nvar config = {\n  user: 'root', //env var: PGUSER \n  database: 'sippycup', //env var: PGDATABASE \n  password: 'lioran020', //env var: PGPASSWORD \n  host: 'sippycup.c8wilxdbvlmp.us-east-1.rds.amazonaws.com', // Server hosting the postgres database \n  port: 5432, //env var: PGPORT \n  max: 10, // max number of clients in the pool \n  idleTimeoutMillis: 300000000, // how long a client is allowed to remain idle before being closed \n};\n \n//this initializes a connection pool \n//it will keep idle connections open for 30 seconds \n//and set a limit of maximum 10 idle clients \nvar pool = new pg.Pool(config);\n \n// to run a query we can acquire a client from the pool, \n// run a query on the client, and then return the client to the pool \npool.connect(function(err, client, done) {\n    //node.warn('connecting to pg')\n  if(err) {\n    return node.warn('error fetching client from pool', err);\n  }\n  client.query(msg.payload, function(err, result) {\n    //call `done(err)` to release the client back to the pool (or destroy it if there is an error) \n    done(err);\n    //node.warn('done')\n    if(err) {\n      return node.error('error running query : ' + err);\n    }\n    \n    //node.warn(result)\n    msg.payload = result.rows\n    msg.topic = \"get-rows\"\n    //node.warn('sending message')\n    node.send(msg)\n    //node.warn(result.rows[0].number);\n    //output: 1 \n  });\n});\n \npool.on('error', function (err, client) {\n  // if an error is encountered by a client while it sits idle in the pool \n  // the pool itself will emit an error event with both the error and \n  // the client which emitted the original error \n  // this is a rare occurrence but can happen if there is a network partition \n  // between your application and the database, the database restarts, etc. \n  // and so you might want to handle it and at least log it out \n  node.error('idle client error', err.message, err.stack)\n})","outputs":1,"noerr":0,"x":414,"y":853.0000095367432,"wires":[["e2a61515.ae1198"]]},{"id":"e2a61515.ae1198","type":"switch","z":"7744a89.2e26458","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"get-rows","vt":"str"}],"checkall":"true","outputs":1,"x":555.2499923706055,"y":854.25,"wires":[["ae0d6d7c.3056c","7f9a7ac8.09cbf4"]]},{"id":"d2d5c084.2f3f4","type":"template","z":"7744a89.2e26458","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select sippycup.adset_calc_cf({{payload.timestamp}}::bigint)","x":2106.500015258789,"y":764.2500095367432,"wires":[["37da3fb2.3bc46"]]},{"id":"37da3fb2.3bc46","type":"function","z":"7744a89.2e26458","name":"","func":"var pg = global.get('pg');\n \n// create a config to configure both pooling behavior \n// and client options \n// note: all config is optional and the environment variables \n// will be read if the config is not present \nvar config = {\n  user: 'root', //env var: PGUSER \n  database: 'sippycup', //env var: PGDATABASE \n  password: 'lioran020', //env var: PGPASSWORD \n  host: 'sippycup.c8wilxdbvlmp.us-east-1.rds.amazonaws.com', // Server hosting the postgres database \n  port: 5432, //env var: PGPORT \n  max: 10, // max number of clients in the pool \n  idleTimeoutMillis: 600000, // how long a client is allowed to remain idle before being closed \n};\n \n//this initializes a connection pool \n//it will keep idle connections open for 30 seconds \n//and set a limit of maximum 10 idle clients \nvar pool = new pg.Pool(config);\n \n// to run a query we can acquire a client from the pool, \n// run a query on the client, and then return the client to the pool \npool.connect(function(err, client, done) {\n    node.warn('connecting to pg')\n  if(err) {\n    return node.warn('error fetching client from pool', err);\n  }\n  client.query(msg.payload, function(err, result) {\n    //call `done(err)` to release the client back to the pool (or destroy it if there is an error) \n    done(err);\n    node.warn('done')\n    if(err) {\n      return node.error('error running query : ' + err);\n    }\n    \n    node.warn(result)\n    msg.payload = result\n    msg.topic = \"update-rows\"\n    node.warn('sending message')\n    node.send(msg)\n    //node.warn(result.rows[0].number);\n    //output: 1 \n  });\n});\n \npool.on('error', function (err, client) {\n  // if an error is encountered by a client while it sits idle in the pool \n  // the pool itself will emit an error event with both the error and \n  // the client which emitted the original error \n  // this is a rare occurrence but can happen if there is a network partition \n  // between your application and the database, the database restarts, etc. \n  // and so you might want to handle it and at least log it out \n  node.error('idle client error', err.message, err.stack)\n})","outputs":1,"noerr":0,"x":2201.500015258789,"y":824.2500095367432,"wires":[["b5b14963.c56c18"]]},{"id":"b5b14963.c56c18","type":"switch","z":"7744a89.2e26458","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"update-rows","vt":"str"}],"checkall":"true","outputs":1,"x":2291.5000190734863,"y":764.2500095367432,"wires":[["8979d4d3.419d88"]]},{"id":"8979d4d3.419d88","type":"debug","z":"7744a89.2e26458","name":"","active":true,"console":"false","complete":"true","x":2580.250030517578,"y":931.7500114440918,"wires":[]},{"id":"380488d5.0d6b88","type":"template","z":"7744a89.2e26458","name":"VACUUM FULL","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"VACUUM FULL VERBOSE;","x":2452.750026702881,"y":741.7500095367432,"wires":[["e5a3dc71.39685"]]},{"id":"e5a3dc71.39685","type":"function","z":"7744a89.2e26458","name":"","func":"var pg = global.get('pg');\n \n// create a config to configure both pooling behavior \n// and client options \n// note: all config is optional and the environment variables \n// will be read if the config is not present \nvar config = {\n  user: 'root', //env var: PGUSER \n  database: 'sippycup', //env var: PGDATABASE \n  password: 'lioran020', //env var: PGPASSWORD \n  host: 'sippycup.c8wilxdbvlmp.us-east-1.rds.amazonaws.com', // Server hosting the postgres database \n  port: 5432, //env var: PGPORT \n  max: 10, // max number of clients in the pool \n  idleTimeoutMillis: 600000, // how long a client is allowed to remain idle before being closed \n};\n \n//this initializes a connection pool \n//it will keep idle connections open for 30 seconds \n//and set a limit of maximum 10 idle clients \nvar pool = new pg.Pool(config);\n \n// to run a query we can acquire a client from the pool, \n// run a query on the client, and then return the client to the pool \npool.connect(function(err, client, done) {\n    node.warn('connecting to pg')\n  if(err) {\n    return node.warn('error fetching client from pool', err);\n  }\n  client.query(msg.payload, function(err, result) {\n    //call `done(err)` to release the client back to the pool (or destroy it if there is an error) \n    done(err);\n    node.warn('done')\n    if(err) {\n      return node.error('error running query : ' + err);\n    }\n    \n    node.warn(result)\n    msg.payload = result\n    msg.topic = \"vaccum\"\n    node.warn('sending message')\n    node.send(msg)\n    //node.warn(result.rows[0].number);\n    //output: 1 \n  });\n});\n \npool.on('error', function (err, client) {\n  // if an error is encountered by a client while it sits idle in the pool \n  // the pool itself will emit an error event with both the error and \n  // the client which emitted the original error \n  // this is a rare occurrence but can happen if there is a network partition \n  // between your application and the database, the database restarts, etc. \n  // and so you might want to handle it and at least log it out \n  node.error('idle client error', err.message, err.stack)\n})","outputs":1,"noerr":0,"x":2515.2500190734863,"y":829.2500114440918,"wires":[["4f9f4143.197e2"]]},{"id":"4f9f4143.197e2","type":"switch","z":"7744a89.2e26458","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"vaccum","vt":"str"}],"checkall":"true","outputs":1,"x":2640.2500228881836,"y":759.2500114440918,"wires":[["8979d4d3.419d88","d063ccbb.eab3b"]]},{"id":"f8b7e524.6c7e28","type":"catch","z":"7744a89.2e26458","name":"","scope":null,"x":627.1249961853027,"y":1218,"wires":[[]]},{"id":"9a8e6ee5.e9e7e","type":"e-mail","z":"7744a89.2e26458","server":"smtp.gmail.com","port":"465","name":"avigershon@gmail.com","dname":"","x":858.3750076293945,"y":1199.2500076293945,"wires":[]},{"id":"37448335.fe2b4c","type":"template","z":"7744a89.2e26458","name":"REINDEX sippycup","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"REINDEX DATABASE sippycup","x":350.8750305175781,"y":971.7500123977661,"wires":[[]]},{"id":"1ed22101.9a557f","type":"delay","z":"7744a89.2e26458","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":827.1249923706055,"y":924.25,"wires":[["d2d5c084.2f3f4"]]},{"id":"7f9a7ac8.09cbf4","type":"split","z":"7744a89.2e26458","name":"","splt":"\\n","x":705.8750038146973,"y":854.2500104904175,"wires":[["1ed22101.9a557f"]]},{"id":"e02570f8.0eafb","type":"inject","z":"7744a89.2e26458","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":182.74999237060547,"y":1073,"wires":[["37448335.fe2b4c"]]},{"id":"48aa822a.2d74ec","type":"http in","z":"7744a89.2e26458","name":"","url":"/sippycup/adset/latest","method":"get","swaggerDoc":"","x":154.53571319580078,"y":701.7499809265137,"wires":[["138f245c.61188c"]]},{"id":"138f245c.61188c","type":"change","z":"7744a89.2e26458","name":"is http","rules":[{"t":"set","p":"is_http","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":361.49999237060547,"y":719.25,"wires":[["ee5b9846.f85fa8"]]},{"id":"ee5b9846.f85fa8","type":"template","z":"7744a89.2e26458","name":"get rows","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select *,case when new_daily_budget_in_dollars < today_adset_spend then today_adset_spend else new_daily_budget_in_dollars end final_new_daily_budget_in_dollars\nfrom (\n\nselect *,\n(GREATEST(case when campaign_type='ROAS' then ROAS_min_safe_budget else CPA_min_safe_budget end, \n(case when (lifetime_spend > 2*(last_7_days_acc_spend/last_7_days_acc_conversions) and lifetime_conversions = 0) or\n    (lifetime_spend > 3*(last_7_days_acc_spend/last_7_days_acc_conversions) and lifetime_conversions <=1) then\n  0\nelse \n  case when lifetime_spend<200 then\n    --KSM\n    case when campaign_type='ROAS' then\n      --ROAS\n      case when lifetime_conversions>0 and last_7_days_acc_revenue>0 and \n          (lifetime_spend / lifetime_conversions) > (last_7_days_acc_revenue / last_7_days_acc_conversions / target_roi) * GREATEST((-0.00125 * lifetime_spend)+1.35,1.1) then \n        case when daily_budget_in_dollars < 100 then\n          0\n        else \n          case when final_cf>1 then \n            final_cf\n          else\n            power(final_cf,3)\n          end\n        end\n      end\n    else\n      --CPA\n      case when lifetime_conversions>0 and \n          (lifetime_spend / lifetime_conversions) > 1 * GREATEST((-0.00125 * lifetime_spend)+1.35,1.0) then \n        case when daily_budget_in_dollars < 100 then\n          0\n        else \n          case when final_cf>1 then \n            final_cf\n          else\n            power(final_cf,3)\n          end\n        end\n      end\n    end\n  else\n    --Last X Days KM\n    case when campaign_type='ROAS' then\n      --ROAS\n      case when last_x_days_adset_spend>0 and\n          (last_x_days_adset_revenue / last_x_days_adset_spend) < target_roi then \n        case when daily_budget_in_dollars < 100 then\n          0\n        else \n          case when final_cf>1 then \n            final_cf\n          else\n            power(final_cf,3)\n          end\n        end\n      end\n    else\n      --CPA\n      1\n    end\n  end\nend) * (daily_budget_in_dollars-today_adset_spend)) + today_adset_spend) new_daily_budget_in_dollars,\n'GREATEST(case when campaign_type[=' || campaign_type || ']=''ROAS'' then ROAS_min_safe_budget[=' || trim(to_char(ROAS_min_safe_budget,'99999999999999999D99')) || '] else CPA_min_safe_budget[=' || trim(to_char(CPA_min_safe_budget,'99999999999999999D99')) || '] end, \n(case when (lifetime_spend[=' || trim(to_char(lifetime_spend,'99999999999999999D99')) || '] > 2*(last_7_days_acc_spend[=' || trim(to_char(last_7_days_acc_spend,'99999999999999999D99')) || ']/last_7_days_acc_conversions[=' || trim(to_char(last_7_days_acc_conversions,'99999999999999999D99')) || '])[=' || trim(to_char(2*(last_7_days_acc_spend/last_7_days_acc_conversions),'99999999999999999D99')) || '] and lifetime_conversions[=' || trim(to_char(lifetime_conversions,'99999999999999999D99')) || '] = 0) or\n    (lifetime_spend[=' || trim(to_char(lifetime_spend,'99999999999999999D99')) || '] > 3*(last_7_days_acc_spend[=' || trim(to_char(last_7_days_acc_spend,'99999999999999999D99')) || ']/last_7_days_acc_conversions[=' || trim(to_char(last_7_days_acc_conversions,'99999999999999999D99')) || '])[=' || trim(to_char(3*(last_7_days_acc_spend/last_7_days_acc_conversions),'99999999999999999D99')) || '] and lifetime_conversions[=' || trim(to_char(lifetime_conversions,'99999999999999999D99')) || '] <=1) then\n  0\nelse \n  case when lifetime_spend[=' || trim(to_char(lifetime_spend,'99999999999999999D99')) || ']<200 then\n    --KSM\n    case when campaign_type[=' || campaign_type || ']=''ROAS'' then\n      --ROAS\n      case when lifetime_conversions[=' || trim(to_char(lifetime_conversions,'99999999999999999D99')) || ']>0 and last_7_days_acc_revenue[=' || trim(to_char(last_7_days_acc_revenue,'99999999999999999D99')) || ']>0 and \n          (lifetime_spend[=' || trim(to_char(lifetime_spend,'99999999999999999D99')) || '] / lifetime_conversions[=' || trim(to_char(lifetime_conversions,'99999999999999999D99')) || ']) (lifetime_spend / lifetime_conversions)[=' || trim(to_char(lifetime_conversions,'99999999999999999D99')) || '] > (last_7_days_acc_revenue[=' || trim(to_char(last_7_days_acc_revenue,'99999999999999999D99')) || '] / last_7_days_acc_conversions[=' || trim(to_char(last_7_days_acc_conversions,'99999999999999999D99')) || '] / target_roi[=' || trim(to_char(target_roi,'99999999999999999D99')) || '])[=' || trim(to_char((last_7_days_acc_revenue / last_7_days_acc_conversions / target_roi),'99999999999999999D99')) || '] * GREATEST((-0.00125 * lifetime_spend[=' || trim(to_char(lifetime_spend,'99999999999999999D99')) || '])+1.35,1.1)[=' || trim(to_char(GREATEST((-0.00125 * lifetime_spend)+1.35,1.1),'99999999999999999D99')) || '] then \n        case when daily_budget_in_dollars[=' || trim(to_char(daily_budget_in_dollars,'99999999999999999D99')) || '] < 100 then\n          0\n        else \n          case when final_cf[=' || trim(to_char(final_cf,'99999999999999999D99')) || ']>1 then \n            final_cf[=' || trim(to_char(final_cf,'99999999999999999D99')) || ']\n          else\n            power(final_cf,3)[=' || trim(to_char(power(final_cf,3),'99999999999999999D99')) || ']\n          end\n        end\n      end\n    else\n      --CPA\n      case when lifetime_conversions[=' || trim(to_char(lifetime_conversions,'99999999999999999D99')) || ']>0 and \n          (lifetime_spend[=' || trim(to_char(lifetime_spend,'99999999999999999D99')) || '] / lifetime_conversions[=' || trim(to_char(lifetime_conversions,'99999999999999999D99')) || ']) > 1 * GREATEST((-0.00125 * lifetime_spend[=' || trim(to_char(lifetime_spend,'99999999999999999D99')) || '])+1.35,1.0)[=' || trim(to_char(GREATEST((-0.00125 * lifetime_spend)+1.35,1.1),'99999999999999999D99')) || '] then \n        case when daily_budget_in_dollars[=' || trim(to_char(daily_budget_in_dollars,'99999999999999999D99')) || '] < 100 then\n          0\n        else \n          case when final_cf[=' || trim(to_char(final_cf,'99999999999999999D99')) || ']>1 then \n            final_cf[=' || trim(to_char(final_cf,'99999999999999999D99')) || ']\n          else\n            power(final_cf,3)[=' || trim(to_char(power(final_cf,3),'99999999999999999D99')) || ']\n          end\n        end\n      end\n    end\n  else\n    --Last X Days KM\n    case when campaign_type[=' || campaign_type || ']=''ROAS'' then\n      --ROAS\n      case when last_x_days_adset_spend[=' || trim(to_char(last_x_days_adset_spend,'99999999999999999D99')) || ']>0 and\n          (last_x_days_adset_revenue[=' || trim(to_char(last_x_days_adset_revenue,'99999999999999999D99')) || '] / last_x_days_adset_spend[=' || trim(to_char(last_x_days_adset_spend,'99999999999999999D99')) || ']) < target_roi[=' || trim(to_char(target_roi,'99999999999999999D99')) || '] then \n        case when daily_budget_in_dollars[=' || trim(to_char(daily_budget_in_dollars,'99999999999999999D99')) || '] < 100 then\n          0\n        else \n          case when final_cf[=' || trim(to_char(final_cf,'99999999999999999D99')) || ']>1 then \n            final_cf[=' || trim(to_char(final_cf,'99999999999999999D99')) || ']\n          else\n            power(final_cf,3)[=' || trim(to_char(power(final_cf,3),'99999999999999999D99')) || ']\n          end\n        end\n      end\n    else\n      --CPA\n      1\n    end\n  end\nend) * daily_budget_in_dollars[=' || trim(to_char(daily_budget_in_dollars,'99999999999999999D99')) || ']-today_adset_spend[=' || trim(to_char(today_adset_spend,'99999999999999999D99')) || '])' debug\n \nfrom (\n\nSELECT TO_CHAR((TIMESTAMP 'epoch' + (adset_inc_cf.timestamp/1000) * INTERVAL '1 second') AT TIME ZONE 'UTC-3','YYYY-MM-DD hh24:MI') increment_date,\n       adset_inc_cf.account_id,\n       adset_inc_cf.campaign_id,\n       adset_inc_cf.adset_id,\n       adset_inc_cf.last_7_days_acc_spend,\n       adset_inc_cf.lifetime_spend,\n       adset_inc_cf.previous_spend,\n       adset_inc_cf.delta_spend,\n       adset_inc_cf.lifetime_pre_conversions,\n       adset_inc_cf.previous_pre_conversions,\n       adset_inc_cf.delta_pre_conversions,\n       adset_inc_cf.last_7_days_acc_pre_conversions,\n       adset_inc_cf.lifetime_revenue,\n       adset_inc_cf.delta_revenue,\n       adset_inc_cf.lifetime_conversions,\n       adset_inc_cf.delta_conversions,\n       adset_inc_cf.lifetime_scval,\n       adset_inc_cf.vrev_adset_inc,\n       adset_inc_cf.pre_conversion_cpa,\n       adset_inc_cf.target_roi,\n       adset_inc_cf.cf_inc,\n       adset_inc_cf.timestamp,\n       adset_inc_cf.previous_timestamp,\n       adset_inc_cf.is_valid,\n       spend0,\n       cf0,\n       spend1,\n       cf1,\n       spend2,\n       cf2,\n       spend3,\n       cf3,\n       spend4,\n       cf4,\n       spend5,\n       cf5,\n       last_6_total_spend,\n       slot_weight,\n       spend_weight,\n       slot0_weight,\n       spend0_weight,\n       slot1_weight,\n       spend1_weight,\n       slot2_weight,\n       spend2_weight,\n       slot3_weight,\n       spend3_weight,\n       slot4_weight,\n       spend4_weight,\n       slot5_weight,\n       spend5_weight,\n       case when cf0<1 then LEAST(final_cf,0.95) else LEAST(final_cf,3.5) end final_cf,\n      cast('ROAS' as varchar(255)) campaign_type,\n      today_adset_spend,\n      daily_budget,\n      last_7_days_acc_conversions,\n      last_7_days_acc_revenue,\n      last_x_days_adset_spend,\n      last_x_days_adset_revenue,\n      daily_budget/100 daily_budget_in_dollars,\n      today_adset_revenue/target_roi ROAS_min_safe_budget,\n      today_adset_conversions * 1/*TargetCPA*/ CPA_min_safe_budget\nfrom sippycup.adset_inc_cf\ninner join (\n            select account_id,campaign_id,adset_id,\n                  max(lifetime_spend)-min(lifetime_spend) last_x_days_adset_spend,\n                  max(lifetime_revenue)-min(lifetime_revenue) last_x_days_adset_revenue,\n                  max(lifetime_conversions)-min(lifetime_conversions) last_x_days_adset_conversions,\n                  max(lifetime_pre_conversions)-min(lifetime_pre_conversions) last_x_days_adset_pre_conversions\n            from sippycup.adset_inc_cf\n            where (TIMESTAMP 'epoch' + (adset_inc_cf.timestamp/1000) * INTERVAL '1 second') between \n                    ((TIMESTAMP 'epoch' + (adset_inc_cf.timestamp/1000) * INTERVAL '1 second')) - INTERVAL '5 day' and (TIMESTAMP 'epoch' + (adset_inc_cf.timestamp/1000) * INTERVAL '1 second')\n                    and DATE_PART('day', (current_TIMESTAMP) - (TIMESTAMP 'epoch' + (adset_inc_cf.timestamp/1000) * INTERVAL '1 second'))<=5\n            group by adset_inc_cf.account_id,\n                      adset_inc_cf.campaign_id,\n                       adset_inc_cf.adset_id\n            ) adset_inc_cf_last_x_days\non adset_inc_cf_last_x_days.account_id = adset_inc_cf.account_id and \n  adset_inc_cf_last_x_days.campaign_id = adset_inc_cf.campaign_id and \n  adset_inc_cf_last_x_days.adset_id = adset_inc_cf.adset_id\ninner join (\n            select account_id,campaign_id,adset_id,\n                  max(lifetime_spend)-min(lifetime_spend) today_adset_spend,\n                  max(lifetime_revenue)-min(lifetime_revenue) today_adset_revenue,\n                  max(lifetime_conversions)-min(lifetime_conversions) today_adset_conversions,\n                  max(lifetime_pre_conversions)-min(lifetime_pre_conversions) today_adset_pre_conversions\n            from sippycup.adset_inc_cf\n            where  TO_CHAR((TIMESTAMP 'epoch' + ((select max(timestamp) from sippycup.adset_inc_cf)/1000) * INTERVAL '1 second') AT TIME ZONE 'UTC-3','YYYY-MM-DD')=\n                    TO_CHAR((TIMESTAMP 'epoch' + (adset_inc_cf.timestamp/1000) * INTERVAL '1 second') AT TIME ZONE 'UTC-3','YYYY-MM-DD')\n            group by adset_inc_cf.account_id,\n                      adset_inc_cf.campaign_id,\n                       adset_inc_cf.adset_id\n            ) adset_inc_cf_today_days\non adset_inc_cf_today_days.account_id = adset_inc_cf.account_id and \n  adset_inc_cf_today_days.campaign_id = adset_inc_cf.campaign_id and \n  adset_inc_cf_today_days.adset_id = adset_inc_cf.adset_id\nleft join sippycup.adset_final_cf\non adset_final_cf.account_id = adset_inc_cf.account_id and \n      adset_final_cf.campaign_id = adset_inc_cf.campaign_id and \n      adset_final_cf.adset_id = adset_inc_cf.adset_id and\n      adset_final_cf.timestamp = adset_inc_cf.timestamp\nwhere adset_inc_cf.timestamp=(select max(timestamp) from sippycup.adset_inc_cf))a\n\n  )a\n  \n\n","x":512.7499923706055,"y":721.75,"wires":[["45024b1d.50faf4"]]},{"id":"45024b1d.50faf4","type":"function","z":"7744a89.2e26458","name":"","func":"var pg = global.get('pg');\n \n// create a config to configure both pooling behavior \n// and client options \n// note: all config is optional and the environment variables \n// will be read if the config is not present \nvar config = {\n  user: 'root', //env var: PGUSER \n  database: 'sippycup', //env var: PGDATABASE \n  password: 'lioran020', //env var: PGPASSWORD \n  host: 'sippycup.c8wilxdbvlmp.us-east-1.rds.amazonaws.com', // Server hosting the postgres database \n  port: 5432, //env var: PGPORT \n  max: 10, // max number of clients in the pool \n  idleTimeoutMillis: 300000000, // how long a client is allowed to remain idle before being closed \n};\n \n//this initializes a connection pool \n//it will keep idle connections open for 30 seconds \n//and set a limit of maximum 10 idle clients \nvar pool = new pg.Pool(config);\n \n// to run a query we can acquire a client from the pool, \n// run a query on the client, and then return the client to the pool \npool.connect(function(err, client, done) {\n    //node.warn('connecting to pg')\n  if(err) {\n    return node.warn('error fetching client from pool', err);\n  }\n  client.query(msg.payload, function(err, result) {\n    //call `done(err)` to release the client back to the pool (or destroy it if there is an error) \n    done(err);\n    //node.warn('done')\n    if(err) {\n      return node.error('error running query : ' + err);\n    }\n    \n    //node.warn(result)\n    msg.payload = result.rows\n    msg.topic = \"get-rows\"\n    //node.warn('sending message')\n    node.send(msg)\n    //node.warn(result.rows[0].number);\n    //output: 1 \n  });\n});\n \npool.on('error', function (err, client) {\n  // if an error is encountered by a client while it sits idle in the pool \n  // the pool itself will emit an error event with both the error and \n  // the client which emitted the original error \n  // this is a rare occurrence but can happen if there is a network partition \n  // between your application and the database, the database restarts, etc. \n  // and so you might want to handle it and at least log it out \n  node.error('idle client error', err.message, err.stack)\n})","outputs":1,"noerr":0,"x":657.7499847412109,"y":709.25,"wires":[["29787b98.a89be4"]]},{"id":"29787b98.a89be4","type":"switch","z":"7744a89.2e26458","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"get-rows","vt":"str"}],"checkall":"true","outputs":1,"x":798.9999771118164,"y":710.4999904632568,"wires":[["5820c45e.8deb6c"]]},{"id":"9b03d78c.0c34f8","type":"switch","z":"7744a89.2e26458","name":"","property":"is_http","propertyType":"msg","rules":[{"t":"neq","v":"undefined","vt":"jsonata"},{"t":"else"}],"checkall":"true","outputs":2,"x":1594.7142868041992,"y":730.321418762207,"wires":[["38cb1bee.5067e4"],["9dd1669.c153b98"]]},{"id":"1b0b4d9f.42a872","type":"http response","z":"7744a89.2e26458","name":"","x":1869.410587310791,"y":626.5357666015625,"wires":[]},{"id":"555d45ce.5e14ec","type":"function","z":"8f12258d.a834d8","name":"Get campaign data","func":"msg.campaign.adsets = msg.payload.data;\n\nreturn msg;","outputs":1,"noerr":0,"x":1870,"y":180,"wires":[["80a9f617.a69888"]]},{"id":"90bec8a7.3f5b48","type":"http request","z":"8f12258d.a834d8","name":"Get adset budget","method":"GET","ret":"obj","url":"https://graph.facebook.com/v2.11/{{{campaign.id}}}/adsets/?fields=id,end_time,lifetime_budget,daily_budget,effective_status&date_preset=lifetime&level=adset&limit=10000&p=2&access_token={{{fb_account.access_token}}}","tls":"","x":1670,"y":180,"wires":[["555d45ce.5e14ec"]]},{"id":"5d9d9c2b.f2af24","type":"function","z":"7744a89.2e26458","name":"","func":"var ad = msg.payload\n\nmsg.partitionkey = ad.account.account_id + \".\" + ad.adset_id + \".\" + ad.ad_id\nmsg.payload = JSON.stringify(ad)\n\nreturn msg;","outputs":1,"noerr":0,"x":3790,"y":260,"wires":[[]]},{"id":"9dd1669.c153b98","type":"debug","z":"7744a89.2e26458","name":"","active":true,"console":"false","complete":"false","x":1708.4644565582275,"y":870.1427774429321,"wires":[]},{"id":"6fdf8e3e.6a516","type":"inject","z":"7744a89.2e26458","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":157.03570665631975,"y":782.9999999999999,"wires":[["ee5b9846.f85fa8"]]},{"id":"5820c45e.8deb6c","type":"split","z":"7744a89.2e26458","name":"","splt":"\\n","x":932.7500534057617,"y":711.5714721679688,"wires":[["f595a217.abe78"]]},{"id":"f595a217.abe78","type":"switch","z":"7744a89.2e26458","name":"is debug mode","property":"payload.debug","propertyType":"msg","rules":[{"t":"neq","v":"undefined","vt":"jsonata"},{"t":"else"}],"checkall":"true","outputs":2,"x":1097.7500076293945,"y":714.428560256958,"wires":[["52162e93.0942e"],[]]},{"id":"52162e93.0942e","type":"function","z":"7744a89.2e26458","name":"","func":"msg.payload.debug = msg.payload.debug.split(\"\\n\")\n\nreturn msg;","outputs":1,"noerr":0,"x":1272.749984741211,"y":707.2857666015625,"wires":[["fcb125b8.6c0138"]]},{"id":"fcb125b8.6c0138","type":"json","z":"7744a89.2e26458","name":"","x":1392.749900817871,"y":764.428560256958,"wires":[["422faace.fa7e34"]]},{"id":"422faace.fa7e34","type":"json","z":"7744a89.2e26458","name":"","x":1497.7499866485596,"y":684.4285793304443,"wires":[["9b03d78c.0c34f8"]]},{"id":"38cb1bee.5067e4","type":"join","z":"7744a89.2e26458","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","timeout":"","count":"","x":1647.0357066563197,"y":638.7142857142857,"wires":[["1b0b4d9f.42a872"]]},{"id":"6c18590b.8c8088","type":"function","z":"7744a89.2e26458","name":"","func":"msg.headers = {\n    \"Content-Type\" : \"text/html\"\n}\n\nmsg.payload = syntaxHighlight(msg.payload);// \"<pre>\" + msg.payload + \"</pre>\"\n\nfunction syntaxHighlight(json) {\n    if (typeof json != 'string') {\n         json = JSON.stringify(json, undefined, 2);\n    }\n    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');\n    return json.replace(/(\"(\\\\u[a-zA-Z0-9]{4}|\\\\[^u]|[^\\\\\"])*\"(\\s*:)?|\\b(true|false|null)\\b|-?\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d+)?)/g, function (match) {\n        var cls = 'number';\n        if (/^\"/.test(match)) {\n            if (/:$/.test(match)) {\n                cls = 'key';\n            } else {\n                cls = 'string';\n            }\n        } else if (/true|false/.test(match)) {\n            cls = 'boolean';\n        } else if (/null/.test(match)) {\n            cls = 'null';\n        }\n        return '<span class=\"' + cls + '\"><pre>' + match + '</pre></span>';\n    });\n}\nreturn msg;","outputs":1,"noerr":0,"x":1787.7499923706055,"y":698.7142944335938,"wires":[["1b0b4d9f.42a872"]]},{"id":"c37323ad.12b63","type":"debug","z":"7744a89.2e26458","name":"","active":true,"console":"false","complete":"true","x":755.8749923706055,"y":454.25000381469727,"wires":[]},{"id":"8aa75758.c2eba8","type":"config","z":"7744a89.2e26458","name":"data","properties":[{"p":"data","pt":"flow","to":"{\"name\":\"luka\",\"accounts\":[{\"access_token\":\"EAAMU4ZAfHJMYBADRHzQrfsv3mZA3hKGxrZAtR2TT8zmZBZCU8mAmp2Y2tpum1leunpBsvusgcOItb05G4xUKSumBT2A3yNvEvNkKtoroMM8oh4V6CllFP20aNq3VXZBDNfn1TzWZAijitOjI4yvDzZAZBEq6hSPu9Yiyvv4kmxl7z6gZDZD\",\"campaigns\":[{\"effective_status\":\"ACTIVE\",\"id\":\"6090027468460\"},{\"effective_status\":\"ACTIVE\",\"id\":\"6089766492460\"}],\"id\":\"1381220405489176\"}]}","tot":"json"}],"active":true,"x":110,"y":60,"wires":[]},{"id":"da4376a7.6f9bc8","type":"change","z":"8f12258d.a834d8","name":"Set Payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"accounts","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":180,"wires":[["4c2d25c3.a769cc"]]},{"id":"f7e86095.f0b16","type":"debug","z":"7744a89.2e26458","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":3990,"y":180,"wires":[]},{"id":"4bbbb79a.0799a8","type":"debug","z":"7744a89.2e26458","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":2970,"y":120,"wires":[]},{"id":"eb09f4df.b47df8","type":"function","z":"7744a89.2e26458","name":"Stringify Message","func":"\nmsg = {\n    documentIndex: msg.documentIndex,\n    documentType: msg.documentType,\n    documentId: msg.documentId,\n    payload: msg.payload,\n    debug: msg.debug,\n    flow: msg.flow\n}\n\nmsg.payload = JSON.stringify(msg);\nmsg.topic   = msg.flow + \"-save-document\";\n\nreturn msg;","outputs":1,"noerr":0,"x":4030,"y":260,"wires":[[]]},{"id":"ec5c6573.797288","type":"rdkafka out","z":"7744a89.2e26458","name":"save-document","topic":"","key":"","partition":-1,"broker":"c0e67585.074708","x":4260,"y":260,"wires":[]},{"id":"bfd28ba5.0fd2a8","type":"config","z":"7744a89.2e26458","name":"debug","properties":[{"p":"debug","pt":"flow","to":"false","tot":"bool"}],"active":true,"x":290,"y":60,"wires":[]},{"id":"d3972b0.82f3cd8","type":"function","z":"7744a89.2e26458","name":"set payload with params.Item","func":"msg.payload = msg.params.Item;\n\nreturn msg;","outputs":1,"noerr":0,"x":3600,"y":440,"wires":[["21ad144f.d2f16c"]]},{"id":"21ad144f.d2f16c","type":"function","z":"7744a89.2e26458","name":"set default values","func":"msg.payload = msg.params.Item;\nmsg.db_payload = msg.payload\n\nmsg.db_payload.impressions===undefined ? 0 : msg.db_payload.impressions\nmsg.db_payload.campaign_id===undefined ? \"\" : msg.db_payload.campaign_id\nmsg.db_payload.campaign_name===undefined ? \"\" : msg.db_payload.campaign_name\nmsg.db_payload.adset_id===undefined ? \"\" : msg.db_payload.adset_id\nmsg.db_payload.adset_name===undefined ? \"\" : msg.db_payload.adset_name\nmsg.db_payload.ad_id===undefined ? \"\" : msg.db_payload.ad_id\nmsg.db_payload.ad_name===undefined ? \"\" : msg.db_payload.ad_name\nmsg.db_payload.spend===undefined ? 0 : msg.db_payload.spend\nmsg.db_payload.date_start===undefined ? \"\" : msg.db_payload.date_start\nmsg.db_payload.date_stop===undefined ? \"\" : msg.db_payload.date_stop\nmsg.db_payload.pre_conversions===undefined ? 0 : msg.db_payload.pre_conversions\nmsg.db_payload.conversions===undefined ? 0 : msg.db_payload.conversions\nmsg.db_payload.revenue===undefined ? 0 : msg.db_payload.revenue\nmsg.db_payload.adset.adset_id===undefined ? \"\" : msg.db_payload.adset.adset_id\nmsg.db_payload.adset.pre_conversions===undefined ? 0 : msg.db_payload.adset.pre_conversions\nmsg.db_payload.adset.conversions===undefined ? 0 : msg.db_payload.adset.conversions\nmsg.db_payload.adset.revenue===undefined ? 0 : msg.db_payload.adset.revenue\nmsg.db_payload.campaign.pre_conversions===undefined ? 0 : msg.db_payload.campaign.pre_conversions\nmsg.db_payload.campaign.conversions===undefined ? 0 : msg.db_payload.campaign.conversions\nmsg.db_payload.campaign.revenue===undefined ? 0 : msg.db_payload.campaign.revenue\nmsg.db_payload.account.account_id===undefined ? 0 : msg.db_payload.account.account_id\nmsg.db_payload.account.pre_conversions===undefined ? 0 : msg.db_payload.account.pre_conversions\nmsg.db_payload.account.conversions===undefined ? 0 : msg.db_payload.account.conversions\nmsg.db_payload.account.revenue===undefined ? 0 : msg.db_payload.account.revenue\nmsg.db_payload.Pad===undefined ? 0 : msg.db_payload.Pad\nmsg.db_payload.Rad===undefined ? 0 : msg.db_payload.Rad\nmsg.db_payload.Padset===undefined ? 0 : msg.db_payload.Padset\nmsg.db_payload.Radset===undefined ? 0 : msg.db_payload.Radset\nmsg.db_payload.Pcampaign===undefined ? 0 : msg.db_payload.Pcampaign\nmsg.db_payload.Rcampaign===undefined ? 0 : msg.db_payload.Rcampaign\nmsg.db_payload.Paccount===undefined ? 0 : msg.db_payload.Paccount\nmsg.db_payload.Raccount===undefined ? 0 : msg.db_payload.Raccount\nmsg.db_payload.debug.part1===undefined ? 0 : msg.db_payload.debug.part1\nmsg.db_payload.debug.part2===undefined ? 0 : msg.db_payload.debug.part2\nmsg.db_payload.debug.part3===undefined ? 0 : msg.db_payload.debug.part3\nmsg.db_payload.debug.part4===undefined ? 0 : msg.db_payload.debug.part4\nmsg.db_payload.SCVal===undefined ? 0 : msg.db_payload.SCVal\nmsg.db_payload.VRevN===undefined ? 0 : msg.db_payload.VRevN\nmsg.db_payload.timestamp===undefined ? 0 : msg.db_payload.timestamp\nmsg.db_payload.adset_lifetime_budget===undefined ? 0 : msg.db_payload.adset_lifetime_budget\nmsg.db_payload.adset_daily_budget===undefined ? 0 : msg.db_payload.adset_daily_budget\n\nreturn msg;","outputs":1,"noerr":0,"x":3874.1250076293945,"y":361.5,"wires":[["baa69b14.606688"]]},{"id":"baa69b14.606688","type":"template","z":"7744a89.2e26458","name":"insert incremental_ad_data","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"(\n  {{db_payload.impressions}},\n  '{{db_payload.campaign_id}}',\n  '{{db_payload.campaign_name}}',\n  '{{db_payload.adset_id}}',\n  '{{db_payload.adset_name}}',\n  '{{db_payload.ad_id}}',\n  '{{db_payload.ad_name}}',\n  {{db_payload.spend}},\n  '{{db_payload.date_start}}',\n  '{{db_payload.date_stop}}',\n  {{db_payload.pre_conversions}},\n  {{db_payload.conversions}},\n  {{db_payload.revenue}},\n  '{{db_payload.adset.adset_id}}',\n  {{db_payload.adset.pre_conversions}},\n  {{db_payload.adset.conversions}},\n  {{db_payload.adset.revenue}},\n  {{db_payload.campaign.pre_conversions}},\n  {{db_payload.campaign.conversions}},\n  {{db_payload.campaign.revenue}},\n  '1381220405489176',\n  {{db_payload.account.pre_conversions}},\n  {{db_payload.account.conversions}},\n  {{db_payload.account.revenue}},\n  {{db_payload.Pad}},\n  {{db_payload.Rad}},\n  {{db_payload.Padset}},\n  {{db_payload.Radset}},\n  {{db_payload.Pcampaign}},\n  {{db_payload.Rcampaign}},\n  {{db_payload.Paccount}},\n  {{db_payload.Raccount}},\n  {{db_payload.debug.part1}},\n  {{db_payload.debug.part2}},\n  {{db_payload.debug.part3}},\n  {{db_payload.debug.part4}},\n  {{db_payload.SCVal}},\n  {{db_payload.VRevN}},\n  {{db_payload.timestamp}},\n  {{db_payload.adset_lifetime_budget}},\n  {{db_payload.adset_daily_budget}}\n)","x":4169.7500076293945,"y":345.24999809265137,"wires":[["615c1d71.099524"]]},{"id":"615c1d71.099524","type":"join","z":"7744a89.2e26458","name":"","mode":"custom","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":",","timeout":"","count":"","x":4304.1250076293945,"y":397.75000190734863,"wires":[["46d47943.747a28"]]},{"id":"46d47943.747a28","type":"template","z":"7744a89.2e26458","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO sippycup.incremental_ad_data\n(\n  impressions,\n  campaign_id,\n  campaign_name,\n  adset_id,\n  adset_name,\n  ad_id,\n  ad_name,\n  spend,\n  date_start,\n  date_stop,\n  pre_conversions,\n  conversions,\n  revenue,\n  adset_adset_id,\n  adset_pre_conversions,\n  adset_conversions,\n  adset_revenue,\n  campaign_pre_conversions,\n  campaign_conversions,\n  campaign_revenue,\n  account_id,\n  account_pre_conversions,\n  account_conversions,\n  account_revenue,\n  pad,\n  rad,\n  padset,\n  radset,\n  pcampaign,\n  rcampaign,\n  paccount,\n  raccount,\n  debug_part1,\n  debug_part2,\n  debug_part3,\n  debug_part4,\n  scval,\n  vrev,\n  TIMESTAMP,\n  adset_lifetime_budget,\n  adset_daily_budget\n)\nVALUES {{payload}};","x":4382.8750076293945,"y":340.25000381469727,"wires":[["d4c5b120.df57"]]},{"id":"d4c5b120.df57","type":"function","z":"7744a89.2e26458","name":"","func":"msg.payload = msg.payload.replace(/&#39;/g,\"'\")\n\nreturn msg;","outputs":1,"noerr":0,"x":4505.375019073486,"y":341.49999809265137,"wires":[["9d931d96.0ca1c"]]},{"id":"9d931d96.0ca1c","type":"function","z":"7744a89.2e26458","name":"","func":"var pg = global.get('pg');\n \n// create a config to configure both pooling behavior \n// and client options \n// note: all config is optional and the environment variables \n// will be read if the config is not present \nvar config = {\n  user: 'root', //env var: PGUSER \n  database: 'sippycup', //env var: PGDATABASE \n  password: 'lioran020', //env var: PGPASSWORD \n  host: 'sippycup.c8wilxdbvlmp.us-east-1.rds.amazonaws.com', // Server hosting the postgres database \n  port: 5432, //env var: PGPORT \n  max: 10, // max number of clients in the pool \n  idleTimeoutMillis: 30000, // how long a client is allowed to remain idle before being closed \n};\n \n//this initializes a connection pool \n//it will keep idle connections open for 30 seconds \n//and set a limit of maximum 10 idle clients \nvar pool = new pg.Pool(config);\n \n// to run a query we can acquire a client from the pool, \n// run a query on the client, and then return the client to the pool \npool.connect(function(err, client, done) {\n    node.warn('connecting to pg')\n  if(err) {\n    return node.warn('error fetching client from pool', err);\n  }\n  client.query(msg.payload, function(err, result) {\n    //call `done(err)` to release the client back to the pool (or destroy it if there is an error) \n    done(err);\n    node.warn('done')\n    if(err) {\n      return node.error('error running query', err);\n    }\n    \n    node.warn(result)\n    msg.payload = result\n    msg.payload.timestamp = msg.timestamp\n    msg.topic = \"save-inc-data\"\n    node.warn('sending message')\n    node.send(msg)\n    //node.warn(result.rows[0].number);\n    //output: 1 \n  });\n});\n \npool.on('error', function (err, client) {\n  // if an error is encountered by a client while it sits idle in the pool \n  // the pool itself will emit an error event with both the error and \n  // the client which emitted the original error \n  // this is a rare occurrence but can happen if there is a network partition \n  // between your application and the database, the database restarts, etc. \n  // and so you might want to handle it and at least log it out \n  node.error('idle client error', err.message, err.stack)\n})","outputs":1,"noerr":0,"x":4553.500011444092,"y":469.0000009536743,"wires":[["7a7c6818.5b4488"]]},{"id":"7a7c6818.5b4488","type":"switch","z":"7744a89.2e26458","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"save-inc-data","vt":"str"}],"checkall":"true","outputs":1,"x":4654.125015258789,"y":612.75,"wires":[["f6fd95c6.d5bd08"]]},{"id":"f6fd95c6.d5bd08","type":"template","z":"7744a89.2e26458","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select sippycup.adset_calc_cf({{payload.timestamp}}::bigint)","x":4751.0000076293945,"y":690.2500038146973,"wires":[["33520264.b6419e"]]},{"id":"33520264.b6419e","type":"function","z":"7744a89.2e26458","name":"","func":"var pg = global.get('pg');\n \n// create a config to configure both pooling behavior \n// and client options \n// note: all config is optional and the environment variables \n// will be read if the config is not present \nvar config = {\n  user: 'root', //env var: PGUSER \n  database: 'sippycup', //env var: PGDATABASE \n  password: 'lioran020', //env var: PGPASSWORD \n  host: 'sippycup.c8wilxdbvlmp.us-east-1.rds.amazonaws.com', // Server hosting the postgres database \n  port: 5432, //env var: PGPORT \n  max: 10, // max number of clients in the pool \n  idleTimeoutMillis: 600000, // how long a client is allowed to remain idle before being closed \n};\n \n//this initializes a connection pool \n//it will keep idle connections open for 30 seconds \n//and set a limit of maximum 10 idle clients \nvar pool = new pg.Pool(config);\n \n// to run a query we can acquire a client from the pool, \n// run a query on the client, and then return the client to the pool \npool.connect(function(err, client, done) {\n    node.warn('connecting to pg')\n  if(err) {\n    return node.warn('error fetching client from pool', err);\n  }\n  client.query(msg.payload, function(err, result) {\n    //call `done(err)` to release the client back to the pool (or destroy it if there is an error) \n    done(err);\n    node.warn('done')\n    if(err) {\n      return node.error('error running query : ' + err);\n    }\n    \n    node.warn(result)\n    msg.payload = result\n    msg.topic = \"update-rows\"\n    node.warn('sending message')\n    node.send(msg)\n    //node.warn(result.rows[0].number);\n    //output: 1 \n  });\n});\n \npool.on('error', function (err, client) {\n  // if an error is encountered by a client while it sits idle in the pool \n  // the pool itself will emit an error event with both the error and \n  // the client which emitted the original error \n  // this is a rare occurrence but can happen if there is a network partition \n  // between your application and the database, the database restarts, etc. \n  // and so you might want to handle it and at least log it out \n  node.error('idle client error', err.message, err.stack)\n})","outputs":1,"noerr":0,"x":4846.0000076293945,"y":750.2500038146973,"wires":[["3a8121f8.e8688e"]]},{"id":"3a8121f8.e8688e","type":"switch","z":"7744a89.2e26458","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"update-rows","vt":"str"}],"checkall":"true","outputs":1,"x":4936.000011444092,"y":690.2500038146973,"wires":[[]]},{"id":"4d202e5f.eedab","type":"change","z":"920d75bc.d0fe08","name":"Set Sport Type","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.n","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":360,"wires":[["d91f4016.3edd8"]]},{"id":"46905c6c.ba1f94","type":"function","z":"920d75bc.d0fe08","name":"","func":"msg.event.score = msg.event.score.includes(\"null\") ? '0 - 0' :  msg.event.score\nmsg.event.minute = msg.event.minute===null?0:msg.event.minute;\n\nreturn msg;","outputs":1,"noerr":0,"x":2030,"y":340,"wires":[["1f36ae93.ac3f01"]]},{"id":"5d07c287.c3569c","type":"function","z":"e6cabfa4.fd5d9","name":"Live Events Request","func":"msg.headers = {};\n\nmsg.headers['origin'] = 'https://1betpro.com' \nmsg.headers['accept-language'] = 'en-US,en;q=0.9,es;q=0.8,sq;q=0.7,he;q=0.6' \nmsg.headers['user-agent'] = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36' \nmsg.headers['content-type'] = 'application/x-www-form-urlencoded' \nmsg.headers['accept'] = 'application/json, text/javascript, */*; q=0.01' \nmsg.headers['referer'] = 'https://1betpro.com/live/' \nmsg.headers['authority'] = '1betpro.com' \nmsg.headers['x-requested-with'] = 'XMLHttpRequest' \n\nmsg.headers['cookie'] = \"\";\n\nmsg.website.session.cookies.forEach( cookie => {\n    msg.headers['cookie'] = msg.headers['cookie'] + cookie.name + \"=\" + cookie.value +\";\"\n})\n\nmsg.request = {\n    headers : msg.headers\n}\n\nmsg.url = \"https://1betpro.com/ajax/\"\n\nmsg.payload = {\n    \"mode\" : \"lines\",\n    //debug\n    //\"period\" : \"today\",\n    //\"sport_id\": 1,\n    //\"league_id\" : \"all\",\n    //prod\n    \"period\" : \"live\",\n    \"action\": \"cng\",\n    \"rnd\" : msg.timestamp,\n    \"human\" : 1,\n    \"delta_time\" : 0\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":300,"wires":[["ed1da470.076708"]]},{"id":"ed1da470.076708","type":"http request","z":"e6cabfa4.fd5d9","name":"","method":"POST","ret":"txt","url":"","tls":"363f279c.1671a8","x":690,"y":300,"wires":[["2156a8be.190a18"]]},{"id":"a2742353.72071","type":"function","z":"4bfab75c.41da68","name":"Today's Events Request","func":"msg.headers = {};\n\nmsg.headers['Accept-Language'] = 'en-US,en;q=0.9,es;q=0.8,sq;q=0.6' \nmsg.headers['User-Agent'] = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36' \nmsg.headers['Accept'] = 'application/json, text/javascript, */*; q=0.01' \nmsg.headers['Referer'] = 'http://www.966sport.com/live' \nmsg.headers['X-Requested-With'] = 'XMLHttpRequest' \nmsg.headers['Connection'] = 'keep-alive'\n\nmsg.headers['cookie'] = \"\";\n\nmsg.website.session.cookies.forEach( cookie => {\n    msg.headers['cookie'] = msg.headers['cookie'] + cookie.name + \"=\" + cookie.value +\";\"\n})\n\n//msg.url = \"http://www.966sport.com/ajax/live?selsport=all&_=\" + msg.timestamp;\n\n//When there's no live event and we want to test flow\nmsg.url = \"http://www.966sport.com/ajax/ajax_t_games?sport=soccer&time=t&startop=2&options=&_=\" + msg.timestamp;\n\nmsg.topic = \"966SPORT_HTTP_REQUEST_COMPLETED\";\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":320,"wires":[["6a13b98f.2ee228"]]},{"id":"6a13b98f.2ee228","type":"http request","z":"4bfab75c.41da68","name":"","method":"GET","ret":"txt","url":"","tls":"363f279c.1671a8","x":670,"y":320,"wires":[["e50855e1.791b38"]]},{"id":"6c5a93dd.a078bc","type":"change","z":"dd2ff415.75e098","name":"","rules":[{"t":"set","p":"payload.timestamp","pt":"msg","to":"","tot":"date"},{"t":"set","p":"payload.id","pt":"msg","to":"$base64encode($lowercase(msg.payload.site_name & ';' & msg.payload.id_1 & ';' & msg.payload.id_2))","tot":"jsonata"},{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":280,"wires":[[]]},{"id":"97bb2584.819318","type":"change","z":"920d75bc.d0fe08","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t    \"id\"                : \"pinibet\" & \";\" & msg.payload.odd.pinibet.id_1 & \";\" & msg.payload.odd.pinibet.id_2,\t    \"event_name\"        : msg.payload.event.official,\t    \"event_date\"        : msg.payload.event.date,\t    \"event_score\"       : msg.payload.event.score,\t    \"event_score_1\"       : $number(msg.payload.event.score_1),\t    \"event_score_2\"       : $number(msg.payload.event.score_2),\t    \t    \"event_minute\"      : $number(msg.payload.event.minute),\t    \"league_name\"       : msg.payload.event.league.name,\t    \"sport_name\"       : msg.payload.event.sport.name,\t    \t    \"site_name\"         : \"pinibet\",\t    \"type\"              : msg.payload.odd.type,\t    \"expires_on\"        : msg.payload.odd.expires_on,\t    \"run_line\"          : msg.payload.odd.pinibet.run_line_1 & '/' & msg.payload.odd.pinibet.run_line_2,\t    \t    \"id_1\"              : msg.payload.odd.pinibet.id_1,\t    \"id_1_number\"       : $number(msg.payload.odd.pinibet.id_1),\t    \t    \"money_line_1\"      : msg.payload.odd.pinibet.money_line_1,\t    \"run_line_1\"        : msg.payload.odd.pinibet.run_line_1,\t    \t    \"id_2\"              : msg.payload.odd.pinibet.id_2,\t    \"id_2_number\"       : $number(msg.payload.odd.pinibet.id_2),\t    \t    \"money_line_2\"      : msg.payload.odd.pinibet.money_line_2,\t    \"run_line_2\"        : msg.payload.odd.pinibet.run_line_2\t}","tot":"jsonata"},{"t":"set","p":"payload.timestamp","pt":"msg","to":"","tot":"date"},{"t":"set","p":"topic","pt":"msg","to":"staging-odds","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":4820,"y":380,"wires":[["c461f01e.72102"]]},{"id":"c179fda6.be0c2","type":"function","z":"dd2ff415.75e098","name":"Transform v2","func":"var DEBUG=msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nfunction odd_mapper(raw, type, expires_on){\n    \n    try{\n            \n        let codes = {\n            \"Full Time\" :\"FT\",\n            \"1st Half\" : \"FH\",\n            \"1x2\" : \"1X2\",\n            \"Handicap\" : \"HDP\",\n            \"Over/Under\" : \"OU\"\n        }\n        \n        let opponent_1 = (type === \"Over/Under\") ? \"o\" : \"h\";\n        let opponent_2 = (type === \"Over/Under\") ? \"u\" : \"a\";\n        let opponent_0 = (type === \"1x2\") ? \"d\" : null;\n\n        let sign = parseInt((type === \"Over/Under\") ? \"-1\" : \"1\");\n\n        let odd = {\n            \"event_name\"    :  raw.event.official,\n            \"event_date\"    :  raw.event.date,\n            \"event_score\"   :  raw.event.score,\n            \"event_score_1\"   :  parseFloat(raw.event.score_1),\n            \"event_score_2\"   :  parseFloat(raw.event.score_2),\n            \n            \"event_minute\"  :  parseFloat(raw.event.minute),\n            \"league_name\"   :  raw.event.league.name,\n            \"sport_name\"    :  raw.event.sport.name,\n            \"site_name\"     :  msg.website.name,\n            \"type\"          :  type,\n            \"expires_on\"    :  expires_on,\n            \"id_1\"          :  (raw.id_e + codes[expires_on] + '_' + codes[type] + '_' + opponent_1 + '_' + raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_1 + \"_op\"].toString()).trim().replace(\" \",\"\"),\n            \"money_line_1\"  :  parseFloat(raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_1].toString().trim().replace(\" \",\"\")),\n            \"run_line_1\"    :  parseFloat(raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_1 + \"_op\"].toString().trim().replace(\" \",\"\")),\n            \"id_2\"          :  (raw.id_e + codes[expires_on] + '_' + codes[type] + '_' + opponent_2 + '_' + raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_2 + \"_op\"].toString()).trim().replace(\" \",\"\"),\n            \"money_line_2\"  :  parseFloat(raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_2].toString().trim().replace(\" \",\"\")),\n            \"run_line_2\"    :  sign * parseFloat(raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_2 + \"_op\"].toString().trim().replace(\" \",\"\")),\n            \"id_0\"          :  opponent_0!==null ? (raw.id_e + codes[expires_on] + '_' + codes[type] + '_' + opponent_0).trim().replace(\" \",\"\") : null,\n            \"money_line_0\"  :  opponent_0!==null ? parseFloat(raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_0].toString().trim().replace(\" \",\"\")) : null,\n            \"run_line_0\"    :  opponent_0!==null ? parseFloat(1) : null\n        }\n        \n        odd.run_line = odd.run_line_1 + '/' + odd.run_line_2;\n        \n        odd.id_1_number = parseInt(odd.odd.id_1);\n        odd.id_2_number = parseInt(odd.odd.id_2);\n        \n        return odd;\n    }\n    catch(e){\n        msg.error = e.message;\n        msg.type=type;\n        msg.expires_on = expires_on;\n        msg.opponent_1 = opponent_1;\n        msg.opponent_2 = opponent_2;\n        msg.opponent_0 = opponent_0;\n        log('odd_mapper error : ' + e.message);// + ' ' + JSON.stringify(event))\n    }\n}\n\nDate.prototype.getRoundHours = function() {\n  var mm = this.getMonth() + 1; // getMonth() is zero-based\n  var dd = this.getDate();\n  var hh = this.getHours();\n  \n  return [this.getFullYear()     + '-',\n          (mm>9 ? '' : '0') + mm + '-',\n          (dd>9 ? '' : '0') + dd + 'T',\n          (hh>9 ? '' : '0') + hh + ':00:00.000Z',\n         ].join('');\n};\n\nlet odds = [];\n\ntry{\n    \n    let event_date = new Date();\n    let event_rounded_date = event_date.getRoundHours();\n\n    let event_minute = parseInt(msg.data.date);\n    \n    if(msg.data.date.includes(\"LIVE\") || msg.data.date.includes(\"Half Time\")){\n        event_date = event_rounded_date;\n        //event_minute = 0;\n    }\n    else if(event_minute>=0){\n        \n        event_date.setMinutes(event_date.getMinutes() - event_minute);\n        event_date.setMinutes(event_date.getMinutes() - (event_date.getMinutes() % 5));\n        \n        event_date.setSeconds(\"00\");\n        event_date.setMilliseconds(\"000\");\n        \n        event_minute = event_minute;\n    }\n    else{\n        event_date = \"1900-01-01T00:00:00.000Z\";\n        event_minute = -1;\n    }\n    \n    //event_date = event_date.toString().replace(\"T\",\" \").replace(\".000Z\",\"\");\n    \n    msg.data.score_h = isNaN(parseInt(msg.data.score_h)) ? 0 : parseInt(msg.data.score_h)\n    msg.data.score_a = isNaN(parseInt(msg.data.score_a)) ? 0 : parseInt(msg.data.score_a)\n    \n    msg.data.score_h = msg.data.score_h===null ? 0 : msg.data.score_h;\n    msg.data.score_a = msg.data.score_a===null ? 0 : msg.data.score_a;\n\n    msg.data.event= {\n            name: (msg.data.home_team + ' vs ' + msg.data.away_team).toLowerCase(),\n            official: msg.google.result.length>0 ? msg.google.result[0].toLowerCase() : (msg.data.home_team + ' vs ' + msg.data.away_team).toLowerCase(),\n            date: event_date.getTime(),\n            participants: [msg.data.home_team.toLowerCase(),msg.data.away_team.toLowerCase()],\n            score: msg.data.score_h + ' - ' + msg.data.score_a,\n            score_1: msg.data.score_h,\n            score_2: msg.data.score_a,\n            minute: event_minute,\n            league: {\n                name: msg.league.liga.toLowerCase()\n            },\n            sport: {\n                name: msg.league.sport.toLowerCase()\n            }\n        };\n     \n    // 1x2\n    // Full Time \n    if(msg.data.hasOwnProperty(\"FT_1X2_h\") && msg.data.hasOwnProperty(\"FT_1X2_a\")){\n        try{\n            odds.push(odd_mapper(msg.data,\"1x2\",\"Full Time\"))\n        }\n        catch(e){\n            log(e.message)\n        }\n    }\n    \n    // 1st Half\n    if(msg.data.hasOwnProperty(\"FH_1X2_h\") && msg.data.hasOwnProperty(\"FH_1X2_a\")){\n        try{\n            odds.push(odd_mapper(msg.data,\"1x2\",\"1st Half\"))\n        }\n        catch(e){\n            log(e.message)\n        }\n    }\n    \n    // Handicap\n    // Full Time\n    if(msg.data.hasOwnProperty(\"FT_HDP_h\") && msg.data.hasOwnProperty(\"FT_HDP_a\")){\n        try{\n            odds.push(odd_mapper(msg.data,\"Handicap\",\"Full Time\"))\n        }\n        catch(e){\n            log(e.message)\n        }\n    } \n    \n    // 1st Half\n    if(msg.data.hasOwnProperty(\"FH_HDP_h\") && msg.data.hasOwnProperty(\"FH_HDP_a\")){\n        try{\n            odds.push(odd_mapper(msg.data,\"Handicap\",\"1st Half\"))\n        }\n        catch(e){\n            log(e.message)\n        }\n    } \n    \n    // Over/Under\n    // Full Time\n    if(msg.data.hasOwnProperty(\"FT_OU_o\") && msg.data.hasOwnProperty(\"FT_OU_u\")){\n        try{\n            odds.push(odd_mapper(msg.data,\"Over/Under\",\"Full Time\"))\n        }\n        catch(e){\n            log(e.message)\n        }\n    }\n    \n    // Over/Under\n    // 1st Half\n    if(msg.data.hasOwnProperty(\"FH_OU_o\") && msg.data.hasOwnProperty(\"FH_OU_u\")){\n        try{\n            \n            odds.push(odd_mapper(msg.data,\"Over/Under\",\"1st Half\"));\n            \n        }\n        catch(e){\n            log(e.message)\n        }\n    }\n    \n    msg.payload = odds;\n    \n    return msg;\n}\ncatch(e){\n    //node.error(e)\n    \n    msg.payload = odds;\n    msg.error = e;\n    \n    return msg;\n}","outputs":1,"noerr":0,"x":190,"y":280,"wires":[["fe363595.1a1db8"]]},{"id":"fe363595.1a1db8","type":"split","z":"dd2ff415.75e098","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":350,"y":280,"wires":[["6c5a93dd.a078bc"]]},{"id":"5ac11c41.8a4b24","type":"switch","z":"4bfab75c.41da68","name":"","property":"payload","propertyType":"msg","rules":[{"t":"jsonata_exp","v":"$count(msg.payload)>0","vt":"jsonata"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2990,"y":260,"wires":[["ccd1d0a5.be68b"],[]]},{"id":"52fb9c9e.bb5134","type":"function","z":"52f2656a.61247c","name":"","func":"var DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nvar odd_mapper = function(raw, type, expires_on){\n    \n    try{\n        let sign = parseInt((type===\"Over/Under\") ? \"-1\" : \"1\");\n        \n        let odd = {\n            \"event_name\"    :  raw.event.official,\n            \"event_date\"    :  raw.event.date,\n            \"event_score\"   :  raw.event.score,\n            \"event_score_1\"   :  parseFloat(raw.event.score_1),\n            \"event_score_2\"   :  parseFloat(raw.event.score_2),\n            \n            \"event_minute\"  :  parseFloat(raw.event.minute),\n            \"league_name\"   :  raw.event.league.name,\n            \"sport_name\"    :  raw.event.sport.name,\n            \"site_name\"     :  msg.website.name,\n            \"type\"          :  type,\n            \"expires_on\"    :  expires_on,\n            \"id_1\"          :  raw[0][0].replace(\"__\",\"\"),\n            \"id_1_number\"   :  parseInt(raw[0][0].replace(\"__\",\"\").replace(/_/g,\"\")),\n            \n            \"money_line_1\"  :  parseFloat(raw[0][1]),\n            \"run_line_1\"    :  parseFloat((raw.length>2) ? 1 : parseFloat((raw[0][2]==\"pk\") ? 0 : raw[0][2])),\n        \n            \"id_2\"          :  raw[1][0].replace(\"__\",\"\"),\n            \"id_2_number\"   :  parseInt(raw[1][0].replace(\"__\",\"\").replace(/_/g,\"\")),\n            \n            \"money_line_2\"  :  parseFloat(raw[1][1]),\n            \"run_line_2\"    :  parseFloat(sign * ((raw.length>2) ? 1 : parseFloat((raw[1][2]==\"pk\") ? 0 : raw[1][2]))),\n            \n            \"id_0\"          :  (raw.length>2) ? raw[2][0].replace(\"__\",\"\") : null,\n            \"money_line_0\"  :  (raw.length>2) ? parseFloat(raw[2][1]) : null,\n            \"run_line_0\"    :  (raw.length>2) ? parseFloat(1) : null\n        };\n        \n        odd.run_line = odd.run_line_1 + '/' + odd.run_line_2;\n        \n        return odd;\n    }\n    catch(e){\n        msg.error = e.message;\n    }\n}\n\nDate.prototype.getRoundHours = function() {\n  var mm = this.getMonth() + 1; // getMonth() is zero-based\n  var dd = this.getDate();\n  \n  return [this.getFullYear()     + '-',\n          (mm>9 ? '' : '0') + mm + '-',\n          (dd>9 ? '' : '0') + dd ,\n         ].join('');\n};\n\nlet odds = [];\n\ntry{\n    \n    let event_date = new Date();\n    let event_rounded_date = event_date.getRoundHours();\n\n    let event_hour = msg.data.date.replace('<span class=\"tablo_time\">','').replace('</span>','');\n    \n    event_date = new Date(event_rounded_date.toString() + ' ' + event_hour + \":00\");\n    \n    let event = {\n        \"name\" : (msg.data.teams[0] + ' vs ' + msg.data.teams[1]).toLowerCase(),\n        \"official\": (msg.google.result.length>0) ? msg.google.result[0].toLowerCase() : (msg.data.teams[0] + ' vs ' + msg.data.teams[1]).toLowerCase(),\n        \"participants\" : msg.data.teams.map(team => {return team.toLowerCase()}),\n        \"date\" : event_date.getTime(),\n        \"score\" : (msg.data.hasOwnProperty(\"add_inf\") && msg.data.add_inf!==null) ? ((msg.data.add_inf.hasOwnProperty(\"sc1\")) ? msg.data.add_inf.sc1 : 0) + ' - ' + ((msg.data.add_inf.hasOwnProperty(\"sc2\")) ? msg.data.add_inf.sc2 : 0) : '0 - 0',\n        \"score_1\" : (msg.data.hasOwnProperty(\"add_inf\") && msg.data.add_inf!==null) ? ((msg.data.add_inf.hasOwnProperty(\"sc1\")) ? msg.data.add_inf.sc1 : 0) : 0,\n        \"score_2\" : (msg.data.hasOwnProperty(\"add_inf\") && msg.data.add_inf!==null) ? ((msg.data.add_inf.hasOwnProperty(\"sc2\")) ? msg.data.add_inf.sc2 : 0) : 0,\n        \"league\": {\"name\" : msg.data.league.toLowerCase()},\n        \"sport\": {\"name\" : msg.data.sport.toLowerCase()},\n        \"minute\": (msg.data.hasOwnProperty(\"add_inf\")  && msg.data.add_inf!==null) ? parseInt(msg.data.add_inf.minute.replace(\"'\")) : 0\n    }\n    \n    //let orig_odds = msg.data.sg[\"1\"];\n    msg.data = msg.data.sg[\"1\"];\n    msg.data.event = event;\n    \n    if(msg.data.hasOwnProperty(\"ft\")){\n        \n        if(msg.data.ft.hasOwnProperty(\"1x2\")){\n            odd = msg.data.ft[\"1x2\"];\n            odd.event = msg.data.event;\n            odds.push(odd_mapper(odd,\"1x2\",\"Full Time\"))\n        }\n        \n        if(msg.data.ft.hasOwnProperty(\"ou\")){\n            msg.data.ft.ou.forEach(odd => {\n                odd.event = msg.data.event;\n                odds.push(odd_mapper(odd,\"Over/Under\",\"Full Time\"))\n            })\n        }\n        \n        if(msg.data.ft.hasOwnProperty(\"ah\")){\n            msg.data.ft.ah.forEach(odd => {\n                odd.event = msg.data.event;\n                odds.push(odd_mapper(odd,\"Handicap\",\"Full Time\"))\n            })\n        }\n    }\n      \n    if(msg.data.hasOwnProperty(\"ht\")){\n        \n        if(msg.data.ht.hasOwnProperty(\"1x2\")){\n            odd = msg.data.ht[\"1x2\"];\n            odd.event = msg.data.event;\n            odds.push(odd_mapper(odd,\"1x2\",\"1st Half\"))\n        }\n        \n        if(msg.data.ht.hasOwnProperty(\"ou\")){\n            msg.data.ht.ou.forEach(odd => {\n                odd.event = msg.data.event;\n                odds.push(odd_mapper(odd,\"Over/Under\",\"1st Half\"))\n            })\n        }\n        \n        if(msg.data.ht.hasOwnProperty(\"ah\")){\n            msg.data.ht.ah.forEach(odd => {\n                odd.event = msg.data.event;\n                odds.push(odd_mapper(odd,\"Handicap\",\"1st Half\"))\n            })\n        }\n    }\n    \n    //log(msg.page.website.name + ' -- Finish Transformation, got ' + odds.length + ' rows');\n    \n    /*odds = odds.map(odd => {\n        Object.keys(odd).map(function(key, index) {\n           odd[key] = (odd[key]===null || odd[key]===undefined) ? \"-1\" : odd[key];\n        });\n    })*/\n}\ncatch(e){\n    //node.error(e);\n    msg.error = e.message;\n}\n\nmsg.payload = odds;\n\nreturn msg;","outputs":1,"noerr":0,"x":138.01953125,"y":330.00390625,"wires":[["9f5860af.d57d4"]]},{"id":"b74c1b39.db8448","type":"change","z":"52f2656a.61247c","name":"","rules":[{"t":"set","p":"payload.timestamp","pt":"msg","to":"","tot":"date"},{"t":"set","p":"payload.id","pt":"msg","to":"$base64encode($lowercase(msg.payload.site_name & ';' & msg.payload.id_1 & ';' & msg.payload.id_2))","tot":"jsonata"},{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":320,"wires":[[]]},{"id":"6d260328.cbc28c","type":"json","z":"e6cabfa4.fd5d9","name":"","property":"payload","action":"str","pretty":false,"x":2070,"y":340,"wires":[[]]},{"id":"ccd1d0a5.be68b","type":"change","z":"4bfab75c.41da68","name":"Set topic","rules":[{"t":"set","p":"topic","pt":"msg","to":"staging-odds","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3140,"y":220,"wires":[["77d9db32.ac2ae4"]]},{"id":"77d9db32.ac2ae4","type":"json","z":"4bfab75c.41da68","name":"","property":"payload","action":"str","pretty":false,"x":3270,"y":220,"wires":[[]]},{"id":"9e7487af.61a6c8","type":"change","z":"e86e33b6.b81da","name":"","rules":[{"t":"set","p":"documentIndex","pt":"msg","to":"$lowercase(msg.topic) & \"-\" & $replace($split($now(), \"T\", 1) [0],\"-\",\".\")","tot":"jsonata"},{"t":"set","p":"documentType","pt":"msg","to":"doc","tot":"str"},{"t":"set","p":"documentId","pt":"msg","to":"_msgid","tot":"msg"},{"t":"set","p":"timestamp","pt":"msg","to":"payload.timestamp","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":480,"y":120,"wires":[["6a8b756d.6a28bc"]]},{"id":"6a8b756d.6a28bc","type":"delay","z":"e86e33b6.b81da","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"50","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":660,"y":120,"wires":[["d60aff57.c91c5"]]},{"id":"adc75962.fcaa08","type":"subflow:e6cabfa4.fd5d9","z":"72706932.2ca048","name":"Site 1","x":890,"y":180,"wires":[["34e72195.40850e","4a71e3b5.f78e4c"]]},{"id":"12cad362.3fb40d","type":"change","z":"e6cabfa4.fd5d9","name":"","rules":[{"t":"set","p":"payload.id","pt":"msg","to":"$base64encode($lowercase(msg.payload.source_name & ';' & msg.payload.name ))","tot":"jsonata"},{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"},{"t":"set","p":"topic","pt":"msg","to":"ONEBETPRO_EVENT","tot":"str"},{"t":"set","p":"key","pt":"msg","to":"payload.id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1880,"y":300,"wires":[["6d260328.cbc28c"]]},{"id":"34e72195.40850e","type":"rdkafka out","z":"72706932.2ca048","name":"Kafka","topic":"","key":"","partition":-1,"broker":"c0e67585.074708","x":1070,"y":180,"wires":[]},{"id":"c461f01e.72102","type":"json","z":"920d75bc.d0fe08","name":"","property":"payload","action":"str","pretty":false,"x":4930,"y":420,"wires":[[]]},{"id":"edaa37f9.b99ea8","type":"rdkafka out","z":"72706932.2ca048","name":"Kafka","topic":"","key":"","partition":-1,"broker":"c0e67585.074708","x":1070,"y":300,"wires":[]},{"id":"fd8d5a67.a51c28","type":"subflow:4bfab75c.41da68","z":"72706932.2ca048","name":"Site 2","x":890,"y":240,"wires":[["2045e262.eba16e"]]},{"id":"a77eec79.be5f4","type":"function","z":"4bfab75c.41da68","name":"Transform","func":"var DEBUG=msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nfunction odd_mapper(raw, type, expires_on){\n    \n    try{\n            \n        let codes = {\n            \"Full Time\" :\"FT\",\n            \"1st Half\" : \"FH\",\n            \"1x2\" : \"1X2\",\n            \"Handicap\" : \"HDP\",\n            \"Over/Under\" : \"OU\"\n        }\n        \n        let opponent_1 = (type === \"Over/Under\") ? \"o\" : \"h\";\n        let opponent_2 = (type === \"Over/Under\") ? \"u\" : \"a\";\n        let opponent_0 = (type === \"1x2\") ? \"d\" : null;\n\n        let sign = parseInt((type === \"Over/Under\") ? \"-1\" : \"1\");\n\n        let odd = {\n            \"event_name\"    :  raw.event.official,\n            \"event_date\"    :  raw.event.date,\n            \"event_score\"   :  raw.event.score,\n            \"event_score_1\"   :  parseFloat(raw.event.score_1),\n            \"event_score_2\"   :  parseFloat(raw.event.score_2),\n            \n            \"event_minute\"  :  parseFloat(raw.event.minute),\n            \"league_name\"   :  raw.event.league.name,\n            \"sport_name\"    :  raw.event.sport.name,\n            \"site_name\"     :  msg.website.name,\n            \"type\"          :  type,\n            \"expires_on\"    :  expires_on,\n            \"id_1\"          :  (raw.id_e + codes[expires_on] + '_' + codes[type] + '_' + opponent_1 + '_' + raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_1 + \"_op\"].toString()).trim().replace(\" \",\"\"),\n            \"money_line_1\"  :  parseFloat(raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_1].toString().trim().replace(\" \",\"\")),\n            \"run_line_1\"    :  parseFloat(raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_1 + \"_op\"].toString().trim().replace(\" \",\"\")),\n            \"id_2\"          :  (raw.id_e + codes[expires_on] + '_' + codes[type] + '_' + opponent_2 + '_' + raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_2 + \"_op\"].toString()).trim().replace(\" \",\"\"),\n            \"money_line_2\"  :  parseFloat(raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_2].toString().trim().replace(\" \",\"\")),\n            \"run_line_2\"    :  sign * parseFloat(raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_2 + \"_op\"].toString().trim().replace(\" \",\"\")),\n            \"id_0\"          :  opponent_0!==null ? (raw.id_e + codes[expires_on] + '_' + codes[type] + '_' + opponent_0).trim().replace(\" \",\"\") : null,\n            \"money_line_0\"  :  opponent_0!==null ? parseFloat(raw[codes[expires_on] + '_' + codes[type] + '_' + opponent_0].toString().trim().replace(\" \",\"\")) : null,\n            \"run_line_0\"    :  opponent_0!==null ? parseFloat(1) : null\n        }\n        \n        odd.run_line = odd.run_line_1 + '/' + odd.run_line_2;\n        \n        odd.id_1_number = parseInt(odd.odd.id_1);\n        odd.id_2_number = parseInt(odd.odd.id_2);\n        \n        return odd;\n    }\n    catch(e){\n        msg.error = e.message;\n        msg.type=type;\n        msg.expires_on = expires_on;\n        msg.opponent_1 = opponent_1;\n        msg.opponent_2 = opponent_2;\n        msg.opponent_0 = opponent_0;\n        log('odd_mapper error : ' + e.message);// + ' ' + JSON.stringify(event))\n    }\n}\n\nDate.prototype.getRoundHours = function() {\n  var mm = this.getMonth() + 1; // getMonth() is zero-based\n  var dd = this.getDate();\n  var hh = this.getHours();\n  \n  return [this.getFullYear()     + '-',\n          (mm>9 ? '' : '0') + mm + '-',\n          (dd>9 ? '' : '0') + dd + 'T',\n          (hh>9 ? '' : '0') + hh + ':00:00.000Z',\n         ].join('');\n};\n\nlet odds = [];\n\ntry{\n    \n    let event_date = new Date();\n    let event_rounded_date = event_date.getRoundHours();\n\n    let event_minute = parseInt(msg.data.date);\n    \n    if(msg.data.date.includes(\"LIVE\") || msg.data.date.includes(\"Half Time\")){\n        event_date = event_rounded_date;\n        //event_minute = 0;\n    }\n    else if(event_minute>=0){\n        \n        event_date.setMinutes(event_date.getMinutes() - event_minute);\n        event_date.setMinutes(event_date.getMinutes() - (event_date.getMinutes() % 5));\n        \n        event_date.setSeconds(\"00\");\n        event_date.setMilliseconds(\"000\");\n        \n        event_minute = event_minute;\n    }\n    else{\n        event_date = \"1900-01-01T00:00:00.000Z\";\n        event_minute = -1;\n    }\n    \n    //event_date = event_date.toString().replace(\"T\",\" \").replace(\".000Z\",\"\");\n    \n    msg.data.score_h = isNaN(parseInt(msg.data.score_h)) ? 0 : parseInt(msg.data.score_h)\n    msg.data.score_a = isNaN(parseInt(msg.data.score_a)) ? 0 : parseInt(msg.data.score_a)\n    \n    msg.data.score_h = msg.data.score_h===null ? 0 : msg.data.score_h;\n    msg.data.score_a = msg.data.score_a===null ? 0 : msg.data.score_a;\n\n    msg.data.event= {\n            name: (msg.data.home_team + ' vs ' + msg.data.away_team).toLowerCase(),\n            official: msg.google.result.length>0 ? msg.google.result[0].toLowerCase() : (msg.data.home_team + ' vs ' + msg.data.away_team).toLowerCase(),\n            date: event_date.getTime(),\n            participants: [msg.data.home_team.toLowerCase(),msg.data.away_team.toLowerCase()],\n            score: msg.data.score_h + ' - ' + msg.data.score_a,\n            score_1: msg.data.score_h,\n            score_2: msg.data.score_a,\n            minute: event_minute,\n            league: {\n                name: msg.league.liga.toLowerCase()\n            },\n            sport: {\n                name: msg.league.sport.toLowerCase()\n            }\n        };\n     \n    // 1x2\n    // Full Time \n    if(msg.data.hasOwnProperty(\"FT_1X2_h\") && msg.data.hasOwnProperty(\"FT_1X2_a\")){\n        try{\n            odds.push(odd_mapper(msg.data,\"1x2\",\"Full Time\"))\n        }\n        catch(e){\n            log(e.message)\n        }\n    }\n    \n    // 1st Half\n    if(msg.data.hasOwnProperty(\"FH_1X2_h\") && msg.data.hasOwnProperty(\"FH_1X2_a\")){\n        try{\n            odds.push(odd_mapper(msg.data,\"1x2\",\"1st Half\"))\n        }\n        catch(e){\n            log(e.message)\n        }\n    }\n    \n    // Handicap\n    // Full Time\n    if(msg.data.hasOwnProperty(\"FT_HDP_h\") && msg.data.hasOwnProperty(\"FT_HDP_a\")){\n        try{\n            odds.push(odd_mapper(msg.data,\"Handicap\",\"Full Time\"))\n        }\n        catch(e){\n            log(e.message)\n        }\n    } \n    \n    // 1st Half\n    if(msg.data.hasOwnProperty(\"FH_HDP_h\") && msg.data.hasOwnProperty(\"FH_HDP_a\")){\n        try{\n            odds.push(odd_mapper(msg.data,\"Handicap\",\"1st Half\"))\n        }\n        catch(e){\n            log(e.message)\n        }\n    } \n    \n    // Over/Under\n    // Full Time\n    if(msg.data.hasOwnProperty(\"FT_OU_o\") && msg.data.hasOwnProperty(\"FT_OU_u\")){\n        try{\n            odds.push(odd_mapper(msg.data,\"Over/Under\",\"Full Time\"))\n        }\n        catch(e){\n            log(e.message)\n        }\n    }\n    \n    // Over/Under\n    // 1st Half\n    if(msg.data.hasOwnProperty(\"FH_OU_o\") && msg.data.hasOwnProperty(\"FH_OU_u\")){\n        try{\n            \n            odds.push(odd_mapper(msg.data,\"Over/Under\",\"1st Half\"));\n            \n        }\n        catch(e){\n            log(e.message)\n        }\n    }\n    \n    msg.payload = odds;\n    \n    return msg;\n}\ncatch(e){\n    //node.error(e)\n    \n    msg.payload = odds;\n    msg.error = e;\n    \n    return msg;\n}","outputs":1,"noerr":0,"x":2550,"y":260,"wires":[["abf60163.ad25b"]]},{"id":"abf60163.ad25b","type":"split","z":"4bfab75c.41da68","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":2690,"y":260,"wires":[["f2ceb493.e3ce68"]]},{"id":"f2ceb493.e3ce68","type":"change","z":"4bfab75c.41da68","name":"","rules":[{"t":"set","p":"payload.timestamp","pt":"msg","to":"","tot":"date"},{"t":"set","p":"payload.id","pt":"msg","to":"$base64encode($lowercase(msg.payload.site_name & ';' & msg.payload.id_1 & ';' & msg.payload.id_2))","tot":"jsonata"},{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":2840,"y":260,"wires":[["5ac11c41.8a4b24"]]},{"id":"2045e262.eba16e","type":"rdkafka out","z":"72706932.2ca048","name":"Kafka","topic":"","key":"","partition":-1,"broker":"c0e67585.074708","x":1070,"y":240,"wires":[]},{"id":"d60aff57.c91c5","type":"es-create","z":"e86e33b6.b81da","name":"","documentIndex":"","documentType":"","server":"43749542.37d54c","x":850,"y":120,"wires":[[]]},{"id":"621c66a5.371f88","type":"function","z":"e6cabfa4.fd5d9","name":"Normalize Event","func":"var DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nDate.prototype.getRoundHours = function() {\n  var mm = this.getMonth() + 1; // getMonth() is zero-based\n  var dd = this.getDate();\n  \n  return [this.getFullYear()     + '-',\n          (mm>9 ? '' : '0') + mm + '-',\n          (dd>9 ? '' : '0') + dd ,\n         ].join('');\n};\n\nmsg.error = null;\n\ntry{\n    \n    let event_date = new Date();\n    let event_rounded_date = event_date.getRoundHours();\n\n    let event_hour = msg.payload.date.replace('<span class=\"tablo_time\">','').replace('</span>','');\n    \n    event_date = new Date(event_rounded_date.toString() + ' ' + event_hour + \":00\");\n    \n    msg.payload = {\n        \"name\" : (msg.payload.teams[0] + ' vs ' + msg.payload.teams[1]).toLowerCase(),\n        \"source_name\" : \"1betpro\",\n        \"keywords\" : (msg.payload.teams[0] + ' vs ' + msg.payload.teams[1]).toLowerCase(),\n        \"league_name\" : msg.payload.league.toLowerCase(),\n        \"sport_name\" : msg.payload.sport.toLowerCase(),\n        \"minute\": (msg.payload.hasOwnProperty(\"add_inf\")  && msg.payload.add_inf!==null) ? parseInt(msg.payload.add_inf.minute.replace(\"'\")) : 0,\n        \"date\" : event_date.getTime(),\n        \"score\" : (msg.payload.hasOwnProperty(\"add_inf\") && msg.payload.add_inf!==null) ? ((msg.payload.add_inf.hasOwnProperty(\"sc1\")) ? msg.payload.add_inf.sc1 : 0) + ' - ' + ((msg.payload.add_inf.hasOwnProperty(\"sc2\")) ? msg.payload.add_inf.sc2 : 0) : '0 - 0',\n        \"score_1\" : (msg.payload.hasOwnProperty(\"add_inf\") && msg.payload.add_inf!==null) ? ((msg.payload.add_inf.hasOwnProperty(\"sc1\")) ? msg.payload.add_inf.sc1 : 0) : 0,\n        \"score_2\" : (msg.payload.hasOwnProperty(\"add_inf\") && msg.payload.add_inf!==null) ? ((msg.payload.add_inf.hasOwnProperty(\"sc2\")) ? msg.payload.add_inf.sc2 : 0) : 0,\n        \"timestamp\" : (new Date()).getTime(),\n        \"sg\": msg.payload.sg\n    }\n    \n}\ncatch(e){\n    msg.payload = null;\n    msg.error = e.message;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1700,"y":300,"wires":[["12cad362.3fb40d"]]},{"id":"eecca55b.9c0bb8","type":"inject","z":"a0f9326d.620a8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":140,"wires":[["dad3f7db.2ebd58"]]},{"id":"dad3f7db.2ebd58","type":"change","z":"a0f9326d.620a8","name":"TOPIC_GOOGLE_SEARCH","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\t    \"keywords\" : $string(msg.payload),\t    \"first_result\":\"abc\",\t    \"timestamp\" : msg.payload\t}","tot":"jsonata"},{"t":"set","p":"topic","pt":"msg","to":"GOOGLE_SEARCH","tot":"str"},{"t":"set","p":"key","pt":"msg","to":"payload.keywords","tot":"msg"},{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":440,"y":140,"wires":[["f0abbef4.c832c"]]},{"id":"d93fca65.01e978","type":"rdkafka out","z":"a0f9326d.620a8","name":"Kafka","topic":"","key":"","partition":-1,"broker":"c0e67585.074708","x":790,"y":140,"wires":[]},{"id":"cf95ff53.e2cc7","type":"change","z":"a0f9326d.620a8","name":"Set Google Keywords","rules":[{"t":"set","p":"data","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"google","pt":"msg","to":"{\t    \"q\" : $replace($lowercase(msg.payload.teams[0] & ' vs ' & msg.payload.teams[1]),\" \",\"+\"),\t    \"key\": \"google_session_test3\"\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":240,"y":320,"wires":[["c091ca7d.3671a8"]]},{"id":"c091ca7d.3671a8","type":"subflow:987d9c15.b3c5","z":"a0f9326d.620a8","name":"","x":440,"y":320,"wires":[["c2b0ab5d.2d6d58"]]},{"id":"c2b0ab5d.2d6d58","type":"function","z":"a0f9326d.620a8","name":"Transform","func":"var DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nvar odd_mapper = function(raw, type, expires_on){\n    \n    try{\n        let sign = parseInt((type===\"Over/Under\") ? \"-1\" : \"1\");\n        \n        let odd = {\n            \"event_name\"    :  raw.event.official,\n            \"event_date\"    :  raw.event.date,\n            \"event_score\"   :  raw.event.score,\n            \"event_score_1\"   :  parseFloat(raw.event.score_1),\n            \"event_score_2\"   :  parseFloat(raw.event.score_2),\n            \n            \"event_minute\"  :  parseFloat(raw.event.minute),\n            \"league_name\"   :  raw.event.league.name,\n            \"sport_name\"    :  raw.event.sport.name,\n            \"site_name\"     :  msg.website.name,\n            \"type\"          :  type,\n            \"expires_on\"    :  expires_on,\n            \"id_1\"          :  raw[0][0].replace(\"__\",\"\"),\n            \"id_1_number\"   :  parseInt(raw[0][0].replace(\"__\",\"\").replace(/_/g,\"\")),\n            \n            \"money_line_1\"  :  parseFloat(raw[0][1]),\n            \"run_line_1\"    :  parseFloat((raw.length>2) ? 1 : parseFloat((raw[0][2]==\"pk\") ? 0 : raw[0][2])),\n        \n            \"id_2\"          :  raw[1][0].replace(\"__\",\"\"),\n            \"id_2_number\"   :  parseInt(raw[1][0].replace(\"__\",\"\").replace(/_/g,\"\")),\n            \n            \"money_line_2\"  :  parseFloat(raw[1][1]),\n            \"run_line_2\"    :  parseFloat(sign * ((raw.length>2) ? 1 : parseFloat((raw[1][2]==\"pk\") ? 0 : raw[1][2]))),\n            \n            \"id_0\"          :  (raw.length>2) ? raw[2][0].replace(\"__\",\"\") : null,\n            \"money_line_0\"  :  (raw.length>2) ? parseFloat(raw[2][1]) : null,\n            \"run_line_0\"    :  (raw.length>2) ? parseFloat(1) : null\n        };\n        \n        odd.run_line = odd.run_line_1 + '/' + odd.run_line_2;\n        \n        return odd;\n    }\n    catch(e){\n        msg.error = e.message;\n    }\n}\n\nDate.prototype.getRoundHours = function() {\n  var mm = this.getMonth() + 1; // getMonth() is zero-based\n  var dd = this.getDate();\n  \n  return [this.getFullYear()     + '-',\n          (mm>9 ? '' : '0') + mm + '-',\n          (dd>9 ? '' : '0') + dd ,\n         ].join('');\n};\n\nlet odds = [];\n\ntry{\n    \n    let event_date = new Date();\n    let event_rounded_date = event_date.getRoundHours();\n\n    let event_hour = msg.data.date.replace('<span class=\"tablo_time\">','').replace('</span>','');\n    \n    event_date = new Date(event_rounded_date.toString() + ' ' + event_hour + \":00\");\n    \n    let event = {\n        \"name\" : (msg.data.teams[0] + ' vs ' + msg.data.teams[1]).toLowerCase(),\n        \"official\": (msg.google.result.length>0) ? msg.google.result[0].toLowerCase() : (msg.data.teams[0] + ' vs ' + msg.data.teams[1]).toLowerCase(),\n        \"participants\" : msg.data.teams.map(team => {return team.toLowerCase()}),\n        \"date\" : event_date.getTime(),\n        \"score\" : (msg.data.hasOwnProperty(\"add_inf\") && msg.data.add_inf!==null) ? ((msg.data.add_inf.hasOwnProperty(\"sc1\")) ? msg.data.add_inf.sc1 : 0) + ' - ' + ((msg.data.add_inf.hasOwnProperty(\"sc2\")) ? msg.data.add_inf.sc2 : 0) : '0 - 0',\n        \"score_1\" : (msg.data.hasOwnProperty(\"add_inf\") && msg.data.add_inf!==null) ? ((msg.data.add_inf.hasOwnProperty(\"sc1\")) ? msg.data.add_inf.sc1 : 0) : 0,\n        \"score_2\" : (msg.data.hasOwnProperty(\"add_inf\") && msg.data.add_inf!==null) ? ((msg.data.add_inf.hasOwnProperty(\"sc2\")) ? msg.data.add_inf.sc2 : 0) : 0,\n        \"league\": {\"name\" : msg.data.league.toLowerCase()},\n        \"sport\": {\"name\" : msg.data.sport.toLowerCase()},\n        \"minute\": (msg.data.hasOwnProperty(\"add_inf\")  && msg.data.add_inf!==null) ? parseInt(msg.data.add_inf.minute.replace(\"'\")) : 0\n    }\n    \n    //let orig_odds = msg.data.sg[\"1\"];\n    msg.data = msg.data.sg[\"1\"];\n    msg.data.event = event;\n    \n    if(msg.data.hasOwnProperty(\"ft\")){\n        \n        if(msg.data.ft.hasOwnProperty(\"1x2\")){\n            odd = msg.data.ft[\"1x2\"];\n            odd.event = msg.data.event;\n            odds.push(odd_mapper(odd,\"1x2\",\"Full Time\"))\n        }\n        \n        if(msg.data.ft.hasOwnProperty(\"ou\")){\n            msg.data.ft.ou.forEach(odd => {\n                odd.event = msg.data.event;\n                odds.push(odd_mapper(odd,\"Over/Under\",\"Full Time\"))\n            })\n        }\n        \n        if(msg.data.ft.hasOwnProperty(\"ah\")){\n            msg.data.ft.ah.forEach(odd => {\n                odd.event = msg.data.event;\n                odds.push(odd_mapper(odd,\"Handicap\",\"Full Time\"))\n            })\n        }\n    }\n      \n    if(msg.data.hasOwnProperty(\"ht\")){\n        \n        if(msg.data.ht.hasOwnProperty(\"1x2\")){\n            odd = msg.data.ht[\"1x2\"];\n            odd.event = msg.data.event;\n            odds.push(odd_mapper(odd,\"1x2\",\"1st Half\"))\n        }\n        \n        if(msg.data.ht.hasOwnProperty(\"ou\")){\n            msg.data.ht.ou.forEach(odd => {\n                odd.event = msg.data.event;\n                odds.push(odd_mapper(odd,\"Over/Under\",\"1st Half\"))\n            })\n        }\n        \n        if(msg.data.ht.hasOwnProperty(\"ah\")){\n            msg.data.ht.ah.forEach(odd => {\n                odd.event = msg.data.event;\n                odds.push(odd_mapper(odd,\"Handicap\",\"1st Half\"))\n            })\n        }\n    }\n    \n    //log(msg.page.website.name + ' -- Finish Transformation, got ' + odds.length + ' rows');\n    \n    /*odds = odds.map(odd => {\n        Object.keys(odd).map(function(key, index) {\n           odd[key] = (odd[key]===null || odd[key]===undefined) ? \"-1\" : odd[key];\n        });\n    })*/\n}\ncatch(e){\n    //node.error(e);\n    msg.error = e.message;\n}\n\nmsg.payload = odds;\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":320,"wires":[["71ff591f.094aa8"]]},{"id":"71ff591f.094aa8","type":"split","z":"a0f9326d.620a8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":750,"y":320,"wires":[[]]},{"id":"9907ab23.9c06b8","type":"subflow:987d9c15.b3c5","z":"72706932.2ca048","name":"","x":885.9999961853027,"y":512.9999980926514,"wires":[["9c5a0d92.9772e"]]},{"id":"5c76d8b3.46a718","type":"switch","z":"63981055.15fda","name":"GOOGLE_SESSION_CREATED","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"GOOGLE_SESSION_CREATED","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1360,"y":160,"wires":[[]]},{"id":"a60744de.59c4f8","type":"function","z":"63981055.15fda","name":"Google Session","func":"'use strict';\n\nvar DEBUG = msg.debug; // Enable logging\n\nvar log = function(){\n    if(DEBUG){\n        console.log.apply(console, arguments);\n    }\n}\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    \n    const browser = await puppeteer.launch({args: ['--no-sandbox', '--disable-setuid-sandbox', '--shm-size=1gb', '--disable-dev-shm-usage']});\n    let page = await browser.newPage();\n  \n    let ip = \"0.0.0.0\";\n    \n    try{\n       \n        log('Google -- Search for my ip');\n\n        await page.goto('https://www.google.com/search?q=whats+my+ip');\n        \n        log('Google -- Wait For Selector');\n        \n        const resultsSelector = \"w-answer-desktop\";\n        \n        await page.waitForSelector(resultsSelector);\n\n        log('Google -- Get your ip');\n    \n        // Extract the results from the page.\n        const result = await page.evaluate(resultsSelector => {\n            const anchors = Array.from(document.querySelectorAll(resultsSelector));\n            return anchors.map(anchor => {\n                const ip = anchor.textContent.replace(\"Your public IP address\",\"\");\n                return `${ip}`;\n            });\n        }, resultsSelector);\n        \n        if(Array.isArray(result) && result.length>0){\n            ip = result[0];\n            log('Google -- Your ip is ' + ip);\n        }\n        \n        log('Google -- saving cookies')\n        const cookies = await page.cookies()\n        \n        log('Google -- getting current url')\n        const url = await page.evaluate(() => location.href);\n              \n        msg.google.session = {\n            ip: ip,\n            cookies: cookies,\n            timestamp: Date.now()\n        }\n        \n        msg.payload =[msg.google.key,JSON.stringify(msg.google.session)]\n        \n        msg.topic = 'GOOGLE_SESSION_CREATED';\n        \n        node.send(msg);\n        \n        log('Google -- Sending a ' + msg.topic + ' message');\n        \n        await page.close();\n        await browser.close();\n      \n    }\n    catch(e){\n        \n        await page.close();\n        await browser.close();\n        \n        node.error(e);\n    }\n})();","outputs":1,"noerr":0,"x":1120,"y":160,"wires":[["5c76d8b3.46a718"]]},{"id":"f523bf20.4abe3","type":"change","z":"aca500a5.26ea7","name":"Set topic","rules":[{"t":"set","p":"topic","pt":"msg","to":"$uppercase(msg.flow & '_tasks')","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1240,"y":380,"wires":[["f721cae3.107988","87cc6828.3edc08"]]},{"id":"90443b65.a1a688","type":"switch","z":"72706932.2ca048","name":"Topic Router","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"ALBERT_TASKS","vt":"str"},{"t":"eq","v":"ALBERT_GOOGLE_QUERIES_STREAM","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":370,"y":320,"wires":[["f522eff1.97f54"],["18a35108.0f551f"]]},{"id":"f000c3f9.59cfb","type":"change","z":"e6cabfa4.fd5d9","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"$uppercase(msg.flow & '_tasks' )","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1890,"y":380,"wires":[["6d260328.cbc28c"]]},{"id":"f0abbef4.c832c","type":"json","z":"a0f9326d.620a8","name":"","property":"payload","action":"str","pretty":false,"x":650,"y":140,"wires":[["d93fca65.01e978","af343738.7b9358"]]},{"id":"af343738.7b9358","type":"debug","z":"a0f9326d.620a8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":780,"y":220,"wires":[]},{"id":"18a35108.0f551f","type":"change","z":"72706932.2ca048","name":"","rules":[{"t":"set","p":"google","pt":"msg","to":"{\t    \"q\" : msg.payload.NAME\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":565.9999961853027,"y":512.9999980926514,"wires":[["9907ab23.9c06b8"]]},{"id":"f310d276.13075","type":"change","z":"987d9c15.b3c5","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"GOOGLE_SEARCH_RESULT","tot":"str"},{"t":"set","p":"payload.id","pt":"msg","to":"key","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":3440,"y":540,"wires":[["a7685b5e.6e2168"]]},{"id":"a7685b5e.6e2168","type":"json","z":"987d9c15.b3c5","name":"","property":"payload","action":"str","pretty":false,"x":3570,"y":540,"wires":[[]]},{"id":"9c5a0d92.9772e","type":"rdkafka out","z":"72706932.2ca048","name":"Kafka","topic":"","key":"","partition":-1,"broker":"c0e67585.074708","x":1075.9999961853027,"y":512.9999980926514,"wires":[]},{"id":"9a0eea4b.89db58","type":"dynamodb-in","z":"1f5b5275.d1abce","name":"","region":"us-east-1","table":"fb_accounts","operation":"putItem","json_ddb":"params.Item","ddb_json":"params.Item","detect":true,"x":630,"y":120,"wires":[[]]},{"id":"ff00bb34.b5cbd8","type":"dynamodb-in","z":"1f5b5275.d1abce","name":"","region":"us-east-1","table":"fb_ads","operation":"putItem","json_ddb":"params.Item","ddb_json":"params.Item","detect":true,"x":850,"y":140,"wires":[[]]},{"id":"2e292b0d.4abd14","type":"debug","z":"72706932.2ca048","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":367.5,"y":422.5,"wires":[]},{"id":"db638d85.09fcd","type":"debug","z":"72706932.2ca048","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1219.1367492675781,"y":299.07423973083496,"wires":[]},{"id":"e035feb8.0f1c8","type":"subflow:8f12258d.a834d8","z":"7744a89.2e26458","name":"","x":1930,"y":180.12500047683716,"wires":[["f7e86095.f0b16"],["f7e86095.f0b16"],["f7e86095.f0b16"]]},{"id":"b805e6b0.1b8008","type":"subflow:8f12258d.a834d8","z":"72706932.2ca048","name":"","x":920.8866996765137,"y":369.75002098083496,"wires":[["df2f529f.c505"],["af496842.86b978"],["dcb59039.cf933"]]},{"id":"bd26c61.d037738","type":"change","z":"8f12258d.a834d8","name":"","rules":[{"t":"set","p":"payload.id","pt":"msg","to":"$base64encode($lowercase($string(msg.payload.ad_id & ';' & msg.timestamp)))","tot":"jsonata"},{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"},{"t":"set","p":"topic","pt":"msg","to":"FACEBOOK_ADS_DATA","tot":"str"},{"t":"set","p":"key","pt":"msg","to":"payload.id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":3339.7696380615234,"y":182.00390815734863,"wires":[["826030c9.4d64f"]]},{"id":"826030c9.4d64f","type":"json","z":"8f12258d.a834d8","name":"","property":"payload","action":"str","pretty":false,"x":3541.769634246826,"y":182.00390815734863,"wires":[[]]},{"id":"df2f529f.c505","type":"rdkafka out","z":"72706932.2ca048","name":"Kafka","topic":"","key":"","partition":-1,"broker":"c0e67585.074708","x":1073.0195770263672,"y":356.00389766693115,"wires":[]},{"id":"af496842.86b978","type":"debug","z":"72706932.2ca048","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1207.769546508789,"y":392.00404167175293,"wires":[]},{"id":"dcb59039.cf933","type":"debug","z":"72706932.2ca048","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1212.26953125,"y":436.0039052963257,"wires":[]},{"id":"cbd17d9d.b7716","type":"change","z":"8f12258d.a834d8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.data","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1237.640625,"y":243.3828125,"wires":[["c0694fa4.fb584"]]},{"id":"60190f3.ff4b1f","type":"inject","z":"d7b93f55.8b40c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":202.89453125,"y":160.8984375,"wires":[["efac316b.05978"]]},{"id":"4a4a21fa.a4368","type":"template","z":"d7b93f55.8b40c","name":"","field":"payload","fieldType":"msg","format":"json","syntax":"mustache","template":"{\"ante\":0,\"board\":\"Qd7h6d\",\"bringIn\":0,\"cap\":0,\"carryOverFromLastHand\":0,\"carryOverToNextHand\":0,\"chipsType\":0,\"clubId\":0,\"currency\":\"USD\",\"dealer\":4,\"dealerSuppliedFreeChips\":0,\"finalFlightTournId\":0,\"finished\":\"2017-05-26 05:32:46\",\"game\":2,\"handFlags\":0,\"handId\":170930691511,\"hiBet\":25,\"history\":[{\"actions\":[{\"action8Bit\":112,\"amount\":10,\"contents\":\"\",\"epoch\":1495791144,\"eventCode\":1,\"ordinal\":1775,\"position\":5,\"userId\":\"AZCGCH\"},{\"action8Bit\":80,\"amount\":25,\"contents\":\"\",\"epoch\":1495791144,\"eventCode\":1,\"ordinal\":1776,\"position\":0,\"userId\":\"VMEH\"},{\"action8Bit\":0,\"amount\":2,\"contents\":\"AcJc\",\"epoch\":1495791144,\"eventCode\":2,\"ordinal\":1777,\"position\":0,\"userId\":\"VMEH\"},{\"action8Bit\":0,\"amount\":2,\"contents\":\"8sTc\",\"epoch\":1495791144,\"eventCode\":2,\"ordinal\":1778,\"position\":1,\"userId\":\"QHEJRW\"},{\"action8Bit\":0,\"amount\":2,\"contents\":\"KsQs\",\"epoch\":1495791144,\"eventCode\":2,\"ordinal\":1779,\"position\":2,\"userId\":\"SEPLE\"},{\"action8Bit\":0,\"amount\":2,\"contents\":\"8dKc\",\"epoch\":1495791144,\"eventCode\":2,\"ordinal\":1780,\"position\":3,\"userId\":\"MSLKNM\"},{\"action8Bit\":0,\"amount\":2,\"contents\":\"3h4s\",\"epoch\":1495791144,\"eventCode\":2,\"ordinal\":1781,\"position\":4,\"userId\":\"OXMSUW\"},{\"action8Bit\":0,\"amount\":2,\"contents\":\"6c4h\",\"epoch\":1495791144,\"eventCode\":2,\"ordinal\":1782,\"position\":5,\"userId\":\"AZCGCH\"},{\"action8Bit\":70,\"amount\":0,\"contents\":\"\",\"epoch\":1495791147,\"eventCode\":1,\"ordinal\":1783,\"position\":1,\"userId\":\"QHEJRW\"},{\"action8Bit\":69,\"amount\":62,\"contents\":\"\",\"epoch\":1495791151,\"eventCode\":1,\"ordinal\":1784,\"position\":2,\"userId\":\"SEPLE\"},{\"action8Bit\":70,\"amount\":0,\"contents\":\"\",\"epoch\":1495791151,\"eventCode\":1,\"ordinal\":1785,\"position\":3,\"userId\":\"MSLKNM\"},{\"action8Bit\":70,\"amount\":0,\"contents\":\"\",\"epoch\":1495791153,\"eventCode\":1,\"ordinal\":1786,\"position\":4,\"userId\":\"OXMSUW\"},{\"action8Bit\":70,\"amount\":0,\"contents\":\"\",\"epoch\":1495791154,\"eventCode\":1,\"ordinal\":1787,\"position\":5,\"userId\":\"AZCGCH\"},{\"action8Bit\":67,\"amount\":37,\"contents\":\"\",\"epoch\":1495791155,\"eventCode\":1,\"ordinal\":1788,\"position\":0,\"userId\":\"VMEH\"},{\"action8Bit\":0,\"amount\":134,\"contents\":\"\",\"epoch\":1495791155,\"eventCode\":5,\"ordinal\":1789,\"position\":0,\"userId\":\"\"},{\"action8Bit\":1,\"amount\":3,\"contents\":\"Qd7h6d\",\"epoch\":1495791155,\"eventCode\":2,\"ordinal\":1790,\"position\":-1,\"userId\":\"\"},{\"action8Bit\":99,\"amount\":0,\"contents\":\"\",\"epoch\":1495791156,\"eventCode\":1,\"ordinal\":1791,\"position\":0,\"userId\":\"VMEH\"},{\"action8Bit\":66,\"amount\":99,\"contents\":\"\",\"epoch\":1495791161,\"eventCode\":1,\"ordinal\":1792,\"position\":2,\"userId\":\"SEPLE\"},{\"action8Bit\":70,\"amount\":0,\"contents\":\"\",\"epoch\":1495791165,\"eventCode\":1,\"ordinal\":1793,\"position\":0,\"userId\":\"VMEH\"},{\"action8Bit\":114,\"amount\":99,\"contents\":\"\",\"epoch\":1495791165,\"eventCode\":7,\"ordinal\":1794,\"position\":2,\"userId\":\"SEPLE\"},{\"action8Bit\":0,\"amount\":128,\"contents\":\"H\",\"epoch\":1495791166,\"eventCode\":6,\"ordinal\":1795,\"position\":2,\"userId\":\"SEPLE\"}],\"handId\":170930691511}],\"historyZip\":[],\"isHiLo\":0,\"isOneOnOne\":6,\"loBet\":25,\"newGameFlag\":0,\"nextButtonPos\":-1,\"potSize\":134,\"rakeSize\":6,\"reqIdIgnore\":-1616813809,\"rit\":{},\"scalePlayMoney\":1,\"siteMaskInHand\":7051841,\"smallBlindSize\":10,\"started\":\"2017-05-26 05:32:24\",\"structure\":3,\"tableId\":3573889836,\"tableName\":\"Phegeus II\",\"tournId\":0,\"tournLevel\":0,\"tournType\":0,\"users\":[{\"userInHand\":{\"appLoginId\":2980021150,\"bestHand\":1,\"buyInTransId\":102403946215,\"cards\":\"AcJc\",\"clientBrand\":1,\"clientDevice\":1,\"combHi\":\"AcQdJc7h6d\",\"combLo\":\"\",\"dbStartAmount\":1156,\"delta\":-62,\"fpp\":0,\"fractionFpp\":14,\"ipAddr\":\"62.107.183.169\",\"licenseId\":256,\"position\":0,\"potChips\":62,\"result\":12309,\"startAmount\":1156,\"startingMana\":0,\"startingPowers\":[],\"unusedStacks\":0,\"unusedStacksHandStart\":0,\"userId\":\"VMEH\",\"userIntId\":\"ZNIHHX\"},\"userInHandExtra\":{\"arjelUserHash\":\"\"}},{\"userInHand\":{\"appLoginId\":2985578531,\"bestHand\":1,\"buyInTransId\":102404259505,\"cards\":\"8sTc\",\"clientBrand\":1,\"clientDevice\":1,\"combHi\":\"Tc8s\",\"combLo\":\"\",\"dbStartAmount\":3789,\"delta\":0,\"fpp\":0,\"fractionFpp\":0,\"ipAddr\":\"178.217.199.157\",\"licenseId\":512,\"position\":1,\"potChips\":0,\"result\":5,\"startAmount\":3789,\"startingMana\":0,\"startingPowers\":[],\"unusedStacks\":0,\"unusedStacksHandStart\":0,\"userId\":\"QHEJRW\",\"userIntId\":\"WPZSOD\"},\"userInHandExtra\":{\"arjelUserHash\":\"\"}},{\"userInHand\":{\"appLoginId\":2985417799,\"bestHand\":2,\"buyInTransId\":102403944107,\"cards\":\"KsQs\",\"clientBrand\":1,\"clientDevice\":1,\"combHi\":\"QsQdKs7h6d\",\"combLo\":\"\",\"dbStartAmount\":2500,\"delta\":66,\"fpp\":0,\"fractionFpp\":15,\"ipAddr\":\"88.195.120.233\",\"licenseId\":512,\"position\":2,\"potChips\":62,\"result\":266257,\"startAmount\":2500,\"startingMana\":0,\"startingPowers\":[],\"unusedStacks\":0,\"unusedStacksHandStart\":0,\"userId\":\"SEPLE\",\"userIntId\":\"SEPLE\"},\"userInHandExtra\":{\"arjelUserHash\":\"\"}},{\"userInHand\":{\"appLoginId\":2985650154,\"bestHand\":1,\"buyInTransId\":102405196305,\"cards\":\"8dKc\",\"clientBrand\":1,\"clientDevice\":1,\"combHi\":\"Kc8d\",\"combLo\":\"\",\"dbStartAmount\":3269,\"delta\":0,\"fpp\":0,\"fractionFpp\":0,\"ipAddr\":\"37.25.119.155\",\"licenseId\":0,\"position\":3,\"potChips\":0,\"result\":5,\"startAmount\":3269,\"startingMana\":0,\"startingPowers\":[],\"unusedStacks\":0,\"unusedStacksHandStart\":0,\"userId\":\"MSLKNM\",\"userIntId\":\"MSLKNM\"},\"userInHandExtra\":{\"arjelUserHash\":\"\"}},{\"userInHand\":{\"appLoginId\":2985551872,\"bestHand\":1,\"buyInTransId\":102404005905,\"cards\":\"3h4s\",\"clientBrand\":1,\"clientDevice\":1,\"combHi\":\"4s3h\",\"combLo\":\"\",\"dbStartAmount\":1748,\"delta\":0,\"fpp\":0,\"fractionFpp\":0,\"ipAddr\":\"176.209.26.60\",\"licenseId\":0,\"position\":4,\"potChips\":0,\"result\":131077,\"startAmount\":1748,\"startingMana\":0,\"startingPowers\":[],\"unusedStacks\":0,\"unusedStacksHandStart\":0,\"userId\":\"OXMSUW\",\"userIntId\":\"OXMSUW\"},\"userInHandExtra\":{\"arjelUserHash\":\"\"}},{\"userInHand\":{\"appLoginId\":2985591028,\"bestHand\":1,\"buyInTransId\":102405333719,\"cards\":\"6c4h\",\"clientBrand\":1,\"clientDevice\":1,\"combHi\":\"6c4h\",\"combLo\":\"\",\"dbStartAmount\":2529,\"delta\":-10,\"fpp\":0,\"fractionFpp\":2,\"ipAddr\":\"89.64.54.23\",\"licenseId\":512,\"position\":5,\"potChips\":10,\"result\":20485,\"startAmount\":2529,\"startingMana\":0,\"startingPowers\":[],\"unusedStacks\":0,\"unusedStacksHandStart\":0,\"userId\":\"AZCGCH\",\"userIntId\":\"AZCGCH\"},\"userInHandExtra\":{\"arjelUserHash\":\"\"}}]}","output":"json","x":529.8984279632568,"y":158.53125095367432,"wires":[["b6c73385.6aa39"]]},{"id":"a5999f34.6691d","type":"rdkafka out","z":"d7b93f55.8b40c","name":"Kafka","topic":"","key":"","partition":-1,"broker":"c0e67585.074708","x":850.019603729248,"y":107.00390625,"wires":[]},{"id":"efac316b.05978","type":"function","z":"d7b93f55.8b40c","name":"","func":"msg.timestamp = msg.payload;\nmsg.topic = \"POKER_STARS_HANDS\";\n\nreturn msg;","outputs":1,"noerr":0,"x":354.88671875,"y":161.56640625,"wires":[["4a4a21fa.a4368"]]},{"id":"703bbbfd.76d204","type":"debug","z":"d7b93f55.8b40c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":950.8945426940918,"y":220.34765529632568,"wires":[]},{"id":"b6c73385.6aa39","type":"json","z":"d7b93f55.8b40c","name":"","property":"payload","action":"str","pretty":false,"x":697.0195274353027,"y":154.00390815734863,"wires":[["a5999f34.6691d"]]}]